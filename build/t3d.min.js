// t3d

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).t3d={})}(this,(function(t){"use strict";function e(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,(r=i.key,a=void 0,"symbol"==typeof(a=function(t,e){if("object"!=typeof t||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,e||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(r,"string"))?a:String(a)),i)}var r,a}function n(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function i(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,a(t,e)}function r(t){return r=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},r(t)}function a(t,e){return a=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},a(t,e)}function o(t,e,n){return o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}()?Reflect.construct.bind():function(t,e,n){var i=[null];i.push.apply(i,e);var r=new(Function.bind.apply(t,i));return n&&a(r,n.prototype),r},o.apply(null,arguments)}function s(t){var e="function"==typeof Map?new Map:void 0;return s=function(t){if(null===t||(n=t,-1===Function.toString.call(n).indexOf("[native code]")))return t;var n;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,i)}function i(){return o(t,arguments,r(this).constructor)}return i.prototype=Object.create(t.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),a(i,t)},s(t)}function u(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function l(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function c(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return l(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?l(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0;return function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var h=function(){function t(t,e,n,i,r){void 0===r&&(r=!0),this.target=t,this.propertyPath=e,this.name=this.target.uuid+"."+e,this.times=n,this.values=i,this.valueSize=i.length/n.length,this.interpolant=r}var e=t.prototype;return e.getValue=function(t,e){var n=this.times,i=n.length;if(t<=n[0])return this._copyValue(0,e);if(t>=n[i-1])return this._copyValue(i-1,e);for(var r=i-1;t<n[r]&&r>0;)r--;var a=(t-n[r])/(n[r+1]-n[r]);return this._interpolate(r,a,e)},e._interpolate=function(t,e,n){for(var i,r,a=this.values,o=this.valueSize,s=0;s<o;s++)i=a[t*o+s],r=a[(t+1)*o+s],this.interpolant?n[s]=void 0!==i&&void 0!==r?i*(1-e)+r*e:i:n[s]=i;return n},e._copyValue=function(t,e){for(var n=this.values,i=this.valueSize,r=i*t,a=0;a<i;a++)e[a]=n[r+a];return e},t}(),d=function(t){function e(e,n,i,r,a){return t.call(this,e,n,i,r,a)||this}return i(e,t),e.prototype._interpolate=function(t,e,n){return n[0]=this.values[t],n},e}(h);d.prototype.valueTypeName="bool";var f=function(t){function e(e,n,i,r,a){return t.call(this,e,n,i,r,a)||this}return i(e,t),e}(h);f.prototype.valueTypeName="color";var p=function(t){function e(e,n,i,r,a){return t.call(this,e,n,i,r,a)||this}return i(e,t),e}(h);p.prototype.valueTypeName="number";var _=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.x=t,this.y=e,this.z=n}var e=t.prototype;return e.lerpVectors=function(t,e,n){return this.subVectors(e,t).multiplyScalar(n).add(t)},e.set=function(t,e,n){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.x=t,this.y=e,this.z=n,this},e.min=function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this},e.max=function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this},e.getLength=function(){return Math.sqrt(this.getLengthSquared())},e.getLengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z},e.normalize=function(t){void 0===t&&(t=1);var e=t/(this.getLength()||1);return this.x*=e,this.y*=e,this.z*=e,this},e.subtract=function(e,n){return void 0===n&&(n=new t),n.set(this.x-e.x,this.y-e.y,this.z-e.z)},e.multiply=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},e.crossVectors=function(t,e){var n=t.x,i=t.y,r=t.z,a=e.x,o=e.y,s=e.z;return this.x=i*s-r*o,this.y=r*a-n*s,this.z=n*o-i*a,this},e.cross=function(t){return this.crossVectors(this,t)},e.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},e.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},e.applyQuaternion=function(t){var e=this.x,n=this.y,i=this.z,r=t._x,a=t._y,o=t._z,s=t._w,u=s*e+a*i-o*n,l=s*n+o*e-r*i,c=s*i+r*n-a*e,h=-r*e-a*n-o*i;return this.x=u*s+h*-r+l*-o-c*-a,this.y=l*s+h*-a+c*-r-u*-o,this.z=c*s+h*-o+u*-a-l*-r,this},e.applyMatrix4=function(t){var e=this.x,n=this.y,i=this.z,r=t.elements,a=1/(r[3]*e+r[7]*n+r[11]*i+r[15]);return this.x=(r[0]*e+r[4]*n+r[8]*i+r[12])*a,this.y=(r[1]*e+r[5]*n+r[9]*i+r[13])*a,this.z=(r[2]*e+r[6]*n+r[10]*i+r[14])*a,this},e.applyMatrix3=function(t){var e=this.x,n=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[3]*n+r[6]*i,this.y=r[1]*e+r[4]*n+r[7]*i,this.z=r[2]*e+r[5]*n+r[8]*i,this},e.transformDirection=function(t){var e=this.x,n=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[4]*n+r[8]*i,this.y=r[1]*e+r[5]*n+r[9]*i,this.z=r[2]*e+r[6]*n+r[10]*i,this.normalize()},e.setFromMatrixPosition=function(t){return this.setFromMatrixColumn(t,3)},e.setFromMatrixColumn=function(t,e){return this.fromArray(t.elements,4*e)},e.fromArray=function(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this},e.toArray=function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t},e.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},e.addVectors=function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this},e.addScalar=function(t){return this.x+=t,this.y+=t,this.z+=t,this},e.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},e.addScaledVector=function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this},e.subVectors=function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this},e.sub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},e.multiplyScalar=function(t){return this.x*=t,this.y*=t,this.z*=t,this},e.distanceToSquared=function(t){var e=this.x-t.x,n=this.y-t.y,i=this.z-t.z;return e*e+n*n+i*i},e.distanceTo=function(t){return Math.sqrt(this.distanceToSquared(t))},e.setFromSpherical=function(t){var e=Math.sin(t.phi)*t.radius;return this.x=e*Math.sin(t.theta),this.y=Math.cos(t.phi)*t.radius,this.z=e*Math.cos(t.theta),this},e.project=function(t){return this.applyMatrix4(t.projectionViewMatrix)},e.unproject=function(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.worldMatrix)},e.reflect=function(t){return this.sub(v.copy(t).multiplyScalar(2*this.dot(t)))},e.equals=function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},e.clone=function(){return new t(this.x,this.y,this.z)},t}(),v=new _,m=function(){function t(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}var e=t.prototype;return e.identity=function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},e.isIdentity=function(){var t=this.elements;return 1===t[0]&&0===t[4]&&0===t[8]&&0===t[12]&&0===t[1]&&1===t[5]&&0===t[9]&&0===t[13]&&0===t[2]&&0===t[6]&&1===t[10]&&0===t[14]&&0===t[3]&&0===t[7]&&0===t[11]&&1===t[15]},e.set=function(t,e,n,i,r,a,o,s,u,l,c,h,d,f,p,_){var v=this.elements;return v[0]=t,v[4]=e,v[8]=n,v[12]=i,v[1]=r,v[5]=a,v[9]=o,v[13]=s,v[2]=u,v[6]=l,v[10]=c,v[14]=h,v[3]=d,v[7]=f,v[11]=p,v[15]=_,this},e.clone=function(){return(new t).fromArray(this.elements)},e.copy=function(t){var e=this.elements,n=t.elements;return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e[9]=n[9],e[10]=n[10],e[11]=n[11],e[12]=n[12],e[13]=n[13],e[14]=n[14],e[15]=n[15],this},e.makeTranslation=function(t,e,n){return this.set(1,0,0,t,0,1,0,e,0,0,1,n,0,0,0,1)},e.multiply=function(t){return this.multiplyMatrices(this,t)},e.premultiply=function(t){return this.multiplyMatrices(t,this)},e.multiplyMatrices=function(t,e){var n=t.elements,i=e.elements,r=this.elements,a=n[0],o=n[4],s=n[8],u=n[12],l=n[1],c=n[5],h=n[9],d=n[13],f=n[2],p=n[6],_=n[10],v=n[14],m=n[3],g=n[7],E=n[11],S=n[15],M=i[0],T=i[4],y=i[8],x=i[12],w=i[1],A=i[5],b=i[9],R=i[13],N=i[2],P=i[6],L=i[10],C=i[14],D=i[3],O=i[7],F=i[11],I=i[15];return r[0]=a*M+o*w+s*N+u*D,r[4]=a*T+o*A+s*P+u*O,r[8]=a*y+o*b+s*L+u*F,r[12]=a*x+o*R+s*C+u*I,r[1]=l*M+c*w+h*N+d*D,r[5]=l*T+c*A+h*P+d*O,r[9]=l*y+c*b+h*L+d*F,r[13]=l*x+c*R+h*C+d*I,r[2]=f*M+p*w+_*N+v*D,r[6]=f*T+p*A+_*P+v*O,r[10]=f*y+p*b+_*L+v*F,r[14]=f*x+p*R+_*C+v*I,r[3]=m*M+g*w+E*N+S*D,r[7]=m*T+g*A+E*P+S*O,r[11]=m*y+g*b+E*L+S*F,r[15]=m*x+g*R+E*C+S*I,this},e.transpose=function(){var t,e=this.elements;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},e.inverse=function(){return this.getInverse(this)},e.getInverse=function(t){var e=this.elements,n=t.elements,i=n[0],r=n[1],a=n[2],o=n[3],s=n[4],u=n[5],l=n[6],c=n[7],h=n[8],d=n[9],f=n[10],p=n[11],_=n[12],v=n[13],m=n[14],g=n[15],E=d*m*c-v*f*c+v*l*p-u*m*p-d*l*g+u*f*g,S=_*f*c-h*m*c-_*l*p+s*m*p+h*l*g-s*f*g,M=h*v*c-_*d*c+_*u*p-s*v*p-h*u*g+s*d*g,T=_*d*l-h*v*l-_*u*f+s*v*f+h*u*m-s*d*m,y=i*E+r*S+a*M+o*T;if(0===y)return console.warn("Matrix4: can not invert matrix, determinant is 0"),this.identity();var x=1/y;return e[0]=E*x,e[1]=(v*f*o-d*m*o-v*a*p+r*m*p+d*a*g-r*f*g)*x,e[2]=(u*m*o-v*l*o+v*a*c-r*m*c-u*a*g+r*l*g)*x,e[3]=(d*l*o-u*f*o-d*a*c+r*f*c+u*a*p-r*l*p)*x,e[4]=S*x,e[5]=(h*m*o-_*f*o+_*a*p-i*m*p-h*a*g+i*f*g)*x,e[6]=(_*l*o-s*m*o-_*a*c+i*m*c+s*a*g-i*l*g)*x,e[7]=(s*f*o-h*l*o+h*a*c-i*f*c-s*a*p+i*l*p)*x,e[8]=M*x,e[9]=(_*d*o-h*v*o-_*r*p+i*v*p+h*r*g-i*d*g)*x,e[10]=(s*v*o-_*u*o+_*r*c-i*v*c-s*r*g+i*u*g)*x,e[11]=(h*u*o-s*d*o-h*r*c+i*d*c+s*r*p-i*u*p)*x,e[12]=T*x,e[13]=(h*v*a-_*d*a+_*r*f-i*v*f-h*r*m+i*d*m)*x,e[14]=(_*u*a-s*v*a-_*r*l+i*v*l+s*r*m-i*u*m)*x,e[15]=(s*d*a-h*u*a+h*r*l-i*d*l-s*r*f+i*u*f)*x,this},e.transform=function(t,e,n){var i=this.elements,r=n._x,a=n._y,o=n._z,s=n._w,u=r+r,l=a+a,c=o+o,h=r*u,d=r*l,f=r*c,p=a*l,_=a*c,v=o*c,m=s*u,g=s*l,E=s*c,S=e.x,M=e.y,T=e.z;return i[0]=(1-(p+v))*S,i[1]=(d+E)*S,i[2]=(f-g)*S,i[3]=0,i[4]=(d-E)*M,i[5]=(1-(h+v))*M,i[6]=(_+m)*M,i[7]=0,i[8]=(f+g)*T,i[9]=(_-m)*T,i[10]=(1-(h+p))*T,i[11]=0,i[12]=t.x,i[13]=t.y,i[14]=t.z,i[15]=1,this},e.makeRotationFromQuaternion=function(t){var e=this.elements,n=t.x,i=t.y,r=t.z,a=t.w,o=n+n,s=i+i,u=r+r,l=n*o,c=n*s,h=n*u,d=i*s,f=i*u,p=r*u,_=a*o,v=a*s,m=a*u;return e[0]=1-(d+p),e[4]=c-m,e[8]=h+v,e[1]=c+m,e[5]=1-(l+p),e[9]=f-_,e[2]=h-v,e[6]=f+_,e[10]=1-(l+d),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},e.extractRotation=function(t){var e=this.elements,n=t.elements,i=1/g.setFromMatrixColumn(t,0).getLength(),r=1/g.setFromMatrixColumn(t,1).getLength(),a=1/g.setFromMatrixColumn(t,2).getLength();return e[0]=n[0]*i,e[1]=n[1]*i,e[2]=n[2]*i,e[3]=0,e[4]=n[4]*r,e[5]=n[5]*r,e[6]=n[6]*r,e[7]=0,e[8]=n[8]*a,e[9]=n[9]*a,e[10]=n[10]*a,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},e.lookAtRH=function(t,e,n){var i=this.elements;return T.subVectors(t,e),0===T.getLengthSquared()&&(T.z=1),T.normalize(),S.crossVectors(n,T),0===S.getLengthSquared()&&(1===Math.abs(n.z)?T.x+=1e-4:T.z+=1e-4,T.normalize(),S.crossVectors(n,T)),S.normalize(),M.crossVectors(T,S),i[0]=S.x,i[4]=M.x,i[8]=T.x,i[1]=S.y,i[5]=M.y,i[9]=T.y,i[2]=S.z,i[6]=M.z,i[10]=T.z,this},e.decompose=function(t,e,n){var i=this.elements,r=g.set(i[0],i[1],i[2]).getLength(),a=g.set(i[4],i[5],i[6]).getLength(),o=g.set(i[8],i[9],i[10]).getLength();this.determinant()<0&&(r=-r),t.x=i[12],t.y=i[13],t.z=i[14],E.copy(this);var s=1/r,u=1/a,l=1/o;return E.elements[0]*=s,E.elements[1]*=s,E.elements[2]*=s,E.elements[4]*=u,E.elements[5]*=u,E.elements[6]*=u,E.elements[8]*=l,E.elements[9]*=l,E.elements[10]*=l,e.setFromRotationMatrix(E),n.x=r,n.y=a,n.z=o,this},e.determinant=function(){var t=this.elements,e=t[0],n=t[4],i=t[8],r=t[12],a=t[1],o=t[5],s=t[9],u=t[13],l=t[2],c=t[6],h=t[10],d=t[14];return t[3]*(+r*s*c-i*u*c-r*o*h+n*u*h+i*o*d-n*s*d)+t[7]*(+e*s*d-e*u*h+r*a*h-i*a*d+i*u*l-r*s*l)+t[11]*(+e*u*c-e*o*d-r*a*c+n*a*d+r*o*l-n*u*l)+t[15]*(-i*o*l-e*s*c+e*o*h+i*a*c-n*a*h+n*s*l)},e.fromArray=function(t,e){void 0===e&&(e=0);for(var n=0;n<16;n++)this.elements[n]=t[n+e];return this},e.getMaxScaleOnAxis=function(){var t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],n=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],i=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,n,i))},e.makeRotationAxis=function(t,e){var n=Math.cos(e),i=Math.sin(e),r=1-n,a=t.x,o=t.y,s=t.z,u=r*a,l=r*o;return this.set(u*a+n,u*o-i*s,u*s+i*o,0,u*o+i*s,l*o+n,l*s-i*a,0,u*s-i*o,l*s+i*a,r*s*s+n,0,0,0,0,1)},e.equals=function(t){for(var e=this.elements,n=t.elements,i=0;i<16;i++)if(e[i]!==n[i])return!1;return!0},e.toArray=function(t,e){void 0===t&&(t=[]),void 0===e&&(e=0);var n=this.elements;return t[e]=n[0],t[e+1]=n[1],t[e+2]=n[2],t[e+3]=n[3],t[e+4]=n[4],t[e+5]=n[5],t[e+6]=n[6],t[e+7]=n[7],t[e+8]=n[8],t[e+9]=n[9],t[e+10]=n[10],t[e+11]=n[11],t[e+12]=n[12],t[e+13]=n[13],t[e+14]=n[14],t[e+15]=n[15],t},t}(),g=new _,E=new m,S=new _,M=new _,T=new _,y=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),this._x=t,this._y=e,this._z=n,this._w=i}t.slerpFlat=function(t,e,n,i,r,a,o){var s=n[i+0],u=n[i+1],l=n[i+2],c=n[i+3],h=r[a+0],d=r[a+1],f=r[a+2],p=r[a+3];if(0===o)return t[e]=s,t[e+1]=u,t[e+2]=l,void(t[e+3]=c);if(1===o)return t[e]=h,t[e+1]=d,t[e+2]=f,void(t[e+3]=p);if(c!==p||s!==h||u!==d||l!==f){var _=1-o,v=s*h+u*d+l*f+c*p,m=v>=0?1:-1,g=1-v*v;if(g>Number.EPSILON){var E=Math.sqrt(g),S=Math.atan2(E,v*m);_=Math.sin(_*S)/E,o=Math.sin(o*S)/E}var M=o*m;if(s=s*_+h*M,u=u*_+d*M,l=l*_+f*M,c=c*_+p*M,_===1-o){var T=1/Math.sqrt(s*s+u*u+l*l+c*c);s*=T,u*=T,l*=T,c*=T}}t[e]=s,t[e+1]=u,t[e+2]=l,t[e+3]=c},t.multiplyQuaternionsFlat=function(t,e,n,i,r,a){var o=n[i],s=n[i+1],u=n[i+2],l=n[i+3],c=r[a],h=r[a+1],d=r[a+2],f=r[a+3];return t[e]=o*f+l*c+s*d-u*h,t[e+1]=s*f+l*h+u*c-o*d,t[e+2]=u*f+l*d+o*h-s*c,t[e+3]=l*f-o*c-s*h-u*d,t};var e=t.prototype;return e.normalize=function(){var t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this.onChangeCallback(),this},e.length=function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},e.lerpQuaternions=function(t,e,n){if(0===n)return this.copy(t);if(1===n)return this.copy(e);var i=t._w,r=t._x,a=t._y,o=t._z,s=e._w,u=e._x,l=e._y,c=e._z;i*s+r*u+a*l+o*c<0&&(s=-s,u=-u,l=-l,c=-c),this._w=i+n*(s-i),this._x=r+n*(u-r),this._y=a+n*(l-a),this._z=o+n*(c-o);var h=1/Math.sqrt(this._w*this._w+this._x*this._x+this._y*this._y+this._z*this._z);return this._w*=h,this._x*=h,this._y*=h,this._z*=h,this.onChangeCallback(),this},e.slerpQuaternions=function(t,e,n){if(0===n)return this.copy(t);if(1===n)return this.copy(e);var i=t._w,r=t._x,a=t._y,o=t._z,s=e._w,u=e._x,l=e._y,c=e._z,h=i*s+r*u+a*l+o*c;if(h<0&&(h=-h,s=-s,u=-u,l=-l,c=-c),h<.95){var d=Math.acos(h),f=1/Math.sin(d),p=Math.sin(d*(1-n))*f,_=Math.sin(d*n)*f;this._w=i*p+s*_,this._x=r*p+u*_,this._y=a*p+l*_,this._z=o*p+c*_}else{this._w=i+n*(s-i),this._x=r+n*(u-r),this._y=a+n*(l-a),this._z=o+n*(c-o);var v=1/Math.sqrt(this._w*this._w+this._x*this._x+this._y*this._y+this._z*this._z);this._w*=v,this._x*=v,this._y*=v,this._z*=v}return this.onChangeCallback(),this},e.set=function(t,e,n,i){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),this._x=t,this._y=e,this._z=n,this._w=i,this.onChangeCallback(),this},e.clone=function(){return new t(this._x,this._y,this._z,this._w)},e.copy=function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=void 0!==t.w?t.w:1,this.onChangeCallback(),this},e.setFromEuler=function(t,e){void 0===e&&(e=!0);var n=Math.cos(t._x/2),i=Math.cos(t._y/2),r=Math.cos(t._z/2),a=Math.sin(t._x/2),o=Math.sin(t._y/2),s=Math.sin(t._z/2),u=t._order;return"XYZ"===u?(this._x=a*i*r+n*o*s,this._y=n*o*r-a*i*s,this._z=n*i*s+a*o*r,this._w=n*i*r-a*o*s):"YXZ"===u?(this._x=a*i*r+n*o*s,this._y=n*o*r-a*i*s,this._z=n*i*s-a*o*r,this._w=n*i*r+a*o*s):"ZXY"===u?(this._x=a*i*r-n*o*s,this._y=n*o*r+a*i*s,this._z=n*i*s+a*o*r,this._w=n*i*r-a*o*s):"ZYX"===u?(this._x=a*i*r-n*o*s,this._y=n*o*r+a*i*s,this._z=n*i*s-a*o*r,this._w=n*i*r+a*o*s):"YZX"===u?(this._x=a*i*r+n*o*s,this._y=n*o*r+a*i*s,this._z=n*i*s-a*o*r,this._w=n*i*r-a*o*s):"XZY"===u&&(this._x=a*i*r-n*o*s,this._y=n*o*r-a*i*s,this._z=n*i*s+a*o*r,this._w=n*i*r+a*o*s),!0===e&&this.onChangeCallback(),this},e.setFromRotationMatrix=function(t){var e,n=t.elements,i=n[0],r=n[4],a=n[8],o=n[1],s=n[5],u=n[9],l=n[2],c=n[6],h=n[10],d=i+s+h;return d>0?(e=.5/Math.sqrt(d+1),this._w=.25/e,this._x=(c-u)*e,this._y=(a-l)*e,this._z=(o-r)*e):i>s&&i>h?(e=2*Math.sqrt(1+i-s-h),this._w=(c-u)/e,this._x=.25*e,this._y=(r+o)/e,this._z=(a+l)/e):s>h?(e=2*Math.sqrt(1+s-i-h),this._w=(a-l)/e,this._x=(r+o)/e,this._y=.25*e,this._z=(u+c)/e):(e=2*Math.sqrt(1+h-i-s),this._w=(o-r)/e,this._x=(a+l)/e,this._y=(u+c)/e,this._z=.25*e),this.onChangeCallback(),this},e.setFromUnitVectors=function(t,e){var n=t.dot(e)+1;return n<Number.EPSILON?(n=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=n):(this._x=0,this._y=-t.z,this._z=t.y,this._w=n)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=n),this.normalize()},e.multiply=function(t){return this.multiplyQuaternions(this,t)},e.premultiply=function(t){return this.multiplyQuaternions(t,this)},e.multiplyQuaternions=function(t,e){var n=t._x,i=t._y,r=t._z,a=t._w,o=e._x,s=e._y,u=e._z,l=e._w;return this._x=n*l+a*o+i*u-r*s,this._y=i*l+a*s+r*o-n*u,this._z=r*l+a*u+n*s-i*o,this._w=a*l-n*o-i*s-r*u,this.onChangeCallback(),this},e.toMatrix4=function(t){void 0===t&&(t=new m);var e=t.elements,n=2*this._x*this._y,i=2*this._x*this._z,r=2*this._x*this._w,a=2*this._y*this._z,o=2*this._y*this._w,s=2*this._z*this._w,u=this._x*this._x,l=this._y*this._y,c=this._z*this._z,h=this._w*this._w;return e[0]=u-l-c+h,e[4]=n-s,e[8]=i+o,e[12]=0,e[1]=n+s,e[5]=-u+l-c+h,e[9]=a-r,e[13]=0,e[2]=i-o,e[6]=a+r,e[10]=-u-l+c+h,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1,t},e.conjugate=function(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this},e.dot=function(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w},e.setFromAxisAngle=function(t,e){var n=e/2,i=Math.sin(n);return this._x=t.x*i,this._y=t.y*i,this._z=t.z*i,this._w=Math.cos(n),this.onChangeCallback(),this},e.fromArray=function(t,e){return void 0===e&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this.onChangeCallback(),this},e.toArray=function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t},e.onChange=function(t){return this.onChangeCallback=t,this},e.onChangeCallback=function(){},n(t,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this.onChangeCallback()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this.onChangeCallback()}},{key:"z",get:function(){return this._z},set:function(t){this._z=t,this.onChangeCallback()}},{key:"w",get:function(){return this._w},set:function(t){this._w=t,this.onChangeCallback()}}]),t}(),x=function(t){function e(e,n,i,r,a){return t.call(this,e,n,i,r,a)||this}return i(e,t),e.prototype._interpolate=function(t,e,n){var i=this.values;return this.interpolant?y.slerpFlat(n,0,i,4*t,i,4*(t+1),e):this._copyValue(t,n),n},e}(h);x.prototype.valueTypeName="quaternion";var w=function(t){function e(e,n,i,r,a){return t.call(this,e,n,i,r,a)||this}return i(e,t),e.prototype._interpolate=function(t,e,n){return n[0]=this.values[t],n},e}(h);w.prototype.valueTypeName="string";var A=function(t){function e(e,n,i,r,a){return t.call(this,e,n,i,r,a)||this}return i(e,t),e}(h);A.prototype.valueTypeName="vector";var b={BASIC:"basic",LAMBERT:"lambert",PHONG:"phong",PBR:"pbr",PBR2:"pbr2",MATCAP:"matcap",POINT:"point",LINE:"line",SHADER:"shader",DEPTH:"depth",DISTANCE:"distance"},R={NONE:"none",NORMAL:"normal",ADD:"add",SUB:"sub",MUL:"mul",CUSTOM:"custom"},N={ADD:100,SUBTRACT:101,REVERSE_SUBTRACT:102},P={ZERO:200,ONE:201,SRC_COLOR:202,SRC_ALPHA:203,SRC_ALPHA_SATURATE:204,DST_COLOR:205,DST_ALPHA:206,ONE_MINUS_SRC_COLOR:207,ONE_MINUS_SRC_ALPHA:208,ONE_MINUS_DST_COLOR:209,ONE_MINUS_DST_ALPHA:210},L={NONE:"none",FRONT:"front",BACK:"back",FRONT_AND_BACK:"front_and_back"},C={FRONT:"front",BACK:"back",DOUBLE:"double"},D={SMOOTH_SHADING:"smooth_shading",FLAT_SHADING:"flat_shading"},O={DEPTH_COMPONENT:1e3,DEPTH_STENCIL:1001,STENCIL_INDEX8:1002,ALPHA:1003,RED:1004,RGB:1005,RGBA:1006,LUMINANCE:1007,LUMINANCE_ALPHA:1008,RED_INTEGER:1010,RG:1011,RG_INTEGER:1012,RGB_INTEGER:1013,RGBA_INTEGER:1014,R32F:1100,R16F:1101,R8:1102,RG32F:1103,RG16F:1104,RG8:1105,RGB32F:1106,RGB16F:1107,RGB8:1108,RGBA32F:1109,RGBA16F:1110,RGBA8:1111,RGBA4:1112,RGB5_A1:1113,DEPTH_COMPONENT32F:1114,DEPTH_COMPONENT24:1115,DEPTH_COMPONENT16:1116,DEPTH24_STENCIL8:1117,DEPTH32F_STENCIL8:1118,RGB_S3TC_DXT1:1200,RGBA_S3TC_DXT1:1201,RGBA_S3TC_DXT3:1202,RGBA_S3TC_DXT5:1203,RGB_PVRTC_4BPPV1:1204,RGB_PVRTC_2BPPV1:1205,RGBA_PVRTC_4BPPV1:1206,RGBA_PVRTC_2BPPV1:1207,RGB_ETC1:1208,RGBA_ASTC_4x4:1209,RGBA_BPTC:1210},F={UNSIGNED_BYTE:1500,UNSIGNED_SHORT_5_6_5:1501,UNSIGNED_SHORT_4_4_4_4:1502,UNSIGNED_SHORT_5_5_5_1:1503,UNSIGNED_SHORT:1504,UNSIGNED_INT:1505,UNSIGNED_INT_24_8:1506,FLOAT:1507,HALF_FLOAT:1508,FLOAT_32_UNSIGNED_INT_24_8_REV:1509,BYTE:1510,SHORT:1511,INT:1512},I={NEAREST:1600,LINEAR:1601,NEAREST_MIPMAP_NEAREST:1602,LINEAR_MIPMAP_NEAREST:1603,NEAREST_MIPMAP_LINEAR:1604,LINEAR_MIPMAP_LINEAR:1605},U={REPEAT:1700,CLAMP_TO_EDGE:1701,MIRRORED_REPEAT:1702},B={LEQUAL:515,GEQUAL:518,LESS:513,GREATER:516,EQUAL:514,NOTEQUAL:517,ALWAYS:519,NEVER:512},G={KEEP:7680,REPLACE:7681,INCR:7682,DECR:7683,INVERT:5386,INCR_WRAP:34055,DECR_WRAP:34056},z={HARD:"hard",POISSON_SOFT:"poisson_soft",PCF3_SOFT:"pcf3_soft",PCF5_SOFT:"pcf5_soft",PCSS16_SOFT:"pcss16_soft",PCSS32_SOFT:"pcss32_soft",PCSS64_SOFT:"pcss64_soft"},H={LINEAR:"linear",SRGB:"sRGB",RGBE:"RGBE",RGBM7:"RGBM7",RGBM16:"RGBM16",RGBD:"RGBD",GAMMA:"Gamma"},V={MULTIPLY:"ENVMAP_BLENDING_MULTIPLY",MIX:"ENVMAP_BLENDING_MIX",ADD:"ENVMAP_BLENDING_ADD"},k={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},X={NONE:0,RGB:1,RGBA:2},W={COLOR_ATTACHMENT0:2e3,COLOR_ATTACHMENT1:2001,COLOR_ATTACHMENT2:2002,COLOR_ATTACHMENT3:2003,COLOR_ATTACHMENT4:2004,COLOR_ATTACHMENT5:2005,COLOR_ATTACHMENT6:2006,COLOR_ATTACHMENT7:2007,COLOR_ATTACHMENT8:2008,COLOR_ATTACHMENT9:2009,COLOR_ATTACHMENT10:2010,COLOR_ATTACHMENT11:2011,COLOR_ATTACHMENT12:2012,COLOR_ATTACHMENT13:2013,COLOR_ATTACHMENT14:2014,COLOR_ATTACHMENT15:2015,DEPTH_ATTACHMENT:2020,STENCIL_ATTACHMENT:2021,DEPTH_STENCIL_ATTACHMENT:2030},j={STREAM_DRAW:35040,STREAM_READ:35041,STREAM_COPY:35042,STATIC_DRAW:35044,STATIC_READ:35045,STATIC_COPY:35046,DYNAMIC_DRAW:35048,DYNAMIC_READ:35049,DYNAMIC_COPY:35050},Y={ANY_SAMPLES_PASSED:7e3,ANY_SAMPLES_PASSED_CONSERVATIVE:7001,TIME_ELAPSED:7002},q=function(){function t(){}var e=t.prototype;return e.addEventListener=function(t,e,n){void 0===this._eventMap&&(this._eventMap={});var i=this._eventMap;void 0===i[t]&&(i[t]=[]),i[t].push({listener:e,thisObject:n||this})},e.removeEventListener=function(t,e,n){if(void 0!==this._eventMap){var i=this._eventMap[t];if(void 0!==i)for(var r=0,a=i.length;r<a;r++){var o=i[r];if(o.listener===e&&o.thisObject===(n||this)){i.splice(r,1);break}}}},e.dispatchEvent=function(t){if(void 0!==this._eventMap){var e=this._eventMap[t.type];if(void 0!==e){t.target=this;for(var n=e.slice(0),i=0,r=n.length;i<r;i++){var a=n[i];a.listener.call(a.thisObject,t)}t.target=null}}},t}(),Q=function(t){function e(e){var n;return(n=t.call(this)||this).clip=e,n.weight=0,n.time=0,n.blendMode=R.NORMAL,n}return i(e,t),e.prototype.update=function(t){this.time+=t;var e=this.clip.duration;this.time>e&&(this.time=this.time%e),this.time<0&&(this.time=this.time%e+e)},e}(q),Z=function(){function t(t,e,n,i){this.target=null,this.property="",this.parseBinding(t,e),this.valueSize=i;var r,a,o,s=Float64Array;switch(n){case"quaternion":r=J,a=tt,o=rt;break;case"string":case"bool":s=Array,r=K,a=K,o=at;break;default:r=et,a=nt,o=it}this.buffer=new s(4*i),this._mixBufferFunction=r,this._mixBufferFunctionAdditive=a,this._setIdentity=o,this.cumulativeWeight=0,this.cumulativeWeightAdditive=0}var e=t.prototype;return e.parseBinding=function(t,e){if((e=e.split(".")).length>1){for(var n=t[e[0]],i=1;i<e.length-1;i++)n=n[e[i]];this.property=e[e.length-1],this.target=n}else this.property=e[0],this.target=t},e.saveOriginalState=function(){var t=this.buffer,e=this.valueSize,n=2*e;this.valueSize>1?this.target[this.property].toArray?this.target[this.property].toArray(t,n):function(t,e,n,i){for(var r=0;r<i;r++)t[n+r]=e[r]}(t,this.target[this.property],n,this.valueSize):this.target[this.property]=t[n];for(var i=e,r=n;i!==r;++i)t[i]=t[n+i%e];this._setIdentity(t,3*e,e,n),this.cumulativeWeight=0,this.cumulativeWeightAdditive=0},e.restoreOriginalState=function(){for(var t=this.buffer,e=this.valueSize,n=2*e,i=e,r=n;i!==r;++i)t[i]=t[n+i%e];this.apply()},e.accumulate=function(t){var e=this.buffer,n=this.valueSize,i=n,r=this.cumulativeWeight;if(0===r){for(var a=0;a!==n;++a)e[i+a]=e[a];r=t}else{var o=t/(r+=t);this._mixBufferFunction(e,i,0,o,n)}this.cumulativeWeight=r},e.accumulateAdditive=function(t){var e=this.buffer,n=this.valueSize,i=3*n;0===this.cumulativeWeightAdditive&&this._setIdentity(e,i,n,2*n),this._mixBufferFunctionAdditive(e,i,0,t,n),this.cumulativeWeightAdditive+=t},e.apply=function(){var t=this.buffer,e=this.valueSize,n=this.cumulativeWeight,i=this.cumulativeWeightAdditive;if(this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,n<1){var r=2*e;this._mixBufferFunction(t,e,r,1-n,e)}i>0&&this._mixBufferFunctionAdditive(t,e,3*e,1,e),this.valueSize>1?this.target[this.property].fromArray?this.target[this.property].fromArray(t,e):function(t,e,n,i){for(var r=0;r<i;r++)t[r]=e[n+r]}(this.target[this.property],t,e,this.valueSize):this.target[this.property]=t[e]},t}();function K(t,e,n,i,r){if(i>=.5)for(var a=0;a!==r;++a)t[e+a]=t[n+a]}function J(t,e,n,i){y.slerpFlat(t,e,t,e,t,n,i)}var $=new Float64Array(4);function tt(t,e,n,i){y.multiplyQuaternionsFlat($,0,t,e,t,n),y.slerpFlat(t,e,t,e,$,0,i)}function et(t,e,n,i,r){for(var a=1-i,o=0;o!==r;++o){var s=e+o;t[s]=t[s]*a+t[n+o]*i}}function nt(t,e,n,i,r){for(var a=0;a!==r;++a){var o=e+a;t[o]=t[o]+t[n+a]*i}}function it(t,e,n){for(var i=0;i<n;i++)t[e+i]=0}function rt(t,e){it(t,e,3),t[e+3]=1}function at(t,e,n,i){for(var r=0;r<n;r++)t[e+r]=t[i+r]}var ot=function(){function t(){this._actions=[],this._bindings={}}var e=t.prototype;return e.addAction=function(t){if(-1===this._actions.indexOf(t)){this._actions.push(t);for(var e=t.clip.tracks,n=0;n<e.length;n++){var i=e[n],r=i.name;if(!this._bindings[r]){var a=new Z(i.target,i.propertyPath,i.valueTypeName,i.valueSize);this._bindings[r]={binding:a,referenceCount:0,active:!1,cachedActive:!1}}this._bindings[r].referenceCount++}}else console.warn("AnimationMixer.addAction(): already has the action, clip name is <"+t.clip.name+">.")},e.removeAction=function(t){var e=this._actions.indexOf(t);if(-1!==e)if(t.weight>0)console.warn("AnimationMixer.removeAction(): make sure action's weight is zero before removing it.");else{this._actions.splice(e,1);for(var n=clip.tracks,i=0;i<n.length;i++){var r=n[i].name,a=this._bindings[r];a&&--a.referenceCount<=0&&(a.cachedActive&&a.binding.restoreOriginalState(),delete this._bindings[r])}}else console.warn("AnimationMixer.removeAction(): action not found in this mixer, clip name is <"+t.clip.name+">.")},e.hasAction=function(t){return this._actions.indexOf(t)>-1},e.getActions=function(){return this._actions},e.update=function(t){for(var e in this._bindings)this._bindings[e].active=!1;for(var n=0,i=this._actions.length;n<i;n++){var r=this._actions[n];if(r.weight>0){r.update(t);for(var a=r.clip.tracks,o=0,s=a.length;o<s;o++){var u=a[o],l=this._bindings[u.name],c=l.binding;l.active=!0,l.cachedActive||(l.binding.saveOriginalState(),l.cachedActive=!0),u.getValue(r.time,c.buffer),r.blendMode===R.ADD?c.accumulateAdditive(r.weight):c.accumulate(r.weight)}}}for(var h in this._bindings){var d=this._bindings[h];d.active?d.binding.apply():d.cachedActive&&(d.binding.restoreOriginalState(),d.cachedActive=!1)}},t}(),st=function(){function t(t,e,n){void 0===n&&(n=-1),this.name=t,this.tracks=e,this.duration=n,this.duration<0&&this.resetDuration()}return t.prototype.resetDuration=function(){for(var t=this.tracks,e=0,n=0,i=t.length;n<i;n++){var r=t[n];e=Math.max(e,r.times[r.times.length-1])}return this.duration=e,this},t}(),ut=function(){function t(t,e,n){this.isLoading=!1,this.itemsLoaded=0,this.itemsTotal=0,this.urlModifier=void 0,this.onStart=void 0,this.onLoad=t,this.onProgress=e,this.onError=n}var e=t.prototype;return e.itemStart=function(t){this.itemsTotal++,!1===this.isLoading&&void 0!==this.onStart&&this.onStart(t,this.itemsLoaded,this.itemsTotal),this.isLoading=!0},e.itemEnd=function(t){this.itemsLoaded++,void 0!==this.onProgress&&this.onProgress(t,this.itemsLoaded,this.itemsTotal),this.itemsLoaded===this.itemsTotal&&(this.isLoading=!1,void 0!==this.onLoad&&this.onLoad())},e.itemError=function(t){void 0!==this.onError&&this.onError(t)},e.resolveURL=function(t){return this.urlModifier?this.urlModifier(t):t},e.setURLModifier=function(t){return this.urlModifier=t,this},t}(),lt=new ut,ct=function(){function t(t){this.manager=void 0!==t?t:lt,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.requestHeader={}}var e=t.prototype;return e.load=function(){},e.loadAsync=function(t,e){var n=this;return new Promise((function(i,r){n.load(t,i,e,r)}))},e.setCrossOrigin=function(t){return this.crossOrigin=t,this},e.setWithCredentials=function(t){return this.withCredentials=t,this},e.setPath=function(t){return this.path=t,this},e.setRequestHeader=function(t){return this.requestHeader=t,this},t}(),ht=function(t){function e(e){var n;return(n=t.call(this,e)||this).responseType=void 0,n.mimeType=void 0,n}i(e,t);var n=e.prototype;return n.load=function(t,e,n,i){var r=this;void 0===t&&(t=""),null!=this.path&&(t=this.path+t),t=this.manager.resolveURL(t);var a=new Request(t,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"}),o=this.mimeType,s=this.responseType;fetch(a).then((function(t){if(200===t.status||0===t.status){if(0===t.status&&console.warn("t3d.FileLoader: HTTP Status 0 received."),"undefined"==typeof ReadableStream||void 0===t.body||void 0===t.body.getReader)return t;var e=t.body.getReader(),i=t.headers.get("Content-Length"),r=i?parseInt(i):0,a=0!==r,o=0,s=new ReadableStream({start:function(t){!function i(){e.read().then((function(e){var s=e.done,u=e.value;if(s)t.close();else{o+=u.byteLength;var l=new ProgressEvent("progress",{lengthComputable:a,loaded:o,total:r});void 0!==n&&n(l),t.enqueue(u),i()}}))}()}});return new Response(s)}throw new dt('fetch for "'+t.url+'" responded with '+t.status+": "+t.statusText,t)})).then((function(t){switch(s){case"arraybuffer":return t.arrayBuffer();case"blob":return t.blob();case"document":return t.text().then((function(t){return(new DOMParser).parseFromString(t,o)}));case"json":return t.json();default:if(void 0===o)return t.text();var e=/charset="?([^;"\s]*)"?/i.exec(o),n=e&&e[1]?e[1].toLowerCase():void 0,i=new TextDecoder(n);return t.arrayBuffer().then((function(t){return i.decode(t)}))}})).then((function(t){e&&e(t)})).catch((function(e){i&&i(e),r.manager.itemError(t)})).finally((function(){r.manager.itemEnd(t)})),this.manager.itemStart(t)},n.setResponseType=function(t){return this.responseType=t,this},n.setMimeType=function(t){return this.mimeType=t,this},e}(ct),dt=function(t){function e(e,n){var i;return(i=t.call(this,e)||this).response=n,i}return i(e,t),e}(s(Error)),ft=function(t){function e(e){return t.call(this,e)||this}return i(e,t),e.prototype.load=function(t,e,n,i){void 0===t&&(t=""),void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);var r=this,a=document.createElementNS("http://www.w3.org/1999/xhtml","img");function o(){u(),e&&e(this),r.manager.itemEnd(t)}function s(e){u(),i&&i(e),r.manager.itemError(t),r.manager.itemEnd(t)}function u(){a.removeEventListener("load",o,!1),a.removeEventListener("error",s,!1)}return a.addEventListener("load",o,!1),a.addEventListener("error",s,!1),"data:"!==t.slice(0,5)&&void 0!==this.crossOrigin&&(a.crossOrigin=this.crossOrigin),r.manager.itemStart(t),a.src=t,a},e}(ct),pt=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}var e=t.prototype;return e.set=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e,this},e.lerpVectors=function(t,e,n){return this.subVectors(e,t).multiplyScalar(n).add(t)},e.min=function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this},e.max=function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this},e.getLength=function(){return Math.sqrt(this.getLengthSquared())},e.getLengthSquared=function(){return this.x*this.x+this.y*this.y},e.normalize=function(t){void 0===t&&(t=1);var e=t/(this.getLength()||1);return this.x*=e,this.y*=e,this},e.subtract=function(e,n){return void 0===n&&(n=new t),n.set(this.x-e.x,this.y-e.y)},e.sub=function(t){return this.x-=t.x,this.y-=t.y,this},e.copy=function(t){return this.x=t.x,this.y=t.y,this},e.addVectors=function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this},e.subVectors=function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this},e.multiplyScalar=function(t){return this.x*=t,this.y*=t,this},e.distanceToSquared=function(t){var e=this.x-t.x,n=this.y-t.y;return e*e+n*n},e.distanceTo=function(t){return Math.sqrt(this.distanceToSquared(t))},e.fromArray=function(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this},e.toArray=function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t},e.add=function(t){return this.x+=t.x,this.y+=t.y,this},e.angle=function(){return Math.atan2(-this.y,-this.x)+Math.PI},e.clone=function(){return new t(this.x,this.y)},t}(),_t=function(){function t(t,e){this.min=void 0!==t?t:new pt(1/0,1/0),this.max=void 0!==e?e:new pt(-1/0,-1/0)}var e=t.prototype;return e.set=function(t,e,n,i){this.min.set(t,e),this.max.set(n,i)},e.clone=function(){return(new t).copy(this)},e.copy=function(t){return this.min.copy(t.min),this.max.copy(t.max),this},t}(),vt=[new _,new _,new _,new _,new _,new _,new _,new _],mt=function(){function t(t,e){this.min=void 0!==t?t:new _(1/0,1/0,1/0),this.max=void 0!==e?e:new _(-1/0,-1/0,-1/0)}var e=t.prototype;return e.set=function(t,e){this.min.copy(t),this.max.copy(e)},e.setFromPoints=function(t){this.makeEmpty();for(var e=0,n=t.length;e<n;e++)this.expandByPoint(t[e]);return this},e.makeEmpty=function(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this},e.expandByPoint=function(t){return this.min.min(t),this.max.max(t),this},e.expandByScalar=function(t){return this.min.addScalar(-t),this.max.addScalar(t),this},e.expandByBox3=function(t){return this.min.min(t.min),this.max.max(t.max),this},e.setFromArray=function(t,e,n){void 0===e&&(e=3),void 0===n&&(n=0);for(var i=1/0,r=1/0,a=1/0,o=-1/0,s=-1/0,u=-1/0,l=0,c=t.length;l<c;l+=e){var h=t[l+n],d=t[l+n+1],f=t[l+n+2];h<i&&(i=h),d<r&&(r=d),f<a&&(a=f),h>o&&(o=h),d>s&&(s=d),f>u&&(u=f)}return this.min.set(i,r,a),this.max.set(o,s,u),this},e.isEmpty=function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},e.equals=function(t){return t.min.equals(this.min)&&t.max.equals(this.max)},e.getCenter=function(t){var e=t||new _;return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)},e.applyMatrix4=function(t){return this.isEmpty()||(vt[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),vt[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),vt[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),vt[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),vt[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),vt[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),vt[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),vt[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(vt)),this},e.clone=function(){return(new t).copy(this)},e.copy=function(t){return this.min.copy(t.min),this.max.copy(t.max),this},t}(),gt=function(){function t(t,e,n){if(this.r=0,this.g=0,this.b=0,void 0===e&&void 0===n)return this.setHex(t);this.setRGB(t,e,n)}var e=t.prototype;return e.lerpColors=function(t,e,n){this.r=n*(e.r-t.r)+t.r,this.g=n*(e.g-t.g)+t.g,this.b=n*(e.b-t.b)+t.b},e.lerp=function(t,e){this.lerpColors(this,t,e)},e.clone=function(){return new t(this.r,this.g,this.b)},e.copy=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this},e.setHex=function(t){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,this},e.getHex=function(){return St(255*this.r,0,255)<<16^St(255*this.g,0,255)<<8^St(255*this.b,0,255)<<0},e.setRGB=function(t,e,n){return this.r=t,this.g=e,this.b=n,this},e.setHSL=function(t,e,n){var i;if(t=(t%(i=1)+i)%i,e=Math.max(0,Math.min(1,e)),n=Math.max(0,Math.min(1,n)),0===e)this.r=this.g=this.b=n;else{var r=n<=.5?n*(1+e):n+e-n*e,a=2*n-r;this.r=Et(a,r,t+1/3),this.g=Et(a,r,t),this.b=Et(a,r,t-1/3)}return this},e.convertSRGBToLinear=function(){return this.r=Mt(this.r),this.g=Mt(this.g),this.b=Mt(this.b),this},e.convertLinearToSRGB=function(){return this.r=Tt(this.r),this.g=Tt(this.g),this.b=Tt(this.b),this},e.fromArray=function(t,e){return void 0===e&&(e=0),this.r=t[e],this.g=t[e+1],this.b=t[e+2],this},e.toArray=function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t},t}();function Et(t,e,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?t+6*(e-t)*n:n<.5?e:n<2/3?t+6*(e-t)*(2/3-n):t}function St(t,e,n){return Math.max(e,Math.min(n,t))}function Mt(t){return t<.04045?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}function Tt(t){return t<.0031308?12.92*t:1.055*Math.pow(t,.41666)-.055}var yt=new m,xt=function(){function t(e,n,i,r){void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=t.DefaultOrder),this._x=e,this._y=n,this._z=i,this._order=r}var e=t.prototype;return e.clone=function(){return new t(this._x,this._y,this._z,this._order)},e.copy=function(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this.onChangeCallback(),this},e.set=function(t,e,n,i){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=this._order),this._x=t,this._y=e,this._z=n,this._order=i,this.onChangeCallback(),this},e.setFromRotationMatrix=function(t,e,n){void 0===e&&(e=this._order),void 0===n&&(n=!0);var i=t.elements,r=i[0],a=i[4],o=i[8],s=i[1],u=i[5],l=i[9],c=i[2],h=i[6],d=i[10];return"XYZ"===e?(this._y=Math.asin(wt(o,-1,1)),Math.abs(o)<.99999?(this._x=Math.atan2(-l,d),this._z=Math.atan2(-a,r)):(this._x=Math.atan2(h,u),this._z=0)):"YXZ"===e?(this._x=Math.asin(-wt(l,-1,1)),Math.abs(l)<.99999?(this._y=Math.atan2(o,d),this._z=Math.atan2(s,u)):(this._y=Math.atan2(-c,r),this._z=0)):"ZXY"===e?(this._x=Math.asin(wt(h,-1,1)),Math.abs(h)<.99999?(this._y=Math.atan2(-c,d),this._z=Math.atan2(-a,u)):(this._y=0,this._z=Math.atan2(s,r))):"ZYX"===e?(this._y=Math.asin(-wt(c,-1,1)),Math.abs(c)<.99999?(this._x=Math.atan2(h,d),this._z=Math.atan2(s,r)):(this._x=0,this._z=Math.atan2(-a,u))):"YZX"===e?(this._z=Math.asin(wt(s,-1,1)),Math.abs(s)<.99999?(this._x=Math.atan2(-l,u),this._y=Math.atan2(-c,r)):(this._x=0,this._y=Math.atan2(o,d))):"XZY"===e?(this._z=Math.asin(-wt(a,-1,1)),Math.abs(a)<.99999?(this._x=Math.atan2(h,u),this._y=Math.atan2(o,r)):(this._x=Math.atan2(-l,d),this._y=0)):console.warn("given unsupported order: "+e),this._order=e,!0===n&&this.onChangeCallback(),this},e.setFromQuaternion=function(t,e,n){return t.toMatrix4(yt),this.setFromRotationMatrix(yt,e,n)},e.onChange=function(t){return this.onChangeCallback=t,this},e.onChangeCallback=function(){},n(t,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this.onChangeCallback()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this.onChangeCallback()}},{key:"z",get:function(){return this._z},set:function(t){this._z=t,this.onChangeCallback()}},{key:"order",get:function(){return this._order},set:function(t){this._order=t,this.onChangeCallback()}}]),t}();function wt(t,e,n){return Math.max(e,Math.min(n,t))}xt.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],xt.DefaultOrder="XYZ";for(var At=function(){function t(){this.elements=[1,0,0,0,1,0,0,0,1]}var e=t.prototype;return e.set=function(t,e,n,i,r,a,o,s,u){var l=this.elements;return l[0]=t,l[3]=e,l[6]=n,l[1]=i,l[4]=r,l[7]=a,l[2]=o,l[5]=s,l[8]=u,this},e.identity=function(){return this.set(1,0,0,0,1,0,0,0,1)},e.inverse=function(){return this.getInverse(this)},e.getInverse=function(t){var e=t.elements,n=this.elements,i=e[0],r=e[1],a=e[2],o=e[3],s=e[4],u=e[5],l=e[6],c=e[7],h=e[8],d=h*s-u*c,f=u*l-h*o,p=c*o-s*l,_=i*d+r*f+a*p;if(0===_)return console.warn("Matrix3: .getInverse() can not invert matrix, determinant is 0"),this.identity();var v=1/_;return n[0]=d*v,n[1]=(a*c-h*r)*v,n[2]=(u*r-a*s)*v,n[3]=f*v,n[4]=(h*i-a*l)*v,n[5]=(a*o-u*i)*v,n[6]=p*v,n[7]=(r*l-c*i)*v,n[8]=(s*i-r*o)*v,this},e.transpose=function(){var t,e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this},e.fromArray=function(t,e){void 0===e&&(e=0);for(var n=0;n<9;n++)this.elements[n]=t[n+e];return this},e.toArray=function(t,e){void 0===t&&(t=[]),void 0===e&&(e=0);var n=this.elements;return t[e]=n[0],t[e+1]=n[1],t[e+2]=n[2],t[e+3]=n[3],t[e+4]=n[4],t[e+5]=n[5],t[e+6]=n[6],t[e+7]=n[7],t[e+8]=n[8],t},e.clone=function(){return(new t).fromArray(this.elements)},e.copy=function(t){var e=this.elements,n=t.elements;return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],this},e.multiply=function(t){return this.multiplyMatrices(this,t)},e.premultiply=function(t){return this.multiplyMatrices(t,this)},e.multiplyMatrices=function(t,e){var n=t.elements,i=e.elements,r=this.elements,a=n[0],o=n[3],s=n[6],u=n[1],l=n[4],c=n[7],h=n[2],d=n[5],f=n[8],p=i[0],_=i[3],v=i[6],m=i[1],g=i[4],E=i[7],S=i[2],M=i[5],T=i[8];return r[0]=a*p+o*m+s*S,r[3]=a*_+o*g+s*M,r[6]=a*v+o*E+s*T,r[1]=u*p+l*m+c*S,r[4]=u*_+l*g+c*M,r[7]=u*v+l*E+c*T,r[2]=h*p+d*m+f*S,r[5]=h*_+d*g+f*M,r[8]=h*v+d*E+f*T,this},e.transform=function(t,e,n,i,r,a,o){var s=this.elements,u=Math.cos(r),l=Math.sin(r);return s[0]=u*n,s[3]=-l*i,s[6]=t,s[1]=l*n,s[4]=u*i,s[7]=e,s[2]=0,s[5]=0,s[8]=1,(a||o)&&(s[6]-=a*s[0]+o*s[3],s[7]-=a*s[1]+o*s[4]),this},e.setUvTransform=function(t,e,n,i,r,a,o){var s=Math.cos(r),u=Math.sin(r);return this.set(n*s,n*u,-n*(s*a+u*o)+a+t,-i*u,i*s,-i*(-u*a+s*o)+o+e,0,0,1)},e.setFromMatrix4=function(t){var e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10])},t}(),bt=new _,Rt=new At,Nt=function(){function t(t,e){void 0===t&&(t=new _(1,0,0)),void 0===e&&(e=0),this.normal=t,this.constant=e}var e=t.prototype;return e.set=function(t,e){return this.normal.copy(t),this.constant=e,this},e.setComponents=function(t,e,n,i){return this.normal.set(t,e,n),this.constant=i,this},e.setFromNormalAndCoplanarPoint=function(t,e){return this.normal.copy(t),this.constant=-e.dot(this.normal),this},e.normalize=function(){var t=1/this.normal.getLength();return this.normal.multiplyScalar(t),this.constant*=t,this},e.distanceToPoint=function(t){return this.normal.dot(t)+this.constant},e.coplanarPoint=function(t){return void 0===t&&(t=new _),t.copy(this.normal).multiplyScalar(-this.constant)},e.clone=function(){return(new t).copy(this)},e.copy=function(t){return this.normal.copy(t.normal),this.constant=t.constant,this},e.applyMatrix4=function(t,e){var n=e||Rt.setFromMatrix4(t).inverse().transpose(),i=this.coplanarPoint(bt).applyMatrix4(t),r=this.normal.applyMatrix3(n).normalize();return this.constant=-i.dot(r),this},t}(),Pt=new _,Lt=function(){function t(t,e,n,i,r,a){void 0===t&&(t=new Nt),void 0===e&&(e=new Nt),void 0===n&&(n=new Nt),void 0===i&&(i=new Nt),void 0===r&&(r=new Nt),void 0===a&&(a=new Nt),this.planes=[t,e,n,i,r,a]}var e=t.prototype;return e.set=function(t,e,n,i,r,a){var o=this.planes;return o[0].copy(t),o[1].copy(e),o[2].copy(n),o[3].copy(i),o[4].copy(r),o[5].copy(a),this},e.setFromMatrix=function(t){var e=this.planes,n=t.elements,i=n[0],r=n[1],a=n[2],o=n[3],s=n[4],u=n[5],l=n[6],c=n[7],h=n[8],d=n[9],f=n[10],p=n[11],_=n[12],v=n[13],m=n[14],g=n[15];return e[0].setComponents(o-i,c-s,p-h,g-_).normalize(),e[1].setComponents(o+i,c+s,p+h,g+_).normalize(),e[2].setComponents(o+r,c+u,p+d,g+v).normalize(),e[3].setComponents(o-r,c-u,p-d,g-v).normalize(),e[4].setComponents(o-a,c-l,p-f,g-m).normalize(),e[5].setComponents(o+a,c+l,p+f,g+m).normalize(),this},e.intersectsSphere=function(t){for(var e=this.planes,n=t.center,i=-t.radius,r=0;r<6;r++){if(e[r].distanceToPoint(n)<i)return!1}return!0},e.intersectsBox=function(t){for(var e=this.planes,n=0;n<6;n++){var i=e[n];if(Pt.x=i.normal.x>0?t.max.x:t.min.x,Pt.y=i.normal.y>0?t.max.y:t.min.y,Pt.z=i.normal.z>0?t.max.z:t.min.z,i.distanceToPoint(Pt)<0)return!1}return!0},e.clone=function(){return(new this.constructor).copy(this)},e.copy=function(t){for(var e=this.planes,n=0;n<6;n++)e[n].copy(t.planes[n]);return this},t}(),Ct=new _,Dt=new _,Ot=new _,Ft=new _,It=new _,Ut=function(){function t(t,e){void 0===t&&(t=new _),void 0===e&&(e=new _(0,0,-1)),this.origin=t,this.direction=e}var e=t.prototype;return e.set=function(t,e){return this.origin.copy(t),this.direction.copy(e),this},e.copy=function(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this},e.applyMatrix4=function(t){return this.origin.applyMatrix4(t),this.direction.transformDirection(t),this},e.at=function(t,e){return void 0===e&&(e=new _),e.copy(this.direction).multiplyScalar(t).add(this.origin)},e.distanceSqToPoint=function(t){var e=Ct.subVectors(t,this.origin).dot(this.direction);return e<0?this.origin.distanceToSquared(t):(Ct.copy(this.direction).multiplyScalar(e).add(this.origin),Ct.distanceToSquared(t))},e.intersectsBox=function(t){return null!==this.intersectBox(t,Ct)},e.intersectBox=function(t,e){var n,i,r,a,o,s,u=1/this.direction.x,l=1/this.direction.y,c=1/this.direction.z,h=this.origin;return u>=0?(n=(t.min.x-h.x)*u,i=(t.max.x-h.x)*u):(n=(t.max.x-h.x)*u,i=(t.min.x-h.x)*u),l>=0?(r=(t.min.y-h.y)*l,a=(t.max.y-h.y)*l):(r=(t.max.y-h.y)*l,a=(t.min.y-h.y)*l),n>a||r>i?null:((r>n||n!=n)&&(n=r),(a<i||i!=i)&&(i=a),c>=0?(o=(t.min.z-h.z)*c,s=(t.max.z-h.z)*c):(o=(t.max.z-h.z)*c,s=(t.min.z-h.z)*c),n>s||o>i?null:((o>n||n!=n)&&(n=o),(s<i||i!=i)&&(i=s),i<0?null:this.at(n>=0?n:i,e)))},e.intersectsSphere=function(t){return this.distanceSqToPoint(t.center)<=t.radius*t.radius},e.intersectSphere=function(t,e){Ct.subVectors(t.center,this.origin);var n=Ct.dot(this.direction),i=Ct.dot(Ct)-n*n,r=t.radius*t.radius;if(i>r)return null;var a=Math.sqrt(r-i),o=n-a,s=n+a;return o<0&&s<0?null:o<0?this.at(s,e):this.at(o,e)},e.intersectTriangle=function(t,e,n,i,r){Ot.subVectors(e,t),Ft.subVectors(n,t),It.crossVectors(Ot,Ft);var a,o=this.direction.dot(It);if(o>0){if(i)return null;a=1}else{if(!(o<0))return null;a=-1,o=-o}Dt.subVectors(this.origin,t);var s=a*this.direction.dot(Ft.crossVectors(Dt,Ft));if(s<0)return null;var u=a*this.direction.dot(Ot.cross(Dt));if(u<0)return null;if(s+u>o)return null;var l=-a*Dt.dot(It);return l<0?null:this.at(l/o,r)},t}(),Bt=new mt,Gt=new _,zt=function(){function t(t,e){void 0===t&&(t=new _),void 0===e&&(e=-1),this.center=t,this.radius=e}var e=t.prototype;return e.set=function(t,e){return this.center.copy(t),this.radius=e,this},e.setFromArray=function(t,e,n){void 0===e&&(e=3),void 0===n&&(n=0);var i=this.center;Bt.setFromArray(t,e).getCenter(i);for(var r=0,a=0,o=t.length;a<o;a+=e)Gt.fromArray(t,a+n),r=Math.max(r,i.distanceToSquared(Gt));return this.radius=Math.sqrt(r),this},e.applyMatrix4=function(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScaleOnAxis(),this},e.getBoundingBox=function(t){return this.isEmpty()?(t.makeEmpty(),t):(t.set(this.center,this.center),t.expandByScalar(this.radius),t)},e.isEmpty=function(){return this.radius<0},e.makeEmpty=function(){return this.center.set(0,0,0),this.radius=-1,this},e.expandByPoint=function(t){if(this.isEmpty())return this.center.copy(t),this.radius=0,this;Gt.subVectors(t,this.center);var e=Gt.getLengthSquared();if(e>this.radius*this.radius){var n=Math.sqrt(e),i=.5*(n-this.radius);this.center.addScaledVector(Gt,i/n),this.radius+=i}return this},e.clone=function(){return(new t).copy(this)},e.copy=function(t){return this.center.copy(t.center),this.radius=t.radius,this},t}(),Ht=function(){function t(t,e,n){void 0===t&&(t=1),void 0===e&&(e=0),void 0===n&&(n=0),this.radius=t,this.phi=e,this.theta=n}var e=t.prototype;return e.set=function(t,e,n){return this.radius=t,this.phi=e,this.theta=n,this},e.copy=function(t){return this.radius=t.radius,this.phi=t.phi,this.theta=t.theta,this},e.clone=function(){return(new t).copy(this)},e.makeSafe=function(){var t=1e-6;return this.phi=Math.max(t,Math.min(Math.PI-t,this.phi)),this},e.setFromVector3=function(t){return this.radius=t.getLength(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(t.x,t.z),this.phi=Math.acos(Math.min(1,Math.max(-1,t.y/this.radius)))),this},t}(),Vt=new _,kt=new _,Xt=new _,Wt=new _,jt=function(){function t(t,e,n){void 0===t&&(t=new _),void 0===e&&(e=new _),void 0===n&&(n=new _),this.a=t,this.b=e,this.c=n}return t.normal=function(t,e,n,i){var r=i||new _;r.subVectors(n,e),Vt.subVectors(t,e),r.cross(Vt);var a=r.getLengthSquared();return a>0?r.multiplyScalar(1/Math.sqrt(a)):r.set(0,0,0)},t.barycoordFromPoint=function(t,e,n,i,r){Vt.subVectors(i,e),kt.subVectors(n,e),Xt.subVectors(t,e);var a=Vt.dot(Vt),o=Vt.dot(kt),s=Vt.dot(Xt),u=kt.dot(kt),l=kt.dot(Xt),c=a*u-o*o,h=r||new _;if(0===c)return h.set(-2,-1,-1);var d=1/c,f=(u*s-o*l)*d,p=(a*l-o*s)*d;return h.set(1-f-p,p,f)},t.containsPoint=function(t,e,n,i){return this.barycoordFromPoint(t,e,n,i,Wt),Wt.x>=0&&Wt.y>=0&&Wt.x+Wt.y<=1},t.prototype.set=function(t,e,n){return this.a.copy(t),this.b.copy(e),this.c.copy(n),this},t}(),Yt=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),this.x=t,this.y=e,this.z=n,this.w=i}var e=t.prototype;return e.lerpVectors=function(t,e,n){return this.subVectors(e,t).multiplyScalar(n).add(t)},e.set=function(t,e,n,i){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),this.x=t,this.y=e,this.z=n,this.w=i,this},e.normalize=function(){return this.multiplyScalar(1/(this.getLength()||1))},e.multiplyScalar=function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},e.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},e.getLengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},e.getLength=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},e.getManhattanLength=function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},e.applyMatrix4=function(t){var e=this.x,n=this.y,i=this.z,r=this.w,a=t.elements;return this.x=a[0]*e+a[4]*n+a[8]*i+a[12]*r,this.y=a[1]*e+a[5]*n+a[9]*i+a[13]*r,this.z=a[2]*e+a[6]*n+a[10]*i+a[14]*r,this.w=a[3]*e+a[7]*n+a[11]*i+a[15]*r,this},e.equals=function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w},e.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},e.multiply=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this},e.subVectors=function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this},e.fromArray=function(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this},e.toArray=function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t},e.clone=function(){return new t(this.x,this.y,this.z,this.w)},e.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=void 0!==t.w?t.w:1,this},t}(),qt=[],Qt=0;Qt<256;Qt++)qt[Qt]=(Qt<16?"0":"")+Qt.toString(16);function Zt(){var t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,n=4294967295*Math.random()|0,i=4294967295*Math.random()|0;return(qt[255&t]+qt[t>>8&255]+qt[t>>16&255]+qt[t>>24&255]+"-"+qt[255&e]+qt[e>>8&255]+"-"+qt[e>>16&15|64]+qt[e>>24&255]+"-"+qt[63&n|128]+qt[n>>8&255]+"-"+qt[n>>16&255]+qt[n>>24&255]+qt[255&i]+qt[i>>8&255]+qt[i>>16&255]+qt[i>>24&255]).toUpperCase()}function Kt(t){return 0==(t&t-1)&&0!==t}function Jt(t){return Math.pow(2,Math.round(Math.log(t)/Math.LN2))}function $t(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}function te(t){var e={};for(var n in t){var i=t[n];Array.isArray(i)||ArrayBuffer.isView(i)?e[n]=i.slice():e[n]=i}return e}function ee(t){var e=Array.isArray(t)?[]:{};if(t&&"object"==typeof t)for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]&&"object"==typeof t[n]?ee(t[n]):t[n]);return e}var ne=0,ie=new m,re=function(){function t(){this.id=ne++,this.uuid=Zt(),this.name="",this.position=new _,this.scale=new _(1,1,1),this.euler=new xt,this.quaternion=new y;var t=this.euler,e=this.quaternion;t.onChange((function(){e.setFromEuler(t,!1)})),e.onChange((function(){t.setFromQuaternion(e,void 0,!1)})),this.matrix=new m,this.worldMatrix=new m,this.children=new Array,this.parent=null,this.castShadow=!1,this.receiveShadow=!1,this.shadowType=z.PCF3_SOFT,this.frustumCulled=!0,this.visible=!0,this.renderOrder=0,this.renderLayer=0,this.renderable=!0,this.userData={},this.matrixAutoUpdate=!0,this.matrixNeedsUpdate=!0,this.worldMatrixNeedsUpdate=!0}var e=t.prototype;return e.onBeforeRender=function(){},e.onAfterRender=function(){},e.add=function(t){t!==this?(null!==t.parent&&t.parent.remove(t),t.parent=this,this.children.push(t),t.worldMatrixNeedsUpdate=!0):console.error("Object3D.add: object can't be added as a child of itself.",t)},e.remove=function(t){var e=this.children.indexOf(t);-1!==e&&(t.parent=null,this.children.splice(e,1),t.worldMatrixNeedsUpdate=!0)},e.getObjectByName=function(t){return this.getObjectByProperty("name",t)},e.getObjectByProperty=function(t,e){if(this[t]===e)return this;for(var n=0,i=this.children.length;n<i;n++){var r=this.children[n].getObjectByProperty(t,e);if(void 0!==r)return r}},e.updateMatrix=function(t){if((this.matrixAutoUpdate||this.matrixNeedsUpdate)&&(this.matrix.transform(this.position,this.scale,this.quaternion),this.matrixNeedsUpdate=!1,this.worldMatrixNeedsUpdate=!0),this.worldMatrixNeedsUpdate||t){if(this.worldMatrix.copy(this.matrix),this.parent){var e=this.parent.worldMatrix;this.worldMatrix.premultiply(e)}this.worldMatrixNeedsUpdate=!1,t=!0}for(var n=this.children,i=0,r=n.length;i<r;i++)n[i].updateMatrix(t)},e.getWorldDirection=function(t){void 0===t&&(t=new _);var e=this.worldMatrix.elements;return t.set(e[8],e[9],e[10]).normalize()},e.lookAt=function(t,e){ie.lookAtRH(t,this.position,e),this.quaternion.setFromRotationMatrix(ie)},e.raycast=function(t,e){},e.traverse=function(t){t(this);for(var e=this.children,n=0,i=e.length;n<i;n++)e[n].traverse(t)},e.clone=function(t){return(new this.constructor).copy(this,t)},e.copy=function(t,e){if(void 0===e&&(e=!0),this.name=t.name,this.position.copy(t.position),this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.worldMatrix.copy(t.worldMatrix),this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.shadowType=t.shadowType,this.frustumCulled=t.frustumCulled,this.visible=t.visible,this.renderOrder=t.renderOrder,this.renderLayer=t.renderLayer,this.renderable=t.renderable,this.userData=ee(t.userData),!0===e)for(var n=0;n<t.children.length;n++){var i=t.children[n];this.add(i.clone())}return this},t}(),ae=new _,oe=[],se=[],ue=[],le=0,ce=function(){function t(){this.id=le++,this.version=0,this.lights=[],this.ambient=new Float32Array([0,0,0]),this.hemisphere=[],this.directional=[],this.directionalShadow=[],this.directionalShadowMap=[],this.directionalShadowDepthMap=[],this.directionalShadowMatrix=new Float32Array(0),this.point=[],this.pointShadow=[],this.pointShadowMap=[],this.pointShadowMatrix=new Float32Array(0),this.spot=[],this.spotShadow=[],this.spotShadowMap=[],this.spotShadowDepthMap=[],this.spotShadowMatrix=new Float32Array(0),this.useAmbient=!1,this.hemisNum=0,this.directsNum=0,this.pointsNum=0,this.spotsNum=0,this.directShadowNum=0,this.pointShadowNum=0,this.spotShadowNum=0,this.totalNum=0,this.shadowsNum=0,this.hash=new _e}var e=t.prototype;return e.begin=function(){this.totalNum=0,this.shadowsNum=0},e.push=function(t){this.lights[this.totalNum++]=t,me(t)&&this.shadowsNum++},e.end=function(t){this.lights.length=this.totalNum,this.lights.sort(ve),this._setupCache(t),this.hash.update(this),this.version++},e._setupCache=function(t){for(var e=0;e<3;e++)this.ambient[e]=0;this.useAmbient=!1,this.hemisNum=0,this.directsNum=0,this.pointsNum=0,this.spotsNum=0,this.directShadowNum=0,this.pointShadowNum=0,this.spotShadowNum=0;for(var n=0,i=this.lights.length;n<i;n++){var r=this.lights[n];r.isAmbientLight?this._doAddAmbientLight(r):r.isHemisphereLight?this._doAddHemisphereLight(r,t):r.isDirectionalLight?this._doAddDirectLight(r,t):r.isPointLight?this._doAddPointLight(r,t):r.isSpotLight&&this._doAddSpotLight(r,t)}var a=this.directShadowNum;if(a>0){this.directionalShadowMap.length=a,this.directionalShadowDepthMap.length=a,oe.length=a,this.directionalShadowMatrix.length!==16*a&&(this.directionalShadowMatrix=new Float32Array(16*a));for(var o=0;o<a;o++)oe[o].toArray(this.directionalShadowMatrix,16*o)}var s=this.pointShadowNum;if(s>0){this.pointShadowMap.length=s,se.length=s,this.pointShadowMatrix.length!==16*s&&(this.pointShadowMatrix=new Float32Array(16*s));for(var u=0;u<s;u++)se[u].toArray(this.pointShadowMatrix,16*u)}var l=this.spotShadowNum;if(l>0){this.spotShadowMap.length=l,this.spotShadowDepthMap.length=l,ue.length=l,this.spotShadowMatrix.length!==16*l&&(this.spotShadowMatrix=new Float32Array(16*l));for(var c=0;c<l;c++)ue[c].toArray(this.spotShadowMatrix,16*c)}},e._doAddAmbientLight=function(t){var e=t.intensity,n=t.color;this.ambient[0]+=n.r*e,this.ambient[1]+=n.g*e,this.ambient[2]+=n.b*e,this.useAmbient=!0},e._doAddHemisphereLight=function(t,e){var n=t.intensity,i=t.color,r=t.groundColor,a=e.useAnchorMatrix,o=de(t);o.skyColor[0]=i.r*n,o.skyColor[1]=i.g*n,o.skyColor[2]=i.b*n,o.groundColor[0]=r.r*n,o.groundColor[1]=r.g*n,o.groundColor[2]=r.b*n;var s=t.worldMatrix.elements,u=ae.set(s[4],s[5],s[6]).normalize();a&&u.transformDirection(e.anchorMatrixInverse),u.toArray(o.direction),this.hemisphere[this.hemisNum++]=o},e._doAddDirectLight=function(t,e){var n=t.intensity,i=t.color,r=e.useAnchorMatrix,a=de(t);a.color[0]=i.r*n,a.color[1]=i.g*n,a.color[2]=i.b*n;var o=t.getWorldDirection(ae);if(r&&o.transformDirection(e.anchorMatrixInverse),o.multiplyScalar(-1).toArray(a.direction),t.castShadow){var s=t.shadow,u=pe(t);u.shadowBias[0]=s.bias,u.shadowBias[1]=s.normalBias,u.shadowMapSize[0]=s.mapSize.x,u.shadowMapSize[1]=s.mapSize.y,u.shadowParams[0]=s.radius,u.shadowParams[1]=s.frustumEdgeFalloff,this.directionalShadow[this.directShadowNum++]=u,s.update(t),s.updateMatrix(),r&&s.matrix.multiply(e.anchorMatrix),this.directionalShadowMap[this.directsNum]=s.map,this.directionalShadowDepthMap[this.directsNum]=s.depthMap,oe[this.directsNum]=s.matrix}this.directional[this.directsNum++]=a},e._doAddPointLight=function(t,e){var n=t.intensity,i=t.color,r=t.distance,a=t.decay,o=e.useAnchorMatrix,s=de(t);s.color[0]=i.r*n,s.color[1]=i.g*n,s.color[2]=i.b*n,s.distance=r,s.decay=a;var u=ae.setFromMatrixPosition(t.worldMatrix);if(o&&u.applyMatrix4(e.anchorMatrixInverse),s.position[0]=u.x,s.position[1]=u.y,s.position[2]=u.z,t.castShadow){var l=t.shadow,c=pe(t);c.shadowBias[0]=l.bias,c.shadowBias[1]=l.normalBias,c.shadowMapSize[0]=l.mapSize.x,c.shadowMapSize[1]=l.mapSize.y,c.shadowParams[0]=l.radius,c.shadowParams[1]=0,c.shadowCameraRange[0]=l.cameraNear,c.shadowCameraRange[1]=l.cameraFar,this.pointShadow[this.pointShadowNum++]=c,l.update(t,0),l.matrix.makeTranslation(-u.x,-u.y,-u.z),this.pointShadowMap[this.pointsNum]=l.map,se[this.pointsNum]=l.matrix}this.point[this.pointsNum++]=s},e._doAddSpotLight=function(t,e){var n=t.intensity,i=t.color,r=t.distance,a=t.decay,o=e.useAnchorMatrix,s=de(t);s.color[0]=i.r*n,s.color[1]=i.g*n,s.color[2]=i.b*n,s.distance=r,s.decay=a;var u=ae.setFromMatrixPosition(t.worldMatrix);o&&u.applyMatrix4(e.anchorMatrixInverse),s.position[0]=u.x,s.position[1]=u.y,s.position[2]=u.z;var l=t.getWorldDirection(ae);o&&l.transformDirection(e.anchorMatrixInverse),l.multiplyScalar(-1).toArray(s.direction);var c=Math.cos(t.angle),h=Math.cos(t.angle*(1-t.penumbra));if(s.coneCos=c,s.penumbraCos=h,t.castShadow){var d=t.shadow,f=pe(t);f.shadowBias[0]=d.bias,f.shadowBias[1]=d.normalBias,f.shadowMapSize[0]=d.mapSize.x,f.shadowMapSize[1]=d.mapSize.y,f.shadowParams[0]=d.radius,f.shadowParams[1]=d.frustumEdgeFalloff,this.spotShadow[this.spotShadowNum++]=f,d.update(t),d.updateMatrix(),o&&d.matrix.multiply(e.anchorMatrix),this.spotShadowMap[this.spotsNum]=d.map,this.spotShadowDepthMap[this.spotsNum]=d.depthMap,ue[this.spotsNum]=d.matrix}this.spot[this.spotsNum++]=s},t}(),he=new WeakMap;function de(t){return he.has(t)?he.get(t):(t.isHemisphereLight?e={direction:new Float32Array(3),skyColor:new Float32Array([0,0,0]),groundColor:new Float32Array([0,0,0])}:t.isDirectionalLight?e={direction:new Float32Array(3),color:new Float32Array([0,0,0])}:t.isPointLight?e={position:new Float32Array(3),color:new Float32Array([0,0,0]),distance:0,decay:0}:t.isSpotLight&&(e={position:new Float32Array(3),direction:new Float32Array(3),color:new Float32Array([0,0,0]),distance:0,coneCos:0,penumbraCos:0,decay:0}),he.set(t,e),e);var e}var fe=new WeakMap;function pe(t){return fe.has(t)?fe.get(t):(t.isDirectionalLight?e={shadowBias:new Float32Array(2),shadowMapSize:new Float32Array(2),shadowParams:new Float32Array(2)}:t.isPointLight?e={shadowBias:new Float32Array(2),shadowMapSize:new Float32Array(2),shadowParams:new Float32Array(2),shadowCameraRange:new Float32Array(2)}:t.isSpotLight&&(e={shadowBias:new Float32Array(2),shadowMapSize:new Float32Array(2),shadowParams:new Float32Array(2)}),fe.set(t,e),e);var e}var _e=function(){function t(){this._factor=new Uint16Array(8)}var e=t.prototype;return e.update=function(t){this._factor[0]=t.useAmbient?1:0,this._factor[1]=t.hemisNum,this._factor[2]=t.directsNum,this._factor[3]=t.pointsNum,this._factor[4]=t.spotsNum,this._factor[5]=t.directShadowNum,this._factor[6]=t.pointShadowNum,this._factor[7]=t.spotShadowNum},e.compare=function(t){if(!t)return!1;for(var e=0,n=t.length;e<n;e++)if(this._factor[e]!==t[e])return!1;return!0},e.copyTo=function(t){return t||(t=new this._factor.constructor(this._factor.length)),t.set(this._factor),t},t}();function ve(t,e){var n=me(t)?1:0;return(me(e)?1:0)-n}function me(t){return t.shadow&&t.castShadow}var ge=function(){function t(t){this.id=t,this.opaque=[],this.opaqueCount=0,this.transparent=[],this.transparentCount=0,this._cache=[],this._cacheIndex=0,this._lastCacheIndex=0,this.opaqueSortCompareFn=Ee,this.transparentSortCompareFn=Se}var e=t.prototype;return e.begin=function(){this._cacheIndex=0,this.opaqueCount=0,this.transparentCount=0},e.end=function(){this.opaque.length=this.opaqueCount,this.transparent.length=this.transparentCount;var t=this._cacheIndex,e=this._lastCacheIndex;if(e>t)for(var n=this._cache,i=t;i<e;i++){var r=n[i];r.object=null,r.geometry=null,r.material=null,r.group=null}this._lastCacheIndex=t},e.addRenderable=function(t,e,n,i,r){var a=this._cache,o=a[this._cacheIndex];void 0===o?(o={object:t,geometry:e,material:n,z:i,renderOrder:t.renderOrder,group:r},a[this._cacheIndex]=o):(o.object=t,o.geometry=e,o.material=n,o.z=i,o.renderOrder=t.renderOrder,o.group=r),n.transparent?(this.transparent[this.transparentCount]=o,this.transparentCount++):(this.opaque[this.opaqueCount]=o,this.opaqueCount++),this._cacheIndex++},e.sort=function(){this.opaque.sort(this.opaqueSortCompareFn),Me(this.transparent,0,this.transparent.length,this.transparentSortCompareFn)},t}();function Ee(t,e){return t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.material.id!==e.material.id?t.material.id-e.material.id:t.id-e.id}function Se(t,e){return t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.z!==e.z?e.z-t.z:t.material.id!==e.material.id?t.material.id-e.material.id:t.id-e.id}function Me(t,e,n,i){for(;;){if(n-e<=10)return void Te(t,e,n,i);var r=e+n>>1,a=t[e],o=t[n-1],s=t[r];if(i(a,o)>0){var u=a;a=o,o=u}if(i(a,s)>=0){var l=a;a=s,s=o,o=l}else{if(i(o,s)>0){var c=o;o=s,s=c}}t[e]=a,t[n-1]=s;var h=o,d=e+1,f=n-1;t[r]=t[d],t[d]=h;t:for(var p=d+1;p<f;p++){var _=t[p],v=i(_,h);if(v<0)t[p]=t[d],t[d]=_,d++;else if(v>0){do{if(--f==p)break t;v=i(t[f],h)}while(v>0);t[p]=t[f],t[f]=_,v<0&&(_=t[p],t[p]=t[d],t[d]=_,d++)}}n-f<d-e?(Me(t,f,n,i),n=d):(Me(t,e,d,i),e=f)}}function Te(t,e,n,i){for(var r=e+1;r<n;r++){var a=void 0,o=t[r];for(a=r-1;a>=e;a--){var s=t[a];if(!(i(s,o)>0))break;t[a+1]=s}t[a+1]=o}}var ye=function(){function t(){this.layerMap=new Map,this.layerList=[],this._lastLayer=this.createLayer(0)}var e=t.prototype;return e.begin=function(){for(var t=0,e=this.layerList.length;t<e;t++)this.layerList[t].begin()},e.end=function(){for(var t=0,e=this.layerList.length;t<e;t++)this.layerList[t].end(),this.layerList[t].sort()},e.push=function(t,e){if(!t.frustumCulled||!e.frustumCulled||(we.copy(t.geometry.boundingSphere).applyMatrix4(t.worldMatrix),e.frustum.intersectsSphere(we))){xe.setFromMatrixPosition(t.worldMatrix),xe.applyMatrix4(e.projectionViewMatrix);var n=t.renderLayer||0,i=this._lastLayer;if(i.id!==n&&((i=this.layerMap.get(n))||(i=this.createLayer(n)),this._lastLayer=i),Array.isArray(t.material))for(var r=t.geometry.groups,a=0;a<r.length;a++){var o=r[a],s=t.material[o.materialIndex];s&&i.addRenderable(t,t.geometry,s,xe.z,o)}else i.addRenderable(t,t.geometry,t.material,xe.z)}},e.setLayer=function(t,e){this.layerMap.set(t,e),this.layerList.push(e),this.layerList.sort(Ae)},e.createLayer=function(t){var e=new ge(t);return this.setLayer(t,e),e},e.getLayer=function(t){return this.layerMap.get(t)},e.removeLayer=function(t){var e=this.layerMap.get(t);if(e){this.layerMap.delete(t);var n=this.layerList.indexOf(e);-1!==n&&this.layerList.splice(n,1),this._lastLayer===t&&(this._lastLayer=null)}},t}(),xe=new _,we=new zt;function Ae(t,e){return t.id-e.id}var be=new Nt,Re=0,Ne=function(){function t(){this.id=Re++,this.version=0,this.useAnchorMatrix=!1,this.anchorMatrix=new m,this.anchorMatrixInverse=new m,this.disableShadowSampler=!1,this.logarithmicDepthBuffer=!1,this.fog=null,this.environment=null,this.environmentLightIntensity=1,this.clippingPlanesData=new Float32Array([]),this.numClippingPlanes=0}var e=t.prototype;return e.update=function(t){this.useAnchorMatrix=!t.anchorMatrix.isIdentity(),this.anchorMatrix.copy(t.anchorMatrix),this.anchorMatrixInverse.getInverse(t.anchorMatrix),this.disableShadowSampler=t.disableShadowSampler,this.logarithmicDepthBuffer=t.logarithmicDepthBuffer,this.fog=t.fog,this.environment=t.environment,this.environmentLightIntensity=t.environmentLightIntensity,this.clippingPlanesData.length<4*t.clippingPlanes.length&&(this.clippingPlanesData=new Float32Array(4*t.clippingPlanes.length)),this.setClippingPlanesData(t.clippingPlanes,this.clippingPlanesData),this.numClippingPlanes=t.clippingPlanes.length,this.version++},e.setClippingPlanesData=function(t,e){for(var n=0;n<t.length;n++)be.copy(t[n]),this.useAnchorMatrix&&be.applyMatrix4(this.anchorMatrixInverse),e[4*n+0]=be.normal.x,e[4*n+1]=be.normal.y,e[4*n+2]=be.normal.z,e[4*n+3]=be.constant;return e},t}();var Pe=0,Le=function(){function t(t,e){this.scene=t,this.lights=e,this.camera={id:Pe++,version:0,near:0,far:0,position:new _,logDepthCameraNear:0,logDepthBufFC:0,viewMatrix:new m,projectionMatrix:new m,projectionViewMatrix:new m,rect:new Yt(0,0,1,1)},this.gammaFactor=2,this.outputEncoding=H.LINEAR}return t.prototype.updateCamera=function(t){var e=this.scene,n=this.camera,i=t.projectionMatrix,r=0,a=0;-1===i.elements[11]?(r=i.elements[14]/(i.elements[10]-1),a=i.elements[14]/(i.elements[10]+1)):(r=(i.elements[14]+1)/i.elements[10],a=(i.elements[14]-1)/i.elements[10]),n.near=r,n.far=a,e.logarithmicDepthBuffer?(n.logDepthCameraNear=r,n.logDepthBufFC=2/(Math.log(a-r+1)*Math.LOG2E)):(n.logDepthCameraNear=0,n.logDepthBufFC=0),n.position.setFromMatrixPosition(t.worldMatrix),e.useAnchorMatrix&&n.position.applyMatrix4(e.anchorMatrixInverse),n.viewMatrix.copy(t.viewMatrix),e.useAnchorMatrix&&n.viewMatrix.multiply(e.anchorMatrix),n.projectionMatrix.copy(i),n.projectionViewMatrix.copy(i).multiply(n.viewMatrix),n.rect.copy(t.rect),n.version++,this.gammaFactor=t.gammaFactor,this.outputEncoding=t.outputEncoding},t}(),Ce=function(t){function e(){var e;return(e=t.call(this)||this).fog=null,e.environment=null,e.environmentLightIntensity=1,e.clippingPlanes=[],e.disableShadowSampler=!1,e.logarithmicDepthBuffer=!1,e.anchorMatrix=new m,e._sceneData=new Ne,e._lightData=new ce,e._skeletons=new Set,e._renderQueueMap=new WeakMap,e._renderStatesMap=new WeakMap,e}i(e,t);var n=e.prototype;return n.updateRenderStates=function(t,e){e=void 0===e||e,this._renderStatesMap.has(t)||this._renderStatesMap.set(t,new Le(this._sceneData,this._lightData));var n=this._renderStatesMap.get(t);return e&&this._sceneData.update(this),n.updateCamera(t),n},n.getRenderStates=function(t){return this._renderStatesMap.get(t)},n.updateRenderQueue=function(t,e,n){e=void 0===e||e,n=void 0===n||n,this._renderQueueMap.has(t)||this._renderQueueMap.set(t,new ye);var i=this._renderQueueMap.get(t);if(n&&this._skeletons.clear(),i.begin(),e?(this._lightData.begin(),this._doPushObject(this,t,i,n),this._lightData.end(this._sceneData)):this._doPushMesh(this,t,i,n),i.end(),n)for(var r,a=c(this._skeletons);!(r=a()).done;){r.value.updateBones(this._sceneData)}return i},n.getRenderQueue=function(t){return this._renderQueueMap.get(t)},n._doPushMesh=function(t,e,n,i){if(t.visible){t.geometry&&t.material&&t.renderable&&(n.push(t,e),i&&t.skeleton&&this._skeletons.add(t.skeleton));for(var r=t.children,a=0,o=r.length;a<o;a++)this._doPushMesh(r[a],e,n,i)}},n._doPushObject=function(t,e,n,i){if(t.visible){t.geometry&&t.material&&t.renderable?(n.push(t,e),i&&t.skeleton&&this._skeletons.add(t.skeleton)):t.isLight&&this._lightData.push(t);for(var r=t.children,a=0,o=r.length;a<o;a++)this._doPushObject(r[a],e,n,i)}},e}(re);Ce.prototype.isScene=!0;var De=function(t){function e(){var e;return(e=t.call(this)||this).viewMatrix=new m,e.projectionMatrix=new m,e.projectionMatrixInverse=new m,e.projectionViewMatrix=new m,e.frustum=new Lt,e.gammaFactor=2,e.outputEncoding=H.LINEAR,e.rect=new Yt(0,0,1,1),e.frustumCulled=!0,e}i(e,t);var n=e.prototype;return n.lookAt=function(t,e){Oe.lookAtRH(this.position,t,e),this.quaternion.setFromRotationMatrix(Oe)},n.setOrtho=function(t,e,n,i,r,a){this.projectionMatrix.set(2/(e-t),0,0,-(e+t)/(e-t),0,2/(i-n),0,-(i+n)/(i-n),0,0,-2/(a-r),-(a+r)/(a-r),0,0,0,1),this.projectionMatrixInverse.getInverse(this.projectionMatrix)},n.setPerspective=function(t,e,n,i){this.projectionMatrix.set(1/(e*Math.tan(t/2)),0,0,0,0,1/Math.tan(t/2),0,0,0,0,-(i+n)/(i-n),-2*i*n/(i-n),0,0,-1,0),this.projectionMatrixInverse.getInverse(this.projectionMatrix)},n.getWorldDirection=function(t){void 0===t&&(t=new _);var e=this.worldMatrix.elements;return t.set(-e[8],-e[9],-e[10]).normalize()},n.updateMatrix=function(t){re.prototype.updateMatrix.call(this,t),this.viewMatrix.getInverse(this.worldMatrix),this.projectionViewMatrix.multiplyMatrices(this.projectionMatrix,this.viewMatrix),this.frustum.setFromMatrix(this.projectionViewMatrix)},n.copy=function(t,e){return re.prototype.copy.call(this,t,e),this.viewMatrix.copy(t.viewMatrix),this.projectionMatrix.copy(t.projectionMatrix),this.projectionMatrixInverse.copy(t.projectionMatrixInverse),this.frustum.copy(t.frustum),this.gammaFactor=t.gammaFactor,this.outputEncoding=t.outputEncoding,this.rect.copy(t.rect),this.frustumCulled=t.frustumCulled,this},e}(re);De.prototype.isCamera=!0;var Oe=new m,Fe=new zt,Ie=new m,Ue=new Ut,Be=new _,Ge=new _,ze=new _,He=new _,Ve=new _,ke=new _,Xe=new _,We=new _,je=new _,Ye=new _,qe=new _,Qe=new Yt,Ze=new Yt,Ke=new _,Je=new m,$e=new pt,tn=new pt,en=new pt,nn=new _,rn=new _,an=function(t){function e(e,n){var i;return(i=t.call(this)||this).geometry=e,i.material=n,i.morphTargetInfluences=null,i}i(e,t);var n=e.prototype;return n.raycast=function(t,e){var n=this.geometry,i=this.worldMatrix;if(Fe.copy(n.boundingSphere),Fe.applyMatrix4(i),t.intersectsSphere(Fe)&&(Ie.getInverse(i),Ue.copy(t).applyMatrix4(Ie),Ue.intersectsBox(n.boundingBox))){var r,a=n.getAttribute("a_Position"),o=n.getAttribute("a_Uv"),s=n.morphAttributes.position;if(n.index)for(var u=n.index.buffer.array,l=0;l<u.length;l+=3){var c=u[l],h=u[l+1],d=u[l+2];(r=on(this,t,Ue,a,s,o,c,h,d))&&(r.faceIndex=Math.floor(l/3),e.push(r))}else for(var f=0;f<a.buffer.count;f+=3){(r=on(this,t,Ue,a,s,o,f,f+1,f+2))&&(r.faceIndex=Math.floor(f/3),e.push(r))}}},n.copy=function(e){return t.prototype.copy.call(this,e),e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),this},n.clone=function(){return new this.constructor(this.geometry,this.material).copy(this)},e}(re);function on(t,e,n,i,r,a,o,s,u){var l,c,h;l=i.buffer.array,c=i.buffer.stride,h=i.offset,Ge.fromArray(l,o*c+h),ze.fromArray(l,s*c+h),He.fromArray(l,u*c+h);var d=t.morphTargetInfluences;if(r&&d){We.set(0,0,0),je.set(0,0,0),Ye.set(0,0,0);for(var f=0;f<r.length;f++){var p=d[f],v=r[f];0!==p&&(l=v.buffer.array,c=v.buffer.stride,h=v.offset,Ve.fromArray(l,o*c+h),ke.fromArray(l,s*c+h),Xe.fromArray(l,u*c+h),We.addScaledVector(Ve,p),je.addScaledVector(ke,p),Ye.addScaledVector(Xe,p))}Ge.add(We),ze.add(je),He.add(Ye)}t.isSkinnedMesh&&(sn(t,o,Ge),sn(t,s,ze),sn(t,u,He));var m,g,E,S,M,T,y,x=function(t,e,n,i,r,a,o){var s,u=t.material;s=u.side===C.BACK?n.intersectTriangle(a,r,i,!0,o):n.intersectTriangle(i,r,a,u.side!==C.DOUBLE,o);if(null===s)return null;rn.copy(o),rn.applyMatrix4(t.worldMatrix);var l=e.origin.distanceTo(rn);return{distance:l,point:rn.clone(),object:t}}(t,e,n,Ge,ze,He,nn);if(x){a&&(l=a.buffer.array,c=a.buffer.stride,h=a.offset,$e.fromArray(a.buffer.array,o*c+h),tn.fromArray(a.buffer.array,s*c+h),en.fromArray(a.buffer.array,u*c+h),x.uv=(m=nn,g=Ge,E=ze,S=He,M=$e,T=tn,y=en,jt.barycoordFromPoint(m,g,E,S,Be),M.multiplyScalar(Be.x),T.multiplyScalar(Be.y),y.multiplyScalar(Be.z),M.add(T).add(y),M.clone()));var w={a:o,b:s,c:u,normal:new _};jt.normal(Ge,ze,He,w.normal),x.face=w}return x}function sn(t,e,n){var i=t.skeleton,r=t.geometry.attributes.skinIndex,a=t.geometry.attributes.skinWeight;Qe.fromArray(r.buffer.array,e*r.size),Ze.fromArray(a.buffer.array,e*a.size),qe.copy(n).applyMatrix4(t.bindMatrix),n.set(0,0,0);for(var o=0;o<4;o++){var s=un(Ze,o);if(0!==s){var u=un(Qe,o);Je.multiplyMatrices(i.bones[u].worldMatrix,i.boneInverses[u]),n.addScaledVector(Ke.copy(qe).applyMatrix4(Je),s)}}return n.applyMatrix4(t.bindMatrixInverse)}function un(t,e){switch(e){case 0:return t.x;case 1:return t.y;case 2:return t.z;case 3:return t.w;default:throw new Error("index is out of range: "+e)}}an.prototype.isMesh=!0;var ln=function(){function t(t,e,n,i){void 0===e&&(e=t.stride),void 0===n&&(n=0),void 0===i&&(i=!1),this.buffer=t,this.size=e,this.offset=n,this.normalized=i,this.divisor=0}var e=t.prototype;return e.copy=function(t){return this.buffer=t.buffer,this.size=t.size,this.offset=t.offset,this.normalized=t.normalized,this.divisor=t.divisor,this},e.clone=function(e){var n;return e?(e.has(this.buffer)||e.set(this.buffer,this.buffer.clone()),(n=new t(e.get(this.buffer),this.size,this.offset,this.normalized)).divisor=this.divisor,n):(console.warn("t3d.Attribute.clone(): now requires a WeakMap as an argument to save shared buffers."),(n=new t(this.buffer.clone(),this.size,this.offset,this.normalized)).divisor=this.divisor,n)},t}(),cn=function(){function t(t,e){this.array=t,this.stride=e,this.count=void 0!==t?t.length/e:0,this.usage=j.STATIC_DRAW,this.updateRange={offset:0,count:-1},this.version=0}var e=t.prototype;return e.onUploadCallback=function(){},e.copy=function(t){return this.array=new t.array.constructor(t.array),this.stride=t.stride,this.count=t.array.length/this.stride,this.usage=t.usage,this},e.clone=function(){var e=new t(new this.array.constructor(this.array),this.stride);return e.usage=this.usage,e},t}(),hn=0,dn=new _,fn=new _,pn=new _,_n=new mt,vn=new mt,mn=function(t){function e(){var e;return(e=t.call(this)||this).id=hn++,e.uuid=Zt(),e.attributes={},e.morphAttributes={},e.index=null,e.boundingBox=new mt,e.boundingSphere=new zt,e.groups=[],e.instanceCount=-1,e.version=0,e}i(e,t);var n=e.prototype;return n.addAttribute=function(t,e){this.attributes[t]=e},n.getAttribute=function(t){return this.attributes[t]},n.removeAttribute=function(t){delete this.attributes[t]},n.setIndex=function(t){if(Array.isArray(t)){var e=new(function(t){if(0===t.length)return-1/0;for(var e=t[0],n=1,i=t.length;n<i;++n)t[n]>e&&(e=t[n]);return e}(t)>65535?Uint32Array:Uint16Array)(t);this.index=new ln(new cn(e,1))}else this.index=t},n.addGroup=function(t,e,n){void 0===n&&(n=0),this.groups.push({start:t,count:e,materialIndex:n})},n.clearGroups=function(){this.groups=[]},n.computeBoundingBox=function(){var t=this.attributes.a_Position||this.attributes.position,e=this.morphAttributes.position;if(this.boundingBox.setFromArray(t.buffer.array,t.buffer.stride,t.offset),e)for(var n=0;n<e.length;n++){var i=e[n];_n.setFromArray(i.buffer.array,i.buffer.stride,i.offset),dn.addVectors(this.boundingBox.min,_n.min),this.boundingBox.expandByPoint(dn),dn.addVectors(this.boundingBox.max,_n.max),this.boundingBox.expandByPoint(dn)}},n.computeBoundingSphere=function(){var t=this.attributes.a_Position||this.attributes.position,e=this.morphAttributes.position;if(e){_n.setFromArray(t.buffer.array,t.buffer.stride,t.offset);for(var n=0;n<e.length;n++){var i=e[n];vn.setFromArray(i.buffer.array,i.buffer.stride,i.offset),dn.addVectors(_n.min,vn.min),_n.expandByPoint(dn),dn.addVectors(_n.max,vn.max),_n.expandByPoint(dn)}var r=this.boundingSphere.center;_n.getCenter(r);for(var a=0,o=0;o<t.buffer.count;o++){fn.fromArray(t.buffer.array,3*o),a=r.distanceToSquared(fn);for(var s=0;s<e.length;s++){var u=e[s];dn.fromArray(u.buffer.array,3*o),pn.addVectors(fn,dn);var l=r.distanceToSquared(pn);l>a&&(a=l,fn.add(dn))}}this.boundingSphere.radius=Math.sqrt(a)}else this.boundingSphere.setFromArray(t.buffer.array,t.buffer.stride,t.offset)},n.dispose=function(){this.dispatchEvent({type:"dispose"})},n.copy=function(t){var e,n,i;this.index=null,this.attributes={},this.morphAttributes={},this.groups=[];var r=new WeakMap,a=t.index;null!==a&&this.setIndex(a.clone(r));var o=t.attributes;for(e in o){var s=o[e];this.addAttribute(e,s.clone(r))}var u=t.morphAttributes;for(e in u){var l=[],c=u[e];for(n=0,i=c.length;n<i;n++)l.push(c[n].clone(r));this.morphAttributes[e]=l}var h=t.groups;for(n=0,i=h.length;n<i;n++){var d=h[n];this.addGroup(d.start,d.count,d.materialIndex)}return this.boundingBox.copy(t.boundingBox),this.boundingSphere.copy(t.boundingSphere),this.instanceCount=t.instanceCount,this},n.clone=function(){return(new e).copy(this)},e}(q);var gn=function(t){function e(e,n,i,r){var a;void 0===e&&(e=1),void 0===n&&(n=1),void 0===i&&(i=1),void 0===r&&(r=1),a=t.call(this)||this;var o,s,u=e/2,l=n/2,c=Math.floor(i),h=Math.floor(r),d=c+1,f=h+1,p=e/c,_=n/h,v=[],m=[],g=[],E=[];for(s=0;s<f;s++){var S=s*_-l;for(o=0;o<d;o++){var M=o*p-u;m.push(M,0,S),g.push(0,1,0),E.push(o/c),E.push(1-s/h)}}for(s=0;s<h;s++)for(o=0;o<c;o++){var T=o+d*s,y=o+d*(s+1),x=o+1+d*(s+1),w=o+1+d*s;v.push(T,y,w),v.push(y,x,w)}return a.setIndex(new ln(new cn(m.length/3>65536?new Uint32Array(v):new Uint16Array(v),1))),a.addAttribute("a_Position",new ln(new cn(new Float32Array(m),3))),a.addAttribute("a_Normal",new ln(new cn(new Float32Array(g),3))),a.addAttribute("a_Uv",new ln(new cn(new Float32Array(E),2))),a.computeBoundingBox(),a.computeBoundingSphere(),a}return i(e,t),e}(mn),En=0,Sn=function(t){function e(){var e;return(e=t.call(this)||this).id=En++,e.uuid=Zt(),e.type=b.SHADER,e.shaderName="",e.defines={},e.uniforms={},e.vertexShader="",e.fragmentShader="",e.precision=null,e.transparent=!1,e.blending=R.NORMAL,e.blendSrc=P.SRC_ALPHA,e.blendDst=P.ONE_MINUS_SRC_ALPHA,e.blendEquation=N.ADD,e.blendSrcAlpha=null,e.blendDstAlpha=null,e.blendEquationAlpha=null,e.premultipliedAlpha=!1,e.vertexColors=X.NONE,e.vertexTangents=!1,e.opacity=1,e.diffuse=new gt(16777215),e.diffuseMap=null,e.diffuseMapCoord=0,e.diffuseMapTransform=new At,e.alphaMap=null,e.alphaMapCoord=0,e.alphaMapTransform=new At,e.emissive=new gt(0),e.emissiveMap=null,e.emissiveMapCoord=0,e.emissiveMapTransform=new At,e.aoMap=null,e.aoMapIntensity=1,e.aoMapCoord=0,e.aoMapTransform=new At,e.normalMap=null,e.normalScale=new pt(1,1),e.bumpMap=null,e.bumpScale=1,e.envMap=null,e.envMapIntensity=1,e.envMapCombine=V.MULTIPLY,e.depthFunc=B.LEQUAL,e.depthTest=!0,e.depthWrite=!0,e.colorWrite=!0,e.stencilTest=!1,e.stencilWriteMask=255,e.stencilFunc=B.ALWAYS,e.stencilRef=0,e.stencilFuncMask=255,e.stencilFail=G.KEEP,e.stencilZFail=G.KEEP,e.stencilZPass=G.KEEP,e.stencilFuncBack=null,e.stencilRefBack=null,e.stencilFuncMaskBack=null,e.stencilFailBack=null,e.stencilZFailBack=null,e.stencilZPassBack=null,e.clippingPlanes=null,e.alphaTest=0,e.alphaToCoverage=!1,e.side=C.FRONT,e.polygonOffset=!1,e.polygonOffsetFactor=0,e.polygonOffsetUnits=0,e.shading=D.SMOOTH_SHADING,e.dithering=!1,e.acceptLight=!1,e.fog=!0,e.drawMode=k.TRIANGLES,e.needsUpdate=!0,e}i(e,t);var n=e.prototype;return n.copy=function(t){return this.shaderName=t.shaderName,this.defines=Object.assign({},t.defines),this.uniforms=te(t.uniforms),this.vertexShader=t.vertexShader,this.fragmentShader=t.fragmentShader,this.precision=t.precision,this.transparent=t.transparent,this.blending=t.blending,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendEquationAlpha=t.blendEquationAlpha,this.premultipliedAlpha=t.premultipliedAlpha,this.vertexColors=t.vertexColors,this.vertexTangents=t.vertexTangents,this.opacity=t.opacity,this.diffuse.copy(t.diffuse),this.diffuseMap=t.diffuseMap,this.diffuseMapCoord=t.diffuseMapCoord,this.diffuseMapTransform.copy(t.diffuseMapTransform),this.alphaMap=t.alphaMap,this.alphaMapCoord=t.alphaMapCoord,this.alphaMapTransform.copy(t.alphaMapTransform),this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveMapCoord=t.emissiveMapCoord,this.emissiveMapTransform.copy(t.emissiveMapTransform),this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.aoMapCoord=t.aoMapCoord,this.aoMapTransform.copy(t.aoMapTransform),this.normalMap=t.normalMap,this.normalScale.copy(t.normalScale),this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.envMap=t.envMap,this.envMapIntensity=t.envMapIntensity,this.envMapCombine=t.envMapCombine,this.depthFunc=t.depthFunc,this.depthTest=t.depthTest,this.depthWrite=t.depthWrite,this.colorWrite=t.colorWrite,this.stencilTest=t.stencilTest,this.stencilWriteMask=t.stencilWriteMask,this.stencilFunc=t.stencilFunc,this.stencilRef=t.stencilRef,this.stencilFuncMask=t.stencilFuncMask,this.stencilFail=t.stencilFail,this.stencilZFail=t.stencilZFail,this.stencilZPass=t.stencilZPass,this.stencilFuncBack=t.stencilFuncBack,this.stencilRefBack=t.stencilRefBack,this.stencilFuncMaskBack=t.stencilFuncMaskBack,this.stencilFailBack=t.stencilFailBack,this.stencilZFailBack=t.stencilZFailBack,this.stencilZPassBack=t.stencilZPassBack,this.clippingPlanes=t.clippingPlanes,this.alphaTest=t.alphaTest,this.alphaToCoverage=t.alphaToCoverage,this.side=t.side,this.polygonOffset=t.polygonOffset,this.polygonOffsetFactor=t.polygonOffsetFactor,this.polygonOffsetUnits=t.polygonOffsetUnits,this.shading=t.shading,this.dithering=t.dithering,this.acceptLight=t.acceptLight,this.fog=t.fog,this.drawMode=t.drawMode,this},n.clone=function(){return(new this.constructor).copy(this)},n.dispose=function(){this.dispatchEvent({type:"dispose"})},e}(q),Mn=function(t){function e(e){var n;return n=t.call(this)||this,e&&(n.shaderName=e.name,Object.assign(n.defines,e.defines),n.uniforms=te(e.uniforms),n.vertexShader=e.vertexShader,n.fragmentShader=e.fragmentShader),n}return i(e,t),e}(Sn),Tn=function(){function t(t){var e=new Ce,n=this.camera=new De;n.frustumCulled=!1,n.position.set(0,1,0),n.lookAt(new _(0,0,0),new _(0,0,-1)),n.setOrtho(-1,1,-1,1,.1,2),e.add(n);var i=this.geometry=new gn(2,2,1,1),r=this.material=new Mn(t);this.uniforms=r.uniforms;var a=new an(i,r);a.frustumCulled=!1,e.add(a),e.updateMatrix(),this.renderStates=e.updateRenderStates(n);var o=e.updateRenderQueue(n,!1,!1);this.renderQueueLayer=o.layerList[0],this.renderConfig={}}var e=t.prototype;return e.render=function(t){t.renderRenderableList(this.renderQueueLayer.opaque,this.renderStates,this.renderConfig)},e.dispose=function(){this.geometry.dispose(),this.material.dispose()},t}(),yn=function(t){function e(){var e;return(e=t.call(this)||this).type=b.DEPTH,e.packToRGBA=!1,e}return i(e,t),e}(Sn),xn=function(t){function e(){var e;return(e=t.call(this)||this).type=b.DISTANCE,e}return i(e,t),e}(Sn),wn=function(){function t(){this.getDepthMaterial=Pn,this.getDistanceMaterial=Ln,this.shadowLayers=null,this.transparentShadow=!1;var t={isPointLight:!1,light:null};this._state=t;var e=this;this._renderOptions={getGeometry:null,getMaterial:function(n){return t.isPointLight?e.getDistanceMaterial(n,t.light):e.getDepthMaterial(n,t.light)},ifRender:function(t){return t.object.castShadow}}}return t.prototype.render=function(t,e){var n=t.renderPass;An.copy(n.getClearColor()),n.setClearColor(1,1,1,1);for(var i=e._lightData.lights,r=e._lightData.shadowsNum,a=0;a<r;a++){var o=i[a],s=o.shadow;if(!1!==s.autoUpdate||!1!==s.needsUpdate){var u=s.camera,l=s.renderTarget,c=o.isPointLight,h=c?6:1;this._state.isPointLight=c,this._state.light=o;var d=this._renderOptions;s.prepareDepthMap(!e.disableShadowSampler,n.capabilities);for(var f=0;f<h;f++){c&&(s.update(o,f),l.activeCubeFace=f),n.setRenderTarget(l),n.clear(!0,!0);for(var p=e.updateRenderStates(u,0===f),_=e.updateRenderQueue(u,!1,!1),v=0;v<_.layerList.length;v++){var m=_.layerList[v];null!==this.shadowLayers&&-1===this.shadowLayers.indexOf(m.id)||(t.renderRenderableList(m.opaque,p,d),this.transparentShadow&&t.renderRenderableList(m.transparent,p,d))}}s.needsUpdate=!1}}n.setClearColor(An.x,An.y,An.z,An.w)},n(t,[{key:"getGeometry",get:function(){return this._renderOptions.getGeometry},set:function(t){t?this._renderOptions.getGeometry=t:delete this._renderOptions.getGeometry}},{key:"ifRender",get:function(){return this._renderOptions.ifRender},set:function(t){t?this._renderOptions.ifRender=t:delete this._renderOptions.ifRender}}]),t}(),An=new Yt,bn={front:C.BACK,back:C.FRONT,double:C.DOUBLE},Rn={},Nn={};function Pn(t,e){var n=!!t.object.skeleton,i=t.geometry.morphAttributes.position&&t.geometry.morphAttributes.position.length>0,r=t.material.clippingPlanes,a=r&&r.length>0?r.length:0,o=i<<0|n<<1,s=Rn[o];void 0===s&&(s={},Rn[o]=s);var u=s[a];return void 0===u&&((u=new yn).packToRGBA=!0,s[a]=u),u.side=bn[t.material.side],u.clippingPlanes=t.material.clippingPlanes,u.drawMode=t.material.drawMode,u}function Ln(t,e){var n=!!t.object.skeleton,i=t.geometry.morphAttributes.position&&t.geometry.morphAttributes.position.length>0,r=t.material.clippingPlanes,a=r&&r.length>0?r.length:0,o=i<<0|n<<1,s=Nn[o];void 0===s&&(s={},Nn[o]=s);var u=s[a];return void 0===u&&(u=new xn,s[a]=u),u.side=bn[t.material.side],u.uniforms.nearDistance=e.shadow.cameraNear,u.uniforms.farDistance=e.shadow.cameraFar,u.clippingPlanes=t.material.clippingPlanes,u.drawMode=t.material.drawMode,u}var Cn=0,Dn=function(t){function e(){var e;return(e=t.call(this)||this).id=Cn++,e.mipmaps=[],e.border=0,e.format=O.RGBA,e.internalformat=null,e.type=F.UNSIGNED_BYTE,e.magFilter=I.LINEAR,e.minFilter=I.LINEAR_MIPMAP_LINEAR,e.wrapS=U.CLAMP_TO_EDGE,e.wrapT=U.CLAMP_TO_EDGE,e.anisotropy=1,e.compare=void 0,e.generateMipmaps=!0,e.encoding=H.LINEAR,e.flipY=!0,e.premultiplyAlpha=!1,e.unpackAlignment=4,e.version=0,e}i(e,t);var n=e.prototype;return n.clone=function(){return(new this.constructor).copy(this)},n.copy=function(t){return this.mipmaps=t.mipmaps.slice(0),this.border=t.border,this.format=t.format,this.internalformat=t.internalformat,this.type=t.type,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.anisotropy=t.anisotropy,this.compare=t.compare,this.generateMipmaps=t.generateMipmaps,this.encoding=t.encoding,this.flipY=t.flipY,this.premultiplyAlpha=t.premultiplyAlpha,this.unpackAlignment=t.unpackAlignment,this.version=t.version,this},n.dispose=function(){this.dispatchEvent({type:"dispose"}),this.version=0},e}(q);Dn.prototype.isTexture=!0;var On=function(t){function e(){var e;return(e=t.call(this)||this).image=null,e}return i(e,t),e.prototype.copy=function(e){return t.prototype.copy.call(this,e),this.image=e.image,this},e}(Dn);On.prototype.isTexture2D=!0;var Fn=function(t){function e(){var e;return(e=t.call(this)||this).images=[],e.flipY=!1,e}return i(e,t),e.prototype.copy=function(e){return t.prototype.copy.call(this,e),this.images=e.images.slice(0),this},e}(Dn);Fn.prototype.isTextureCube=!0;var In=function(t){function e(){var e;return(e=t.call(this)||this).image={data:new Uint8Array([255,255,255,255,255,255,255,255]),width:2,height:2,depth:2},e.wrapR=U.CLAMP_TO_EDGE,e.format=O.RED,e.type=F.UNSIGNED_BYTE,e.magFilter=I.NEAREST,e.minFilter=I.NEAREST,e.generateMipmaps=!1,e.flipY=!1,e.unpackAlignment=1,e}return i(e,t),e.prototype.copy=function(e){return t.prototype.copy.call(this,e),this.image=e.image,this},e}(Dn);In.prototype.isTexture3D=!0;var Un={u_Model:[1,null],u_Projection:[2,function(t){this.set(t.projectionMatrix.elements)}],u_View:[2,function(t){this.set(t.viewMatrix.elements)}],u_ProjectionView:[2,function(t){this.set(t.projectionViewMatrix.elements)}],u_CameraPosition:[2,function(t){this.setValue(t.position.x,t.position.y,t.position.z)}],logDepthBufFC:[2,function(t){this.set(t.logDepthBufFC)}],logDepthCameraNear:[2,function(t){this.set(t.logDepthCameraNear)}],u_EnvMapLight_Intensity:[3,function(t){this.set(t.environmentLightIntensity)}],u_FogColor:[3,function(t){var e=t.fog.color;this.setValue(e.r,e.g,e.b)}],u_FogDensity:[3,function(t){this.set(t.fog.density)}],u_FogNear:[3,function(t){this.set(t.fog.near)}],u_FogFar:[3,function(t){this.set(t.fog.far)}],u_Color:[4,function(t,e){var n=t.diffuse;this.setValue(n.r,n.g,n.b)}],u_Opacity:[4,function(t,e){this.set(t.opacity)}],diffuseMap:[4,function(t,e){this.set(t.diffuseMap,e)}],alphaMap:[4,function(t,e){this.set(t.alphaMap,e)}],alphaMapUVTransform:[4,function(t,e){this.set(t.alphaMapTransform.elements)}],normalMap:[4,function(t,e){this.set(t.normalMap,e)}],normalScale:[4,function(t,e){this.setValue(t.normalScale.x,t.normalScale.y)}],bumpMap:[4,function(t,e){this.set(t.bumpMap,e)}],bumpScale:[4,function(t,e){this.set(t.bumpScale)}],cubeMap:[4,function(t,e){this.set(t.cubeMap,e)}],u_EnvMap_Intensity:[4,function(t,e){this.set(t.envMapIntensity)}],u_Specular:[4,function(t,e){this.set(t.shininess)}],u_SpecularColor:[4,function(t,e){var n=t.specular;this.setValue(n.r,n.g,n.b)}],specularMap:[4,function(t,e){this.set(t.specularMap,e)}],aoMap:[4,function(t,e){this.set(t.aoMap,e)}],aoMapIntensity:[4,function(t,e){this.set(t.aoMapIntensity)}],aoMapUVTransform:[4,function(t,e){this.set(t.aoMapTransform.elements)}],u_Roughness:[4,function(t,e){this.set(t.roughness)}],roughnessMap:[4,function(t,e){this.set(t.roughnessMap,e)}],u_Metalness:[4,function(t,e){this.set(t.metalness)}],metalnessMap:[4,function(t,e){this.set(t.metalnessMap,e)}],u_Clearcoat:[4,function(t,e){this.set(t.clearcoat)}],u_ClearcoatRoughness:[4,function(t,e){this.set(t.clearcoatRoughness)}],clearcoatMap:[4,function(t,e){this.set(t.clearcoatMap,e)}],clearcoatRoughnessMap:[4,function(t,e){this.set(t.clearcoatRoughnessMap,e)}],clearcoatNormalMap:[4,function(t,e){this.set(t.clearcoatNormalMap,e)}],clearcoatNormalScale:[4,function(t,e){this.setValue(t.clearcoatNormalScale.x,t.clearcoatNormalScale.y)}],glossiness:[4,function(t,e){this.set(t.glossiness)}],glossinessMap:[4,function(t,e){this.set(t.glossinessMap,e)}],emissive:[4,function(t,e){var n=t.emissive;this.setValue(n.r,n.g,n.b)}],emissiveMap:[4,function(t,e){this.set(t.emissiveMap,e)}],emissiveMapUVTransform:[4,function(t,e){this.set(t.emissiveMapTransform.elements)}],matcap:[4,function(t,e){this.set(t.matcap,e)}],uvTransform:[4,function(t,e){this.set(t.diffuseMapTransform.elements)}],u_PointSize:[4,function(t,e){this.set(t.size)}],u_PointScale:[5,null],maxMipLevel:[5,function(t,e){this.set(e.get(t).__maxMipLevel||8)}],envMap:[5,function(t,e){this.set(t,e)}],u_EnvMap_Flip:[5,function(t,e){this.set(t.images[0]&&t.images[0].rtt?1:-1)}]},Bn=new On;Bn.image={data:new Uint8Array([1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1]),width:2,height:2},Bn.magFilter=I.NEAREST,Bn.minFilter=I.NEAREST,Bn.generateMipmaps=!1,Bn.version++;var Gn=new On;Gn.image={data:null,width:2,height:2},Gn.version++,Gn.type=F.FLOAT_32_UNSIGNED_INT_24_8_REV,Gn.format=O.DEPTH_STENCIL,Gn.magFilter=I.NEAREST,Gn.minFilter=I.NEAREST,Gn.compare=B.LESS,Gn.generateMipmaps=!1,Gn.version++;var zn=new In,Hn=new Fn;function Vn(t,e){if(t.length!==e.length)return!1;for(var n=0,i=t.length;n<i;n++)if(t[n]!==e[n])return!1;return!0}function kn(t,e){for(var n=0,i=e.length;n<i;n++)t[n]=e[n]}var Xn=[];function Wn(t,e){var n=Xn[e];void 0===n&&(n=new Int32Array(e),Xn[e]=n);for(var i=0;i!==e;++i)n[i]=t.allocTexUnit();return n}function jn(t,e){var n=t.gl,i=t.type,r=t.location,a=t.cache;switch(i){case n.FLOAT:t.setValue=function(t){a[0]!==t&&(n.uniform1f(r,t),a[0]=t)},t.set=e?function(t){Vn(a,t)||(n.uniform1fv(r,t),kn(a,t))}:t.setValue;break;case n.SAMPLER_2D:case n.SAMPLER_2D_SHADOW:t.setValue=function(t,e){var o=e.allocTexUnit();e.setTexture2D(t||(i===n.SAMPLER_2D_SHADOW?Gn:Bn),o),a[0]!==o&&(n.uniform1i(r,o),a[0]=o)},t.set=e?function(t,e){for(var o=t.length,s=Wn(e,o),u=0;u!==o;++u)e.setTexture2D(t[u]||(i===n.SAMPLER_2D_SHADOW?Gn:Bn),s[u]);Vn(a,s)||(n.uniform1iv(r,s),kn(a,s))}:t.setValue;break;case n.SAMPLER_CUBE:case n.SAMPLER_CUBE_SHADOW:t.setValue=function(t,e){var i=e.allocTexUnit();e.setTextureCube(t||Hn,i),a[0]!==i&&(n.uniform1i(r,i),a[0]=i)},t.set=e?function(t,e){for(var i=t.length,o=Wn(e,i),s=0;s!==i;++s)e.setTextureCube(t[s]||Hn,o[s]);Vn(a,o)||(n.uniform1iv(r,o),kn(a,o))}:t.setValue;break;case n.SAMPLER_3D:t.setValue=function(t,e){var i=e.allocTexUnit();e.setTexture3D(t||zn,i),a[0]!==i&&(n.uniform1i(r,i),a[0]=i)},t.set=e?function(t,e){for(var i=t.length,o=Wn(e,i),s=0;s!==i;++s)e.setTexture3D(t[s]||zn,o[s]);Vn(a,o)||(n.uniform1iv(r,o),kn(a,o))}:t.setValue;break;case n.BOOL:case n.INT:t.setValue=function(t){a[0]!==t&&(n.uniform1i(r,t),a[0]=t)},t.set=e?function(t){Vn(a,t)||(n.uniform1iv(r,t),kn(a,t))}:t.setValue;break;case n.FLOAT_VEC2:t.setValue=function(t,e){a[0]===t&&a[1]===e||(n.uniform2f(r,t,e),a[0]=t,a[1]=e)},t.set=function(t){Vn(a,t)||(n.uniform2fv(r,t),kn(a,t))};break;case n.BOOL_VEC2:case n.INT_VEC2:t.setValue=function(t,e){a[0]===t&&a[1]===e||(n.uniform2i(r,t,e),a[0]=t,a[1]=e)},t.set=function(t){Vn(a,t)||(n.uniform2iv(r,t),kn(a,t))};break;case n.FLOAT_VEC3:t.setValue=function(t,e,i){a[0]===t&&a[1]===e&&a[2]===i||(n.uniform3f(r,t,e,i),a[0]=t,a[1]=e,a[2]=i)},t.set=function(t){Vn(a,t)||(n.uniform3fv(r,t),kn(a,t))};break;case n.BOOL_VEC3:case n.INT_VEC3:t.setValue=function(t,e,i){a[0]===t&&a[1]===e&&a[2]===i||(n.uniform3i(r,t,e,i),a[0]=t,a[1]=e,a[2]=i)},t.set=function(t){Vn(a,t)||(n.uniform3iv(r,t),kn(a,t))};break;case n.FLOAT_VEC4:t.setValue=function(t,e,i,o){a[0]===t&&a[1]===e&&a[2]===i&&a[3]===o||(n.uniform4f(r,t,e,i,o),a[0]=t,a[1]=e,a[2]=i,a[3]=o)},t.set=function(t){Vn(a,t)||(n.uniform4fv(r,t),kn(a,t))};break;case n.BOOL_VEC4:case n.INT_VEC4:t.setValue=function(t,e,i,o){a[0]===t&&a[1]===e&&a[2]===i&&a[3]===o||(n.uniform4i(r,t,e,i,o),a[0]=t,a[1]=e,a[2]=i,a[3]=o)},t.set=function(t){Vn(a,t)||(n.uniform4iv(r,t),kn(a,t))};break;case n.FLOAT_MAT2:t.setValue=t.set=e?function(t){Vn(a,t)||(n.uniformMatrix2fv(r,!1,t),kn(a,t))}:function(t){a[0]===t[0]&&a[1]===t[1]&&a[2]===t[2]&&a[3]===t[3]||(n.uniformMatrix2fv(r,!1,t),a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3])};break;case n.FLOAT_MAT3:t.setValue=t.set=e?function(t){Vn(a,t)||(n.uniformMatrix3fv(r,!1,t),kn(a,t))}:function(t){a[0]===t[0]&&a[1]===t[1]&&a[2]===t[2]&&a[3]===t[3]&&a[4]===t[4]&&a[5]===t[5]&&a[6]===t[6]&&a[7]===t[7]&&a[8]===t[8]||(n.uniformMatrix3fv(r,!1,t),a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8])};break;case n.FLOAT_MAT4:t.setValue=t.set=e?function(t){Vn(a,t)||(n.uniformMatrix4fv(r,!1,t),kn(a,t))}:function(t){a[0]===t[0]&&a[1]===t[1]&&a[2]===t[2]&&a[3]===t[3]&&a[4]===t[4]&&a[5]===t[5]&&a[6]===t[6]&&a[7]===t[7]&&a[8]===t[8]&&a[9]===t[9]&&a[10]===t[10]&&a[11]===t[11]&&a[12]===t[12]&&a[13]===t[13]&&a[14]===t[14]&&a[15]===t[15]||(n.uniformMatrix4fv(r,!1,t),a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8],a[9]=t[9],a[10]=t[10],a[11]=t[11],a[12]=t[12],a[13]=t[13],a[14]=t[14],a[15]=t[15])}}}var Yn=function(t,e,n,i){this.gl=t,this.id=e,this.type=n.type,this.location=i,this.setValue=void 0,this.set=void 0,this.cache=[],jn(this),this.internalGroup=0,this.internalFun=null;var r=Un[e];r&&(this.internalGroup=r[0],this.internalFun=r[1])},qn=function(t,e,n,i){this.gl=t,this.id=e,this.type=n.type,this.size=n.size,this.location=i,this.setValue=void 0,this.set=void 0,this.cache=[],jn(this,!0)},Qn=function(){this.seq=[],this.map={}},Zn=function(t){function e(e){var n;return(n=t.call(this)||this).id=e,n}return i(e,t),e.prototype.set=function(t,e){for(var n=this.seq,i=0,r=n.length;i!==r;++i){var a=n[i];a.set(t[a.id],e)}},e}(Qn),Kn=/(\w+)(\])?(\[|\.)?/g;function Jn(t,e){t.seq.push(e),t.map[e.id]=e}function $n(t,e,n,i){var r=e.name,a=r.length;for(Kn.lastIndex=0;;){var o=Kn.exec(r),s=Kn.lastIndex,u=o[1],l="]"===o[2],c=o[3];if(l&&(u|=0),void 0===c||"["===c&&s+2===a){Jn(i,void 0===c?new Yn(t,u,e,n):new qn(t,u,e,n));break}var h=i.map[u];void 0===h&&Jn(i,h=new Zn(u)),i=h}}var ti=function(t){function e(e,n){var i;i=t.call(this)||this;for(var r=e.getProgramParameter(n,e.ACTIVE_UNIFORMS),a=0;a<r;++a){var o=e.getActiveUniform(n,a),s=e.getUniformLocation(n,o.name);$n(e,o,s,u(i))}return i}i(e,t);var n=e.prototype;return n.set=function(t,e,n){var i=this.map[t];void 0!==i&&i.set(e,n)},n.has=function(t){return!!this.map[t]},e}(Qn),ei=function(t,e,n){this.gl=t,this.name=n.name,this.type=n.type,this.size=n.size,this.location=t.getAttribLocation(e,this.name),this.count=function(t,e){switch(e){case t.FLOAT:case t.BYTE:case t.UNSIGNED_BYTE:case t.UNSIGNED_SHORT:return 1;case t.FLOAT_VEC2:return 2;case t.FLOAT_VEC3:return 3;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 4;case t.FLOAT_MAT3:return 9;case t.FLOAT_MAT4:return 16;default:return 0}}(t,this.type),this.format=function(t,e){switch(e){case t.FLOAT:case t.FLOAT_VEC2:case t.FLOAT_VEC3:case t.FLOAT_VEC4:case t.FLOAT_MAT2:case t.FLOAT_MAT3:case t.FLOAT_MAT4:return t.FLOAT;case t.UNSIGNED_BYTE:return t.UNSIGNED_BYTE;case t.UNSIGNED_SHORT:return t.UNSIGNED_SHORT;case t.BYTE:return t.BYTE;default:return t.FLOAT}}(t,this.type),this.locationSize=1,this.type===t.FLOAT_MAT2&&(this.locationSize=2),this.type===t.FLOAT_MAT3&&(this.locationSize=3),this.type===t.FLOAT_MAT4&&(this.locationSize=4)};var ni=0,ii=function(t,e,n){var i,r,a;this.gl=t,this.vshaderSource=e,this.fshaderSource=n,this.id=ni++,this.usedTimes=1,this.code="",this.lightId=-1,this.lightVersion=-1,this.cameraId=-1,this.cameraVersion=-1,this.sceneId=-1,this.sceneVersion=-1,this.program,this.compile=function(r){var a=ri(t,t.VERTEX_SHADER,e),o=ri(t,t.FRAGMENT_SHADER,n);if(i=t.createProgram(),t.attachShader(i,a),t.attachShader(i,o),t.linkProgram(i),r&&!1===t.getProgramParameter(i,t.LINK_STATUS)){var s=t.getProgramInfoLog(i).trim(),u=ai(t,a,"VERTEX"),l=ai(t,o,"FRAGMENT");console.error("Shader Error "+t.getError()+" - VALIDATE_STATUS "+t.getProgramParameter(i,t.VALIDATE_STATUS)+"\n\nProgram Info Log: "+s+"\n"+u+"\n"+l)}else this.program=i;t.deleteShader(a),t.deleteShader(o)},this.getUniforms=function(){return void 0===r&&(r=new ti(t,i)),r},this.getAttributes=function(){return void 0===a&&(a=function(t,e){for(var n={},i=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES),r=0;r<i;r++){var a=t.getActiveAttrib(e,r);n[a.name]=new ei(t,e,a)}return n}(t,i)),a},this.dispose=function(){t.deleteProgram(i),this.program=void 0}};function ri(t,e,n){var i=t.createShader(e);return t.shaderSource(i,n),t.compileShader(i),i}function ai(t,e,n){var i=t.getShaderParameter(e,t.COMPILE_STATUS),r=t.getShaderInfoLog(e).trim();if(i&&""===r)return"";var a=/ERROR: 0:(\d+)/.exec(r);if(a){var o=parseInt(a[1]);return n+"\n\n"+r+"\n\n"+function(t,e){for(var n=t.split("\n"),i=[],r=Math.max(e-6,0),a=Math.min(e+6,n.length),o=r;o<a;o++){var s=o+1;i.push((s===e?">":" ")+" "+s+": "+n[o])}return i.join("\n")}(t.getShaderSource(e),o)}return r}var oi={alphaTest_frag:"#ifdef ALPHATEST\n\tif ( outColor.a < ALPHATEST ) {\n\t\tdiscard;\n\t} else {\n\t\toutColor.a = u_Opacity;\n\t}\n#endif",aoMap_pars_frag:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n\tvarying vec2 vAOMapUV;\n#endif",aoMap_pars_vert:"#ifdef USE_AOMAP\n\tuniform mat3 aoMapUVTransform;\n\tvarying vec2 vAOMapUV;\n#endif",aoMap_vert:"#ifdef USE_AOMAP\n\t#if (USE_AOMAP == 2)\n\t\t\t\tvAOMapUV = (aoMapUVTransform * vec3(a_Uv2, 1.)).xy;\n\t\t#else\n\t\t\t\tvAOMapUV = (aoMapUVTransform * vec3(a_Uv, 1.)).xy;\n\t\t#endif\n#endif",aoMap_frag:"\n#ifdef USE_AOMAP\n\t\tfloat ambientOcclusion = (texture2D(aoMap, vAOMapUV).r - 1.0) * aoMapIntensity + 1.0;\n\t\t\n\t\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t\t#if defined(USE_ENV_MAP) && defined(USE_PBR)\n\t\t\t\tfloat dotNV = saturate(dot(N, V));\n\t\t\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion(dotNV, ambientOcclusion, GGXRoughnessToBlinnExponent(roughness));\n\t\t#endif\n#endif",begin_frag:"vec4 outColor = vec4(u_Color, u_Opacity);",begin_vert:"vec3 transformed = vec3(a_Position);\nvec3 objectNormal = vec3(a_Normal);\n#ifdef USE_TANGENT\n\t\tvec3 objectTangent = vec3(a_Tangent.xyz);\n#endif",bsdfs:"vec2 integrateSpecularBRDF( const in float dotNV, const in float roughness ) {\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\treturn vec2( -1.04, 1.04 ) * a004 + r.zw;\n}\nvec3 BRDF_Diffuse_Lambert(vec3 diffuseColor) {\n\t\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\n\treturn ( 1.0 - specularColor ) * fresnel + specularColor;\n}\nvec3 F_Schlick_RoughnessDependent(const in vec3 F0, const in float dotNV, const in float roughness) {\n\tfloat fresnel = exp2( ( -5.55473 * dotNV - 6.98316 ) * dotNV );\n\tvec3 Fr = max( vec3( 1.0 - roughness ), F0 ) - F0;\n\treturn Fr * fresnel + F0;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nfloat G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nvec3 BRDF_Specular_BlinnPhong(vec3 specularColor, vec3 N, vec3 L, vec3 V, float shininess) {\n\t\tvec3 H = normalize(L + V);\n\t\tfloat dotNH = saturate(dot(N, H));\n\t\tfloat dotLH = saturate(dot(L, H));\n\t\tvec3 F = F_Schlick(specularColor, dotLH);\n\t\tfloat G = G_BlinnPhong_Implicit( );\n\t\tfloat D = D_BlinnPhong(shininess, dotNH);\n\t\treturn F * G * D;\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\nfloat G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\tfloat gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\treturn 1.0 / ( gl * gv );\n}\nfloat G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nvec3 BRDF_Specular_GGX(vec3 specularColor, vec3 N, vec3 L, vec3 V, float roughness) {\n\tfloat alpha = pow2( roughness );\n\tvec3 H = normalize(L + V);\n\tfloat dotNL = saturate( dot(N, L) );\n\tfloat dotNV = saturate( dot(N, V) );\n\tfloat dotNH = saturate( dot(N, H) );\n\tfloat dotLH = saturate( dot(L, H) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\tfloat D = D_GGX( alpha, dotNH );\n\treturn F * G * D;\n}\nvec3 BRDF_Specular_GGX_Environment(const in vec3 N, const in vec3 V, const in vec3 specularColor, const in float roughness) {\n\tfloat dotNV = saturate(dot(N, V));\n\tvec2 brdf = integrateSpecularBRDF(dotNV, roughness);\n\treturn specularColor * brdf.x + brdf.y;\n}\nvoid BRDF_Specular_Multiscattering_Environment(const in vec3 N, const in vec3 V, const in vec3 specularColor, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter) {\n\tfloat dotNV = saturate(dot(N, V));\n\tvec3 F = F_Schlick_RoughnessDependent(specularColor, dotNV, roughness);\n\tvec2 brdf = integrateSpecularBRDF(dotNV, roughness);\n\tvec3 FssEss = F * brdf.x + brdf.y;\n\tfloat Ess = brdf.x + brdf.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = specularColor + (1.0 - specularColor) * 0.047619;\tvec3 Fms = FssEss * Favg / (1.0 - Ems * Favg);\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\nfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\n\treturn ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );\n}\nfloat BlinnExponentToGGXRoughness( const in float blinnExponent ) {\n\treturn sqrt( 2.0 / ( blinnExponent + 2.0 ) );\n}",bumpMap_pars_frag:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd(vec2 uv) {\n\t\tvec2 dSTdx = dFdx( uv );\n\t\tvec2 dSTdy = dFdy( uv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, uv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, uv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, uv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy) {\n\t\tvec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );\n\t\tvec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 );\n\t\tfDet *= ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clippingPlanes_frag:"\n#if NUM_CLIPPING_PLANES > 0\n\t\tvec4 plane;\n\t\t#pragma unroll_loop_start\n\t\tfor (int i = 0; i < NUM_CLIPPING_PLANES; i++) {\n\t\t\t\tplane = clippingPlanes[i];\n\t\t\t\tif ( dot( -v_modelPos, plane.xyz ) > plane.w ) discard;\n\t\t}\n\t\t#pragma unroll_loop_end\n#endif",clippingPlanes_pars_frag:"#if NUM_CLIPPING_PLANES > 0\n\t\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",color_frag:"#ifdef USE_VCOLOR_RGB\n\t\toutColor.rgb *= v_Color;\n#endif\n#ifdef USE_VCOLOR_RGBA\n\t\toutColor *= v_Color;\n#endif",color_pars_frag:"#ifdef USE_VCOLOR_RGB\n\t\tvarying vec3 v_Color;\n#endif\n#ifdef USE_VCOLOR_RGBA\n\t\tvarying vec4 v_Color;\n#endif",color_pars_vert:"#ifdef USE_VCOLOR_RGB\n\t\tattribute vec3 a_Color;\n\t\tvarying vec3 v_Color;\n#endif\n#ifdef USE_VCOLOR_RGBA\n\t\tattribute vec4 a_Color;\n\t\tvarying vec4 v_Color;\n#endif",color_vert:"#if defined(USE_VCOLOR_RGB) || defined(USE_VCOLOR_RGBA)\n\t\tv_Color = a_Color;\n#endif",common_frag:"uniform mat4 u_View;\nuniform float u_Opacity;\nuniform vec3 u_Color;\nuniform vec3 u_CameraPosition;\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};",common_vert:"attribute vec3 a_Position;\nattribute vec3 a_Normal;\n#ifdef USE_TANGENT\n\tattribute vec4 a_Tangent;\n#endif\n#include <transpose>\n#include <inverse>\nuniform mat4 u_Projection;\nuniform mat4 u_View;\nuniform mat4 u_Model;\nuniform mat4 u_ProjectionView;\nuniform vec3 u_CameraPosition;\n#define EPSILON 1e-6\n#ifdef USE_MORPHTARGETS\n\t\tattribute vec3 morphTarget0;\n\t\tattribute vec3 morphTarget1;\n\t\tattribute vec3 morphTarget2;\n\t\tattribute vec3 morphTarget3;\n\t\t#ifdef USE_MORPHNORMALS\n\t\t\tattribute vec3 morphNormal0;\n\t\t\tattribute vec3 morphNormal1;\n\t\t\tattribute vec3 morphNormal2;\n\t\t\tattribute vec3 morphNormal3;\n\t\t#else\n\t\t\tattribute vec3 morphTarget4;\n\t\t\tattribute vec3 morphTarget5;\n\t\t\tattribute vec3 morphTarget6;\n\t\t\tattribute vec3 morphTarget7;\n\t\t#endif\n#endif\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}",diffuseMap_frag:"#ifdef USE_DIFFUSE_MAP\n\t\t#if (USE_DIFFUSE_MAP == 2)\n\t\t\t\tvec4 texelColor = texture2D(diffuseMap, v_Uv2);\n\t\t#else \n\t\t\t\tvec4 texelColor = texture2D(diffuseMap, v_Uv);\n\t\t#endif\n\t\t\n\t\ttexelColor = mapTexelToLinear(texelColor);\n\t\toutColor *= texelColor;\n#endif",diffuseMap_pars_frag:"#ifdef USE_DIFFUSE_MAP\n\t\tuniform sampler2D diffuseMap;\n#endif",emissiveMap_frag:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D(emissiveMap, vEmissiveMapUV);\n\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissiveMap_pars_frag:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n\tvarying vec2 vEmissiveMapUV;\n#endif",emissiveMap_vert:"#ifdef USE_EMISSIVEMAP\n\t#if (USE_EMISSIVEMAP == 2)\n\t\t\t\tvEmissiveMapUV = (emissiveMapUVTransform * vec3(a_Uv2, 1.)).xy;\n\t\t#else\n\t\t\t\tvEmissiveMapUV = (emissiveMapUVTransform * vec3(a_Uv, 1.)).xy;\n\t\t#endif\n#endif",emissiveMap_pars_vert:"#ifdef USE_EMISSIVEMAP\n\tuniform mat3 emissiveMapUVTransform;\n\tvarying vec2 vEmissiveMapUV;\n#endif",encodings_frag:"gl_FragColor = linearToOutputTexel( gl_FragColor );",encodings_pars_frag:"\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 GammaToLinear( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );\n}\nvec4 LinearToGamma( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );\n}\nvec4 sRGBToLinear( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.w );\n}\nvec4 RGBEToLinear( in vec4 value ) {\n\treturn vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );\n}\nvec4 LinearToRGBE( in vec4 value ) {\n\tfloat maxComponent = max( max( value.r, value.g ), value.b );\n\tfloat fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );\n\treturn vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );\n}\nvec4 RGBMToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.xyz * value.w * maxRange, 1.0 );\n}\nvec4 LinearToRGBM( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.x, max( value.g, value.b ) );\n\tfloat M\t\t\t= clamp( maxRGB / maxRange, 0.0, 1.0 );\n\tM\t\t\t\t\t\t= ceil( M * 255.0 ) / 255.0;\n\treturn vec4( value.rgb / ( M * maxRange ), M );\n}\nvec4 RGBDToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );\n}\nvec4 LinearToRGBD( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.x, max( value.g, value.b ) );\n\tfloat D\t\t\t= max( maxRange / maxRGB, 1.0 );\n\tD\t\t\t\t\t\t= min( floor( D ) / 255.0, 1.0 );\n\treturn vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );\n}\nconst mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );\nvec4 LinearToLogLuv( in vec4 value )\t{\n\tvec3 Xp_Y_XYZp = value.rgb * cLogLuvM;\n\tXp_Y_XYZp = max(Xp_Y_XYZp, vec3(1e-6, 1e-6, 1e-6));\n\tvec4 vResult;\n\tvResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;\n\tfloat Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;\n\tvResult.w = fract(Le);\n\tvResult.z = (Le - (floor(vResult.w*255.0))/255.0)/255.0;\n\treturn vResult;\n}\nconst mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );\nvec4 LogLuvToLinear( in vec4 value ) {\n\tfloat Le = value.z * 255.0 + value.w;\n\tvec3 Xp_Y_XYZp;\n\tXp_Y_XYZp.y = exp2((Le - 127.0) / 2.0);\n\tXp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;\n\tXp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;\n\tvec3 vRGB = Xp_Y_XYZp.rgb * cLogLuvInverseM;\n\treturn vec4( max(vRGB, 0.0), 1.0 );\n}",end_frag:"gl_FragColor = outColor;",envMap_frag:"#ifdef USE_ENV_MAP\n\t\tvec3 envDir;\n\t\t#ifdef USE_VERTEX_ENVDIR\n\t\t\t\tenvDir = v_EnvDir;\n\t\t#else\n\t\t\t\tenvDir = reflect(normalize(v_modelPos - u_CameraPosition), N);\n\t\t#endif\n\t\tvec4 envColor = textureCube(envMap, vec3(u_EnvMap_Flip * envDir.x, envDir.yz));\n\t\tenvColor = envMapTexelToLinear( envColor );\n\t\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutColor = mix(outColor, envColor * outColor, u_EnvMap_Intensity);\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutColor = mix(outColor, envColor, u_EnvMap_Intensity);\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutColor += envColor * u_EnvMap_Intensity;\n\t#endif\n#endif",envMap_pars_frag:"#ifdef USE_ENV_MAP\n\t\t#ifdef USE_VERTEX_ENVDIR\n\t\t\t\tvarying vec3 v_EnvDir;\n\t\t#endif\n\t\tuniform samplerCube envMap;\n\t\tuniform float u_EnvMap_Flip;\n\t\tuniform float u_EnvMap_Intensity;\n\t\tuniform float u_EnvMapLight_Intensity;\n\t\tuniform int maxMipLevel;\n#endif",envMap_pars_vert:"#ifdef USE_ENV_MAP\n\t\t#ifdef USE_VERTEX_ENVDIR\n\t\t\t\tvarying vec3 v_EnvDir;\n\t\t#endif\n#endif",envMap_vert:"\n#ifdef USE_ENV_MAP\n\t\t#ifdef USE_VERTEX_ENVDIR\n\t\t\t\tvec3 transformedNormal = (transposeMat4(inverseMat4(u_Model)) * vec4(objectNormal, 0.0)).xyz;\n\t\t\t\ttransformedNormal = normalize(transformedNormal);\n\t\t\t\tv_EnvDir = reflect(normalize(worldPosition.xyz - u_CameraPosition), transformedNormal);\n\t\t#endif\n#endif",fog_frag:"#ifdef USE_FOG\n\t\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\t\t#ifdef USE_EXP2_FOG\n\t\t\t\tfloat fogFactor = 1.0 - exp(-u_FogDensity * u_FogDensity * depth * depth);\n\t\t#else\n\t\t\t\tfloat fogFactor = smoothstep(u_FogNear, u_FogFar, depth);\n\t\t#endif\n\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, u_FogColor, fogFactor);\n#endif",fog_pars_frag:"#ifdef USE_FOG\n\t\tuniform vec3 u_FogColor;\n\t\t#ifdef USE_EXP2_FOG\n\t\t\t\tuniform float u_FogDensity;\n\t\t#else\n\t\t\t\tuniform float u_FogNear;\n\t\t\t\tuniform float u_FogFar;\n\t\t#endif\n#endif",inverse:"mat4 inverseMat4(mat4 m) {\n\t\tfloat\n\t\ta00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],\n\t\ta10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],\n\t\ta20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],\n\t\ta30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],\n\t\tb00 = a00 * a11 - a01 * a10,\n\t\tb01 = a00 * a12 - a02 * a10,\n\t\tb02 = a00 * a13 - a03 * a10,\n\t\tb03 = a01 * a12 - a02 * a11,\n\t\tb04 = a01 * a13 - a03 * a11,\n\t\tb05 = a02 * a13 - a03 * a12,\n\t\tb06 = a20 * a31 - a21 * a30,\n\t\tb07 = a20 * a32 - a22 * a30,\n\t\tb08 = a20 * a33 - a23 * a30,\n\t\tb09 = a21 * a32 - a22 * a31,\n\t\tb10 = a21 * a33 - a23 * a31,\n\t\tb11 = a22 * a33 - a23 * a32,\n\t\tdet = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n\t\treturn mat4(\n\t\t\t\ta11 * b11 - a12 * b10 + a13 * b09,\n\t\t\t\ta02 * b10 - a01 * b11 - a03 * b09,\n\t\t\t\ta31 * b05 - a32 * b04 + a33 * b03,\n\t\t\t\ta22 * b04 - a21 * b05 - a23 * b03,\n\t\t\t\ta12 * b08 - a10 * b11 - a13 * b07,\n\t\t\t\ta00 * b11 - a02 * b08 + a03 * b07,\n\t\t\t\ta32 * b02 - a30 * b05 - a33 * b01,\n\t\t\t\ta20 * b05 - a22 * b02 + a23 * b01,\n\t\t\t\ta10 * b10 - a11 * b08 + a13 * b06,\n\t\t\t\ta01 * b08 - a00 * b10 - a03 * b06,\n\t\t\t\ta30 * b04 - a31 * b02 + a33 * b00,\n\t\t\t\ta21 * b02 - a20 * b04 - a23 * b00,\n\t\t\t\ta11 * b07 - a10 * b09 - a12 * b06,\n\t\t\t\ta00 * b09 - a01 * b07 + a02 * b06,\n\t\t\t\ta31 * b01 - a30 * b03 - a32 * b00,\n\t\t\t\ta20 * b03 - a21 * b01 + a22 * b00) / det;\n}",light_frag:"\n#if (defined(USE_PHONG) || defined(USE_PBR))\n\t\tvec3 V = normalize(u_CameraPosition - v_modelPos);\n#endif\n#ifdef USE_PBR\n\t\t#ifdef USE_PBR2\n\t\t\t\tvec3 diffuseColor = outColor.xyz;\n\t\t\t\tvec3 specularColor = specularFactor.xyz;\n\t\t\t\tfloat roughness = max(1.0 - glossinessFactor, 0.0525);\n\t\t#else\n\t\t\t\tvec3 diffuseColor = outColor.xyz * (1.0 - metalnessFactor);\n\t\t\t\tvec3 specularColor = mix(vec3(0.04), outColor.xyz, metalnessFactor);\n\t\t\t\tfloat roughness = max(roughnessFactor, 0.0525);\n\t\t#endif\n\t\tvec3 dxy = max(abs(dFdx(geometryNormal)), abs(dFdy(geometryNormal)));\n\t\tfloat geometryRoughness = max(max(dxy.x, dxy.y), dxy.z);\n\t\troughness += geometryRoughness;\n\t\troughness = min(roughness, 1.0);\n\t\t#ifdef USE_CLEARCOAT\n\t\t\t\tfloat clearcoat = u_Clearcoat;\n\t\t\t\tfloat clearcoatRoughness = u_ClearcoatRoughness;\n\t\t\t\t#ifdef USE_CLEARCOATMAP\n\t\t\t\tclearcoat *= texture2D(clearcoatMap, v_Uv).x;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\t\t\t\tclearcoatRoughness *= texture2D(clearcoatRoughnessMap, v_Uv).y;\n\t\t\t#endif\n\t\t\t\tclearcoat = saturate(clearcoat);\n\t\t\t\tclearcoatRoughness = max(clearcoatRoughness, 0.0525);\n\t\t\tclearcoatRoughness += geometryRoughness;\n\t\t\tclearcoatRoughness = min(clearcoatRoughness, 1.0);\n\t\t#endif\n#else\n\t\tvec3 diffuseColor = outColor.xyz;\n\t\t#ifdef USE_PHONG\n\t\t\t\tvec3 specularColor = u_SpecularColor.xyz;\n\t\t\t\tfloat shininess = u_Specular;\n\t\t#endif\n#endif\n#ifdef USE_LIGHT\n\t\tvec3 L;\n\t\tfloat falloff;\n\t\tfloat dotNL;\n\t\tvec3 irradiance;\n\t\tfloat clearcoatDHR;\n\t\t#ifdef USE_CLEARCOAT\n\t\t\t\tfloat ccDotNL;\n\t\t\t\tvec3 ccIrradiance;\n\t\t#endif\n\t\t#if NUM_DIR_LIGHTS > 0\n\t\t\t\t#pragma unroll_loop_start\n\t\t\t\tfor (int i = 0; i < NUM_DIR_LIGHTS; i++) {\n\t\t\t\t\t\tL = normalize(-u_Directional[i].direction);\n\t\t\t\t\t\tfalloff = 1.0;\n\t\t\t\t\t\t#if defined(USE_SHADOW) && (UNROLLED_LOOP_INDEX < NUM_DIR_SHADOWS)\n\t\t\t\t\t\t\t\t#ifdef USE_PCSS_SOFT_SHADOW\n\t\t\t\t\t\t\t\t\t\tfalloff *= getShadowWithPCSS(directionalDepthMap[i], directionalShadowMap[i], vDirectionalShadowCoord[i], u_DirectionalShadow[i].shadowMapSize, u_DirectionalShadow[i].shadowBias, u_DirectionalShadow[i].shadowParams);\n\t\t\t\t\t\t\t\t#else\n\t\t\t\t\t\t\t\t\t\tfalloff *= getShadow(directionalShadowMap[i], vDirectionalShadowCoord[i], u_DirectionalShadow[i].shadowMapSize, u_DirectionalShadow[i].shadowBias, u_DirectionalShadow[i].shadowParams);\n\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tdotNL = saturate(dot(N, L));\n\t\t\t\t\t\tirradiance = u_Directional[i].color * falloff * dotNL * PI;\n\t\t\t\t\t\t#ifdef USE_CLEARCOAT\t\t\t\t\n\t\t\t\t\t\t\t\tccDotNL = saturate(dot(clearcoatNormal, L));\n\t\t\t\t\t\t\t\tccIrradiance = ccDotNL * u_Directional[i].color * falloff\t* PI;\n\t\t\t\t\t\t\t\tclearcoatDHR = clearcoat * clearcoatDHRApprox(clearcoatRoughness, ccDotNL);\n\t\t\t\t\t\t\t\treflectedLight.directSpecular += ccIrradiance * clearcoat * BRDF_Specular_GGX(specularColor, clearcoatNormal, L, V, clearcoatRoughness);\n\t\t\t\t\t\t#else\n\t\t\t\t\t\tclearcoatDHR = 0.0;\n\t\t\t\t\t#endif\n\t\t\t\t\t\treflectedLight.directDiffuse += (1.0 - clearcoatDHR) * irradiance * BRDF_Diffuse_Lambert(diffuseColor);\n\t\t\t\t\t\t#ifdef USE_PHONG\n\t\t\t\t\t\t\t\treflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong(specularColor, N, L, V, shininess) * specularStrength;\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\t#ifdef USE_PBR\n\t\t\t\t\t\t\t\treflectedLight.directSpecular += (1.0 - clearcoatDHR) * irradiance * BRDF_Specular_GGX(specularColor, N, L, V, roughness);\n\t\t\t\t\t\t#endif\n\t\t\t\t}\n\t\t\t\t#pragma unroll_loop_end\n\t\t#endif\n\t\t#if NUM_POINT_LIGHTS > 0\n\t\t\t\tvec3 worldV;\n\t\t\t\t#pragma unroll_loop_start\n\t\t\t\tfor (int i = 0; i < NUM_POINT_LIGHTS; i++) {\n\t\t\t\t\t\tworldV = v_modelPos - u_Point[i].position;\n\t\t\t\t\t\tL = -worldV;\n\t\t\t\t\t\tfalloff = pow(clamp(1. - length(L) / u_Point[i].distance, 0.0, 1.0), u_Point[i].decay);\n\t\t\t\t\t\tL = normalize(L);\n\t\t\t\t\t\t#if defined(USE_SHADOW) && (UNROLLED_LOOP_INDEX < NUM_POINT_SHADOWS)\n\t\t\t\t\t\t\t\tfalloff *= getPointShadow(pointShadowMap[i], vPointShadowCoord[i], u_PointShadow[i].shadowMapSize, u_PointShadow[i].shadowBias, u_PointShadow[i].shadowParams, u_PointShadow[i].shadowCameraRange);\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tdotNL = saturate(dot(N, L));\n\t\t\t\t\t\tirradiance = u_Point[i].color * falloff * dotNL * PI;\n\t\t\t\t\t\t#ifdef USE_CLEARCOAT\t\t\t\t\n\t\t\t\t\t\t\t\tccDotNL = saturate(dot(clearcoatNormal, L));\n\t\t\t\t\t\t\t\tccIrradiance = ccDotNL *\tu_Point[i].color * falloff\t* PI;\n\t\t\t\t\t\t\t\tclearcoatDHR = clearcoat * clearcoatDHRApprox(clearcoatRoughness, ccDotNL);\n\t\t\t\t\t\t\t\treflectedLight.directSpecular += ccIrradiance * clearcoat * BRDF_Specular_GGX(specularColor, clearcoatNormal, L, V, clearcoatRoughness);\n\t\t\t\t\t\t#else\n\t\t\t\t\t\tclearcoatDHR = 0.0;\n\t\t\t\t\t#endif\n\t\t\t\t\t\treflectedLight.directDiffuse += (1.0 - clearcoatDHR) * irradiance * BRDF_Diffuse_Lambert(diffuseColor);\n\t\t\t\t\t\t#ifdef USE_PHONG\n\t\t\t\t\t\t\t\treflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong(specularColor, N, L, V, shininess) * specularStrength;\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\t#ifdef USE_PBR\n\t\t\t\t\t\t\t\treflectedLight.directSpecular += (1.0 - clearcoatDHR) * irradiance * BRDF_Specular_GGX(specularColor, N, L, V, roughness);\n\t\t\t\t\t\t#endif\n\t\t\t\t}\n\t\t\t\t#pragma unroll_loop_end\n\t\t#endif\n\t\t#if NUM_SPOT_LIGHTS > 0\n\t\t\t\tfloat lightDistance;\n\t\t\t\tfloat angleCos;\n\t\t\t\t#pragma unroll_loop_start\n\t\t\t\tfor (int i = 0; i < NUM_SPOT_LIGHTS; i++) {\n\t\t\t\t\t\tL = u_Spot[i].position - v_modelPos;\n\t\t\t\t\t\tlightDistance = length(L);\n\t\t\t\t\t\tL = normalize(L);\n\t\t\t\t\t\tangleCos = dot(L, -normalize(u_Spot[i].direction));\n\t\t\t\t\t\tfalloff = smoothstep(u_Spot[i].coneCos, u_Spot[i].penumbraCos, angleCos);\n\t\t\t\t\t\tfalloff *= pow(clamp(1. - lightDistance / u_Spot[i].distance, 0.0, 1.0), u_Spot[i].decay);\n\t\t\t\t\t\t#if defined(USE_SHADOW) && (UNROLLED_LOOP_INDEX < NUM_SPOT_SHADOWS)\n\t\t\t\t\t\t\t\t#ifdef USE_PCSS_SOFT_SHADOW\n\t\t\t\t\t\t\t\t\t\tfalloff *= getShadowWithPCSS(spotDepthMap[i], spotShadowMap[i], vSpotShadowCoord[i], u_SpotShadow[i].shadowMapSize, u_SpotShadow[i].shadowBias, u_SpotShadow[i].shadowParams);\n\t\t\t\t\t\t\t\t#else\n\t\t\t\t\t\t\t\t\t\tfalloff *= getShadow(spotShadowMap[i], vSpotShadowCoord[i], u_SpotShadow[i].shadowMapSize, u_SpotShadow[i].shadowBias, u_SpotShadow[i].shadowParams);\n\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tdotNL = saturate(dot(N, L));\n\t\t\t\t\t\tirradiance = u_Spot[i].color * falloff * dotNL * PI;\n\t\t\t\t\t\t#ifdef USE_CLEARCOAT\t\t\t\t\n\t\t\t\t\t\t\t\tccDotNL = saturate(dot(clearcoatNormal, L));\n\t\t\t\t\t\t\t\tccIrradiance = ccDotNL *\tu_Spot[i].color * falloff\t* PI;\n\t\t\t\t\t\t\t\tclearcoatDHR = clearcoat * clearcoatDHRApprox(clearcoatRoughness, ccDotNL);\n\t\t\t\t\t\t\t\treflectedLight.directSpecular += ccIrradiance * clearcoat * BRDF_Specular_GGX(specularColor, clearcoatNormal, L, V, clearcoatRoughness);\n\t\t\t\t\t\t#else\n\t\t\t\t\t\tclearcoatDHR = 0.0;\n\t\t\t\t\t#endif\n\t\t\t\t\t\treflectedLight.directDiffuse += (1.0 - clearcoatDHR) * irradiance * BRDF_Diffuse_Lambert(diffuseColor);\n\t\t\t\t\t\t#ifdef USE_PHONG\n\t\t\t\t\t\t\t\treflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong(specularColor, N, L, V, shininess) * specularStrength;\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\t#ifdef USE_PBR\n\t\t\t\t\t\t\t\treflectedLight.directSpecular += (1.0 - clearcoatDHR) * irradiance * BRDF_Specular_GGX(specularColor, N, L, V, roughness);\n\t\t\t\t\t\t#endif\n\t\t\t\t}\n\t\t\t\t#pragma unroll_loop_end\n\t\t#endif\n\t\tvec3 iblIrradiance = vec3(0., 0., 0.);\n\t\tvec3 indirectIrradiance = vec3(0., 0., 0.);\n\t\tvec3 indirectRadiance = vec3(0., 0., 0.);\n\t\tvec3 clearcoatRadiance = vec3(0., 0., 0.);\n\t\t#ifdef USE_AMBIENT_LIGHT\n\t\t\t\tindirectIrradiance += u_AmbientLightColor * PI;\n\t\t#endif\n\t\t#if NUM_HEMI_LIGHTS > 0\n\t\t\t\tfloat hemiDiffuseWeight;\n\t\t\t\t#pragma unroll_loop_start\n\t\t\t\tfor (int i = 0; i < NUM_HEMI_LIGHTS; i++) {\n\t\t\t\t\t\tL = normalize(u_Hemi[i].direction);\n\t\t\t\t\t\tdotNL = dot(N, L);\n\t\t\t\t\t\themiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\t\t\t\t\tindirectIrradiance += mix(u_Hemi[i].groundColor, u_Hemi[i].skyColor, hemiDiffuseWeight) * PI;\n\t\t\t\t}\n\t\t\t\t#pragma unroll_loop_end\n\t\t#endif\n\t\t#if defined(USE_ENV_MAP) && defined(USE_PBR)\n\t\t\t\tvec3 envDir;\n\t\t\t\t#ifdef USE_VERTEX_ENVDIR\n\t\t\t\t\t\tenvDir = v_EnvDir;\n\t\t\t\t#else\n\t\t\t\t\t\tenvDir = reflect(normalize(v_modelPos - u_CameraPosition), N);\n\t\t\t\t#endif\n\t\t\t\tiblIrradiance += getLightProbeIndirectIrradiance(maxMipLevel, N);\n\t\t\t\tindirectRadiance += getLightProbeIndirectRadiance(GGXRoughnessToBlinnExponent(roughness), maxMipLevel, envDir);\n\t\t\t\t#ifdef USE_CLEARCOAT\n\t\t\t\t\t\tvec3 clearcoatDir = reflect(normalize(v_modelPos - u_CameraPosition), clearcoatNormal);\n\t\t\t\tclearcoatRadiance += getLightProbeIndirectRadiance(GGXRoughnessToBlinnExponent(clearcoatRoughness), maxMipLevel, clearcoatDir);\n\t\t\t#endif\n\t\t#endif\n\t\treflectedLight.indirectDiffuse += indirectIrradiance * BRDF_Diffuse_Lambert(diffuseColor);\n\t\t#if defined(USE_ENV_MAP) && defined(USE_PBR)\n\t\t\t\t#ifdef USE_CLEARCOAT\n\t\t\t\t\t\tfloat ccDotNV = saturate(dot(clearcoatNormal, V));\n\t\t\t\t\t\treflectedLight.indirectSpecular += clearcoatRadiance * clearcoat * BRDF_Specular_GGX_Environment(clearcoatNormal, V, specularColor, clearcoatRoughness);\n\t\t\t\t\t\tccDotNL = ccDotNV;\n\t\t\t\t\t\tclearcoatDHR = clearcoat * clearcoatDHRApprox(clearcoatRoughness, ccDotNL);\n\t\t\t\t#else\n\t\t\t\t\t\tclearcoatDHR = 0.0;\n\t\t\t\t#endif\n\t\t\t\tfloat clearcoatInv = 1.0 - clearcoatDHR;\n\t\t\t\tvec3 singleScattering = vec3(0.0);\n\t\t\tvec3 multiScattering = vec3(0.0);\n\t\t\t\tvec3 cosineWeightedIrradiance = iblIrradiance * RECIPROCAL_PI;\n\t\t\t\tBRDF_Specular_Multiscattering_Environment(N, V, specularColor, roughness, singleScattering, multiScattering);\n\t\t\t\tvec3 diffuse = diffuseColor * (1.0 - (singleScattering + multiScattering));\n\t\t\t\treflectedLight.indirectSpecular += clearcoatInv * indirectRadiance * singleScattering;\n\t\t\t\treflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;\n\t\t\t\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n\t\t#endif\n#endif",light_pars_frag:"#ifdef USE_AMBIENT_LIGHT\n\t\tuniform vec3 u_AmbientLightColor;\n#endif\n#ifdef USE_CLEARCOAT\n\t\tfloat clearcoatDHRApprox(const in float roughness, const in float dotNL) {\n\t\t\t\treturn 0.04 + (1.0 - 0.16) * (pow(1.0 - dotNL, 5.0) * pow(1.0 - roughness, 2.0));\n\t\t}\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\t\tstruct HemisphereLight {\n\t\t\t\tvec3 direction;\n\t\t\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t\t};\n\t\tuniform HemisphereLight u_Hemi[NUM_HEMI_LIGHTS];\n#endif\n#if NUM_DIR_LIGHTS > 0\n\t\tstruct DirectLight {\n\t\t\t\tvec3 direction;\n\t\t\t\tvec3 color;\n\t\t};\n\t\tuniform DirectLight u_Directional[NUM_DIR_LIGHTS];\n#endif\n#if NUM_POINT_LIGHTS > 0\n\t\tstruct PointLight {\n\t\t\t\tvec3 position;\n\t\t\t\tvec3 color;\n\t\t\t\tfloat distance;\n\t\t\t\tfloat decay;\n\t\t};\n\t\tuniform PointLight u_Point[NUM_POINT_LIGHTS];\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\t\tstruct SpotLight {\n\t\t\t\tvec3 position;\n\t\t\t\tvec3 color;\n\t\t\t\tfloat distance;\n\t\t\t\tfloat decay;\n\t\t\t\tfloat coneCos;\n\t\t\t\tfloat penumbraCos;\n\t\t\t\tvec3 direction;\n\t\t};\n\t\tuniform SpotLight u_Spot[NUM_SPOT_LIGHTS];\n#endif\n#if defined(USE_PBR) && defined(USE_ENV_MAP)\n\t\tvec3 getLightProbeIndirectIrradiance(const in int maxMIPLevel, const in vec3 N) {\n\t\t\t\tvec3 coordVec = vec3(u_EnvMap_Flip * N.x, N.yz);\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT(envMap, coordVec, float(maxMIPLevel));\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube(envMap, coordVec, float(maxMIPLevel));\n\t\t\t#endif\n\t\t\t\tenvMapColor = envMapTexelToLinear(envMapColor);\n\t\t\t\treturn PI * envMapColor.rgb * u_EnvMap_Intensity * u_EnvMapLight_Intensity;\n\t\t}\n\t\tfloat getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {\n\t\t\tfloat maxMIPLevelScalar = float(maxMIPLevel);\n\t\t\tfloat desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2(pow2(blinnShininessExponent) + 1.0);\n\t\t\treturn clamp(desiredMIPLevel, 0.0, maxMIPLevelScalar);\n\t\t}\n\t\tvec3 getLightProbeIndirectRadiance(const in float blinnShininessExponent, const in int maxMIPLevel, const in vec3 envDir) {\n\t\t\t\tfloat specularMIPLevel = getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);\n\t\t\t\tvec3 coordVec = vec3(u_EnvMap_Flip * envDir.x, envDir.yz);\n\t\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT(envMap, coordVec, specularMIPLevel);\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube(envMap, coordVec, specularMIPLevel);\n\t\t\t#endif\n\t\t\t\tenvMapColor = envMapTexelToLinear(envMapColor);\n\t\t\t\treturn envMapColor.rgb * u_EnvMap_Intensity;\n\t\t}\n\t\tfloat computeSpecularOcclusion(const in float dotNV, const in float ambientOcclusion, const in float roughness) {\n\t\t\treturn saturate(pow(dotNV + ambientOcclusion, exp2(-16.0 * roughness - 1.0)) - 1.0 + ambientOcclusion);\n\t\t}\n#endif",alphamap_pars_frag:"#ifdef USE_ALPHA_MAP\n\tuniform sampler2D alphaMap;\n\tvarying vec2 vAlphaMapUV;\n#endif",alphamap_frag:"#ifdef USE_ALPHA_MAP\n\toutColor.a *= texture2D(alphaMap, vAlphaMapUV).g;\n#endif",alphamap_pars_vert:"#ifdef USE_ALPHA_MAP\n\t\tuniform mat3 alphaMapUVTransform;\n\tvarying vec2 vAlphaMapUV;\n#endif",alphamap_vert:"#ifdef USE_ALPHA_MAP\n\t#if (USE_ALPHA_MAP == 2)\n\t\t\t\tvAlphaMapUV = (alphaMapUVTransform * vec3(a_Uv2, 1.)).xy;\n\t\t#else\n\t\t\t\tvAlphaMapUV = (alphaMapUVTransform * vec3(a_Uv, 1.)).xy;\n\t\t#endif\n#endif",normalMap_pars_frag:"#ifdef USE_NORMAL_MAP\n\t\tuniform sampler2D normalMap;\n\t\tuniform vec2 normalScale;\n#endif\n#if defined(USE_NORMAL_MAP) || defined(USE_CLEARCOAT_NORMALMAP)\n\t\t#if defined(USE_TANGENT) && !defined(FLAT_SHADED)\n\t\t\t\t#define USE_TBN\n\t\t#else\n\t\t\t\t#include <tsn>\n\t\t#endif\n#endif",normal_frag:"\n#ifdef FLAT_SHADED\n\t\tvec3 fdx = dFdx(v_modelPos);\n\t\tvec3 fdy = dFdy(v_modelPos);\n\t\tvec3 N = normalize(cross(fdx, fdy));\n#else\n\t\tvec3 N = normalize(v_Normal);\n\t\t#ifdef DOUBLE_SIDED\n\t\t\t\tN = N * (float(gl_FrontFacing) * 2.0 - 1.0);\n\t\t#endif\n#endif\n#ifdef USE_TBN\n\tvec3 tangent = normalize(v_Tangent);\n\tvec3 bitangent = normalize(v_Bitangent);\n\t#ifdef DOUBLE_SIDED\n\t\ttangent = tangent * (float(gl_FrontFacing) * 2.0 - 1.0);\n\t\tbitangent = bitangent * (float(gl_FrontFacing) * 2.0 - 1.0);\n\t#endif\n\tmat3 tspace = mat3(tangent, bitangent, N);\n#endif\nvec3 geometryNormal = N;\n#ifdef USE_NORMAL_MAP\n\t\tvec3 mapN = texture2D(normalMap, v_Uv).rgb * 2.0 - 1.0;\n\t\tmapN.xy *= normalScale;\n\t\t#ifdef USE_TBN\n\t\t\t\tN = normalize(tspace * mapN);\n\t\t#else\n\t\t\t\tmapN.xy *= (float(gl_FrontFacing) * 2.0 - 1.0);\n\t\t\t\tN = normalize(tsn(N, v_modelPos, v_Uv) * mapN);\n\t\t#endif\n#elif defined(USE_BUMPMAP)\n\t\tN = perturbNormalArb(v_modelPos, N, dHdxy_fwd(v_Uv));\n#endif\n#ifdef USE_CLEARCOAT\n\tvec3 clearcoatNormal = geometryNormal;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvec3 clearcoatMapN = texture2D(clearcoatNormalMap, v_Uv).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\t#ifdef USE_TBN\n\t\tclearcoatNormal = normalize(tspace * clearcoatMapN);\n\t#else\n\t\tclearcoatMapN.xy *= (float(gl_FrontFacing) * 2.0 - 1.0);\n\t\tclearcoatNormal = normalize(tsn(clearcoatNormal, v_modelPos, v_Uv) * clearcoatMapN);\n\t#endif\n#endif",normal_pars_frag:"#ifndef FLAT_SHADED\n\t\tvarying vec3 v_Normal;\n\t\t#ifdef USE_TANGENT\n\t\t\t\tvarying vec3 v_Tangent;\n\t\tvarying vec3 v_Bitangent;\n\t\t#endif\n#endif",normal_pars_vert:"#ifndef FLAT_SHADED\n\t\tvarying vec3 v_Normal;\n\t\t#ifdef USE_TANGENT\n\t\t\t\tvarying vec3 v_Tangent;\n\t\tvarying vec3 v_Bitangent;\n\t\t#endif\n#endif",normal_vert:"#ifndef FLAT_SHADED\n\t\tv_Normal = (transposeMat4(inverseMat4(u_Model)) * vec4(objectNormal, 0.0)).xyz;\n\t\t#ifdef FLIP_SIDED\n\t\t\tv_Normal = - v_Normal;\n\t\t#endif\n\t\t#ifdef USE_TANGENT\n\t\t\t\tv_Tangent = (transposeMat4(inverseMat4(u_Model)) * vec4(objectTangent, 0.0)).xyz;\n\t\t\t\t#ifdef FLIP_SIDED\n\t\t\t\t\t\tv_Tangent = - v_Tangent;\n\t\t\t\t#endif\n\t\t\t\tv_Bitangent = normalize(cross(v_Normal, v_Tangent) * a_Tangent.w);\n\t\t#endif\n#endif",packing:"const float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,\t256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\t\tvec4 r = vec4( fract( v * PackFactors ), v );\n\t\tr.yzw -= r.xyz * ShiftRight8;\t\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\t\treturn dot( v, UnpackFactors );\n}",premultipliedAlpha_frag:"#ifdef USE_PREMULTIPLIED_ALPHA\n\t\tgl_FragColor.rgb = gl_FragColor.rgb * gl_FragColor.a;\n#endif",pvm_vert:"vec4 worldPosition = u_Model * vec4(transformed, 1.0);\ngl_Position = u_ProjectionView * worldPosition;",dithering_frag:"#if defined( DITHERING )\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_frag:"#if defined( DITHERING )\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",shadow:"#ifdef USE_SHADOW_SAMPLER\n\t\tfloat computeShadow(sampler2DShadow shadowMap, vec3 shadowCoord) {\n\t\t\t\treturn texture2D( shadowMap, shadowCoord );\n\t\t}\n#else\n\t\tfloat computeShadow(sampler2D shadowMap, vec3 shadowCoord) {\n\t\t\t\treturn step(shadowCoord.z, unpackRGBAToDepth(texture2D(shadowMap, shadowCoord.xy)));\n\t\t}\n#endif\nfloat computeShadowWithPoissonSampling(sampler2DShadow shadowMap, vec3 shadowCoord, float texelSize) {\n\t\tvec3 poissonDisk[4];\n\t\tpoissonDisk[0] = vec3(-0.94201624, -0.39906216, 0);\n\t\tpoissonDisk[1] = vec3(0.94558609, -0.76890725, 0);\n\t\tpoissonDisk[2] = vec3(-0.094184101, -0.92938870, 0);\n\t\tpoissonDisk[3] = vec3(0.34495938, 0.29387760, 0);\n\t\treturn computeShadow(shadowMap, shadowCoord + poissonDisk[0] * texelSize) * 0.25 +\n\t\t\t\tcomputeShadow(shadowMap, shadowCoord + poissonDisk[1] * texelSize) * 0.25 +\n\t\t\t\tcomputeShadow(shadowMap, shadowCoord + poissonDisk[2] * texelSize) * 0.25 +\n\t\t\t\tcomputeShadow(shadowMap, shadowCoord + poissonDisk[3] * texelSize) * 0.25;\n}\nfloat computeShadowWithPCF1(sampler2DShadow shadowSampler, vec3 shadowCoord) {\n\t\treturn computeShadow(shadowSampler, shadowCoord);\n}\nfloat computeShadowWithPCF3(sampler2DShadow shadowSampler, vec3 shadowCoord, vec2 shadowMapSizeAndInverse) {\n\t\tvec2 uv = shadowCoord.xy * shadowMapSizeAndInverse.x;\t\tuv += 0.5;\t\tvec2 st = fract(uv);\t\tvec2 base_uv = floor(uv) - 0.5;\t\tbase_uv *= shadowMapSizeAndInverse.y;\n\t\tvec2 uvw0 = 3. - 2. * st;\n\t\tvec2 uvw1 = 1. + 2. * st;\n\t\tvec2 u = vec2((2. - st.x) / uvw0.x - 1., st.x / uvw1.x + 1.) * shadowMapSizeAndInverse.y;\n\t\tvec2 v = vec2((2. - st.y) / uvw0.y - 1., st.y / uvw1.y + 1.) * shadowMapSizeAndInverse.y;\n\t\tfloat shadow = 0.;\n\t\tshadow += uvw0.x * uvw0.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[0], v[0]), shadowCoord.z));\n\t\tshadow += uvw1.x * uvw0.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[1], v[0]), shadowCoord.z));\n\t\tshadow += uvw0.x * uvw1.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[0], v[1]), shadowCoord.z));\n\t\tshadow += uvw1.x * uvw1.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[1], v[1]), shadowCoord.z));\n\t\tshadow = shadow / 16.;\n\t\treturn shadow;\n}\nfloat computeShadowWithPCF5(sampler2DShadow shadowSampler, vec3 shadowCoord, vec2 shadowMapSizeAndInverse) {\n\t\tvec2 uv = shadowCoord.xy * shadowMapSizeAndInverse.x;\t\tuv += 0.5;\t\tvec2 st = fract(uv);\t\tvec2 base_uv = floor(uv) - 0.5;\t\tbase_uv *= shadowMapSizeAndInverse.y;\n\t\tvec2 uvw0 = 4. - 3. * st;\n\t\tvec2 uvw1 = vec2(7.);\n\t\tvec2 uvw2 = 1. + 3. * st;\n\t\tvec3 u = vec3((3. - 2. * st.x) / uvw0.x - 2., (3. + st.x) / uvw1.x, st.x / uvw2.x + 2.) * shadowMapSizeAndInverse.y;\n\t\tvec3 v = vec3((3. - 2. * st.y) / uvw0.y - 2., (3. + st.y) / uvw1.y, st.y / uvw2.y + 2.) * shadowMapSizeAndInverse.y;\n\t\tfloat shadow = 0.;\n\t\tshadow += uvw0.x * uvw0.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[0], v[0]), shadowCoord.z));\n\t\tshadow += uvw1.x * uvw0.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[1], v[0]), shadowCoord.z));\n\t\tshadow += uvw2.x * uvw0.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[2], v[0]), shadowCoord.z));\n\t\tshadow += uvw0.x * uvw1.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[0], v[1]), shadowCoord.z));\n\t\tshadow += uvw1.x * uvw1.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[1], v[1]), shadowCoord.z));\n\t\tshadow += uvw2.x * uvw1.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[2], v[1]), shadowCoord.z));\n\t\tshadow += uvw0.x * uvw2.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[0], v[2]), shadowCoord.z));\n\t\tshadow += uvw1.x * uvw2.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[1], v[2]), shadowCoord.z));\n\t\tshadow += uvw2.x * uvw2.y * computeShadow(shadowSampler, vec3(base_uv.xy + vec2(u[2], v[2]), shadowCoord.z));\n\t\tshadow = shadow / 144.;\n\t\treturn shadow;\n}\nfloat computeFallOff(float value, vec2 clipSpace, float frustumEdgeFalloff) {\n\t\tfloat mask = smoothstep(1.0 - frustumEdgeFalloff, 1.00000012, clamp(dot(clipSpace, clipSpace), 0., 1.));\n\t\treturn mix(value, 1.0, mask);\n}\nfloat getShadow(sampler2DShadow shadowMap, vec4 shadowCoord, vec2 shadowMapSize, vec2 shadowBias, vec2 shadowParams) {\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias.x;\n\t\tbvec4 inFrustumVec = bvec4 (shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0);\n\t\tbool inFrustum = all(inFrustumVec);\n\t\tbvec2 frustumTestVec = bvec2(inFrustum, shadowCoord.z <= 1.0);\n\t\tbool frustumTest = all(frustumTestVec);\n\t\tfloat shadow = 1.0;\n\t\tif (frustumTest) {\n\t\t\t\t#ifdef USE_HARD_SHADOW\n\t\t\t\t\t\tshadow = computeShadow(shadowMap, shadowCoord.xyz);\n\t\t\t\t#else\n\t\t\t\t\t\t#ifdef USE_PCF3_SOFT_SHADOW\n\t\t\t\t\t\t\t\tvec2 shadowMapSizeAndInverse = vec2(shadowMapSize.x, 1. / shadowMapSize.x);\n\t\t\t\t\t\t\t\tshadow = computeShadowWithPCF3(shadowMap, shadowCoord.xyz, shadowMapSizeAndInverse);\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\t\t#ifdef USE_PCF5_SOFT_SHADOW\n\t\t\t\t\t\t\t\t\t\tvec2 shadowMapSizeAndInverse = vec2(shadowMapSize.x, 1. / shadowMapSize.x);\n\t\t\t\t\t\t\t\t\t\tshadow = computeShadowWithPCF5(shadowMap, shadowCoord.xyz, shadowMapSizeAndInverse);\n\t\t\t\t\t\t\t\t#else\n\t\t\t\t\t\t\t\t\t\tfloat texelSize = shadowParams.x / shadowMapSize.x;\n\t\t\t\t\t\t\t\t\t\tshadow = computeShadowWithPoissonSampling(shadowMap, shadowCoord.xyz, texelSize);\n\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t\tshadow = computeFallOff(shadow, shadowCoord.xy * 2. - 1., shadowParams.y);\n\t\t}\n\t\treturn shadow;\n}\nfloat textureCubeCompare(samplerCube depths, vec3 uv, float compare) {\n\t\treturn step(compare, unpackRGBAToDepth(textureCube(depths, uv)));\n}\nfloat getPointShadow(samplerCube shadowMap, vec4 shadowCoord, vec2 shadowMapSize, vec2 shadowBias, vec2 shadowParams, vec2 shadowCameraRange) {\n\t\tvec3 V = shadowCoord.xyz;\n\t\tfloat depth = (length(V) - shadowCameraRange.x) / (shadowCameraRange.y - shadowCameraRange.x);\t\tdepth += shadowBias.x;\n\t\t#ifdef USE_HARD_SHADOW\n\t\t\t\treturn textureCubeCompare(shadowMap, normalize(V), depth);\n\t\t#else\n\t\t\t\tfloat texelSize = shadowParams.x / shadowMapSize.x;\n\t\t\t\tvec3 poissonDisk[4];\n\t\t\t\tpoissonDisk[0] = vec3(-1.0, 1.0, -1.0);\n\t\t\t\tpoissonDisk[1] = vec3(1.0, -1.0, -1.0);\n\t\t\t\tpoissonDisk[2] = vec3(-1.0, -1.0, -1.0);\n\t\t\t\tpoissonDisk[3] = vec3(1.0, -1.0, 1.0);\n\t\t\t\treturn textureCubeCompare(shadowMap, normalize(V) + poissonDisk[0] * texelSize, depth) * 0.25 +\n\t\t\t\t\t\ttextureCubeCompare(shadowMap, normalize(V) + poissonDisk[1] * texelSize, depth) * 0.25 +\n\t\t\t\t\t\ttextureCubeCompare(shadowMap, normalize(V) + poissonDisk[2] * texelSize, depth) * 0.25 +\n\t\t\t\t\t\ttextureCubeCompare(shadowMap, normalize(V) + poissonDisk[3] * texelSize, depth) * 0.25;\n\t\t#endif\n}\n#ifdef USE_PCSS_SOFT_SHADOW\n\t\tconst vec3 PoissonSamplers32[64] = vec3[64](\n\t\t\t\tvec3(0.06407013, 0.05409927, 0.),\n\t\t\t\tvec3(0.7366577, 0.5789394, 0.),\n\t\t\t\tvec3(-0.6270542, -0.5320278, 0.),\n\t\t\t\tvec3(-0.4096107, 0.8411095, 0.),\n\t\t\t\tvec3(0.6849564, -0.4990818, 0.),\n\t\t\t\tvec3(-0.874181, -0.04579735, 0.),\n\t\t\t\tvec3(0.9989998, 0.0009880066, 0.),\n\t\t\t\tvec3(-0.004920578, -0.9151649, 0.),\n\t\t\t\tvec3(0.1805763, 0.9747483, 0.),\n\t\t\t\tvec3(-0.2138451, 0.2635818, 0.),\n\t\t\t\tvec3(0.109845, 0.3884785, 0.),\n\t\t\t\tvec3(0.06876755, -0.3581074, 0.),\n\t\t\t\tvec3(0.374073, -0.7661266, 0.),\n\t\t\t\tvec3(0.3079132, -0.1216763, 0.),\n\t\t\t\tvec3(-0.3794335, -0.8271583, 0.),\n\t\t\t\tvec3(-0.203878, -0.07715034, 0.),\n\t\t\t\tvec3(0.5912697, 0.1469799, 0.),\n\t\t\t\tvec3(-0.88069, 0.3031784, 0.),\n\t\t\t\tvec3(0.5040108, 0.8283722, 0.),\n\t\t\t\tvec3(-0.5844124, 0.5494877, 0.),\n\t\t\t\tvec3(0.6017799, -0.1726654, 0.),\n\t\t\t\tvec3(-0.5554981, 0.1559997, 0.),\n\t\t\t\tvec3(-0.3016369, -0.3900928, 0.),\n\t\t\t\tvec3(-0.5550632, -0.1723762, 0.),\n\t\t\t\tvec3(0.925029, 0.2995041, 0.),\n\t\t\t\tvec3(-0.2473137, 0.5538505, 0.),\n\t\t\t\tvec3(0.9183037, -0.2862392, 0.),\n\t\t\t\tvec3(0.2469421, 0.6718712, 0.),\n\t\t\t\tvec3(0.3916397, -0.4328209, 0.),\n\t\t\t\tvec3(-0.03576927, -0.6220032, 0.),\n\t\t\t\tvec3(-0.04661255, 0.7995201, 0.),\n\t\t\t\tvec3(0.4402924, 0.3640312, 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.),\n\t\t\t\tvec3(0., 0., 0.)\n\t\t);\n\t\tconst vec3 PoissonSamplers64[64] = vec3[64](\n\t\t\t\tvec3(-0.613392, 0.617481, 0.),\n\t\t\t\tvec3(0.170019, -0.040254, 0.),\n\t\t\t\tvec3(-0.299417, 0.791925, 0.),\n\t\t\t\tvec3(0.645680, 0.493210, 0.),\n\t\t\t\tvec3(-0.651784, 0.717887, 0.),\n\t\t\t\tvec3(0.421003, 0.027070, 0.),\n\t\t\t\tvec3(-0.817194, -0.271096, 0.),\n\t\t\t\tvec3(-0.705374, -0.668203, 0.),\n\t\t\t\tvec3(0.977050, -0.108615, 0.),\n\t\t\t\tvec3(0.063326, 0.142369, 0.),\n\t\t\t\tvec3(0.203528, 0.214331, 0.),\n\t\t\t\tvec3(-0.667531, 0.326090, 0.),\n\t\t\t\tvec3(-0.098422, -0.295755, 0.),\n\t\t\t\tvec3(-0.885922, 0.215369, 0.),\n\t\t\t\tvec3(0.566637, 0.605213, 0.),\n\t\t\t\tvec3(0.039766, -0.396100, 0.),\n\t\t\t\tvec3(0.751946, 0.453352, 0.),\n\t\t\t\tvec3(0.078707, -0.715323, 0.),\n\t\t\t\tvec3(-0.075838, -0.529344, 0.),\n\t\t\t\tvec3(0.724479, -0.580798, 0.),\n\t\t\t\tvec3(0.222999, -0.215125, 0.),\n\t\t\t\tvec3(-0.467574, -0.405438, 0.),\n\t\t\t\tvec3(-0.248268, -0.814753, 0.),\n\t\t\t\tvec3(0.354411, -0.887570, 0.),\n\t\t\t\tvec3(0.175817, 0.382366, 0.),\n\t\t\t\tvec3(0.487472, -0.063082, 0.),\n\t\t\t\tvec3(-0.084078, 0.898312, 0.),\n\t\t\t\tvec3(0.488876, -0.783441, 0.),\n\t\t\t\tvec3(0.470016, 0.217933, 0.),\n\t\t\t\tvec3(-0.696890, -0.549791, 0.),\n\t\t\t\tvec3(-0.149693, 0.605762, 0.),\n\t\t\t\tvec3(0.034211, 0.979980, 0.),\n\t\t\t\tvec3(0.503098, -0.308878, 0.),\n\t\t\t\tvec3(-0.016205, -0.872921, 0.),\n\t\t\t\tvec3(0.385784, -0.393902, 0.),\n\t\t\t\tvec3(-0.146886, -0.859249, 0.),\n\t\t\t\tvec3(0.643361, 0.164098, 0.),\n\t\t\t\tvec3(0.634388, -0.049471, 0.),\n\t\t\t\tvec3(-0.688894, 0.007843, 0.),\n\t\t\t\tvec3(0.464034, -0.188818, 0.),\n\t\t\t\tvec3(-0.440840, 0.137486, 0.),\n\t\t\t\tvec3(0.364483, 0.511704, 0.),\n\t\t\t\tvec3(0.034028, 0.325968, 0.),\n\t\t\t\tvec3(0.099094, -0.308023, 0.),\n\t\t\t\tvec3(0.693960, -0.366253, 0.),\n\t\t\t\tvec3(0.678884, -0.204688, 0.),\n\t\t\t\tvec3(0.001801, 0.780328, 0.),\n\t\t\t\tvec3(0.145177, -0.898984, 0.),\n\t\t\t\tvec3(0.062655, -0.611866, 0.),\n\t\t\t\tvec3(0.315226, -0.604297, 0.),\n\t\t\t\tvec3(-0.780145, 0.486251, 0.),\n\t\t\t\tvec3(-0.371868, 0.882138, 0.),\n\t\t\t\tvec3(0.200476, 0.494430, 0.),\n\t\t\t\tvec3(-0.494552, -0.711051, 0.),\n\t\t\t\tvec3(0.612476, 0.705252, 0.),\n\t\t\t\tvec3(-0.578845, -0.768792, 0.),\n\t\t\t\tvec3(-0.772454, -0.090976, 0.),\n\t\t\t\tvec3(0.504440, 0.372295, 0.),\n\t\t\t\tvec3(0.155736, 0.065157, 0.),\n\t\t\t\tvec3(0.391522, 0.849605, 0.),\n\t\t\t\tvec3(-0.620106, -0.328104, 0.),\n\t\t\t\tvec3(0.789239, -0.419965, 0.),\n\t\t\t\tvec3(-0.545396, 0.538133, 0.),\n\t\t\t\tvec3(-0.178564, -0.596057, 0.)\n\t\t);\n\t\tfloat getRand(vec2 seed) {\n\t\t\t\treturn fract(sin(dot(seed.xy ,vec2(12.9898,78.233))) * 43758.5453);\n\t\t}\n\t\tfloat computeShadowWithPCSS(sampler2D depthSampler, sampler2DShadow shadowSampler, vec3 shadowCoord, float shadowMapSizeInverse, float lightSizeUV, int searchTapCount, int pcfTapCount, vec3[64] poissonSamplers) {\n\t\t\t\tfloat depthMetric = shadowCoord.z;\n\t\t\t\tfloat blockerDepth = 0.0;\n\t\t\t\tfloat sumBlockerDepth = 0.0;\n\t\t\t\tfloat numBlocker = 0.0;\n\t\t\t\tfor (int i = 0; i < searchTapCount; i++) {\n\t\t\t\t\t\tblockerDepth = unpackRGBAToDepth(texture(depthSampler, shadowCoord.xy + (lightSizeUV * shadowMapSizeInverse * PoissonSamplers32[i].xy)));\n\t\t\t\t\t\tif (blockerDepth < depthMetric) {\n\t\t\t\t\t\t\t\tsumBlockerDepth += blockerDepth;\n\t\t\t\t\t\t\t\tnumBlocker++;\n\t\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (numBlocker < 1.0) {\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t}\n\t\t\t\tfloat avgBlockerDepth = sumBlockerDepth / numBlocker;\n\t\t\t\tfloat AAOffset = shadowMapSizeInverse * 10.;\n\t\t\t\tfloat penumbraRatio = ((depthMetric - avgBlockerDepth) + AAOffset);\n\t\t\t\tfloat filterRadius = penumbraRatio * lightSizeUV * shadowMapSizeInverse;\n\t\t\t\tfloat random = getRand(shadowCoord.xy);\t\t\t\tfloat rotationAngle = random * 3.1415926;\n\t\t\t\tvec2 rotationVector = vec2(cos(rotationAngle), sin(rotationAngle));\n\t\t\t\tfloat shadow = 0.;\n\t\t\t\tfor (int i = 0; i < pcfTapCount; i++) {\n\t\t\t\t\t\tvec3 offset = poissonSamplers[i];\n\t\t\t\t\t\toffset = vec3(offset.x * rotationVector.x - offset.y * rotationVector.y, offset.y * rotationVector.x + offset.x * rotationVector.y, 0.);\n\t\t\t\t\t\tshadow += texture(shadowSampler, shadowCoord + offset * filterRadius);\n\t\t\t\t}\n\t\t\t\tshadow /= float(pcfTapCount);\n\t\t\t\tshadow = mix(shadow, 1., depthMetric - avgBlockerDepth);\n\t\t\t\treturn shadow;\n\t\t}\n\t\tfloat getShadowWithPCSS(sampler2D depthSampler, sampler2DShadow shadowMap, vec4 shadowCoord, vec2 shadowMapSize, vec2 shadowBias, vec2 shadowParams) {\n\t\t\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\t\t\tshadowCoord.z += shadowBias.x;\n\t\t\t\tbvec4 inFrustumVec = bvec4 (shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0);\n\t\t\t\tbool inFrustum = all(inFrustumVec);\n\t\t\t\tbvec2 frustumTestVec = bvec2(inFrustum, shadowCoord.z <= 1.0);\n\t\t\t\tbool frustumTest = all(frustumTestVec);\n\t\t\t\tfloat shadow = 1.0;\n\t\t\t\tif (frustumTest) {\n\t\t\t\t\t\t#ifdef USE_PCSS16_SOFT_SHADOW\n\t\t\t\t\t\t\t\tshadow = computeShadowWithPCSS(depthSampler, shadowMap, shadowCoord.xyz, 1. / shadowMapSize.x, 0.1 * shadowMapSize.x, 16, 16, PoissonSamplers32);\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\t\t#ifdef USE_PCSS32_SOFT_SHADOW\n\t\t\t\t\t\t\t\t\t\tshadow = computeShadowWithPCSS(depthSampler, shadowMap, shadowCoord.xyz, 1. / shadowMapSize.x, 0.1 * shadowMapSize.x, 16, 32, PoissonSamplers32);\n\t\t\t\t\t\t\t\t#else\n\t\t\t\t\t\t\t\t\t\tshadow = computeShadowWithPCSS(depthSampler, shadowMap, shadowCoord.xyz, 1. / shadowMapSize.x, 0.1 * shadowMapSize.x, 32, 64, PoissonSamplers64);\n\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tshadow = computeFallOff(shadow, shadowCoord.xy * 2. - 1., shadowParams.y);\n\t\t\t\t}\n\t\t\t\treturn shadow;\n\t\t}\n#endif",shadowMap_frag:"#ifdef USE_SHADOW\n#endif",shadowMap_pars_frag:"#ifdef USE_SHADOW\n\t#if NUM_DIR_SHADOWS > 0\n\t\tuniform sampler2DShadow directionalShadowMap[NUM_DIR_SHADOWS];\n\t\tvarying vec4 vDirectionalShadowCoord[NUM_DIR_SHADOWS];\n\t\t#ifdef USE_PCSS_SOFT_SHADOW\n\t\t\tuniform sampler2D directionalDepthMap[NUM_DIR_SHADOWS];\n\t\t#endif\n\t\tstruct DirectLightShadow {\n\t\t\tvec2 shadowBias;\n\t\t\tvec2 shadowMapSize;\n\t\t\tvec2 shadowParams;\n\t\t};\n\t\tuniform DirectLightShadow u_DirectionalShadow[NUM_DIR_SHADOWS];\n\t#endif\n\t#if NUM_POINT_SHADOWS > 0\n\t\tuniform samplerCube pointShadowMap[NUM_POINT_SHADOWS];\n\t\tvarying vec4 vPointShadowCoord[NUM_POINT_SHADOWS];\n\t\tstruct PointLightShadow {\n\t\t\tvec2 shadowBias;\n\t\t\tvec2 shadowMapSize;\n\t\t\tvec2 shadowParams;\n\t\t\tvec2 shadowCameraRange;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow u_PointShadow[NUM_POINT_SHADOWS];\n\t#endif\n\t#if NUM_SPOT_SHADOWS > 0\n\t\tuniform sampler2DShadow spotShadowMap[NUM_SPOT_SHADOWS];\n\t\tvarying vec4 vSpotShadowCoord[NUM_SPOT_SHADOWS];\n\t\t#ifdef USE_PCSS_SOFT_SHADOW\n\t\t\tuniform sampler2D spotDepthMap[NUM_SPOT_SHADOWS];\n\t\t#endif\n\t\tstruct SpotLightShadow {\n\t\t\tvec2 shadowBias;\n\t\t\tvec2 shadowMapSize;\n\t\t\tvec2 shadowParams;\n\t\t};\n\t\tuniform SpotLightShadow u_SpotShadow[NUM_SPOT_SHADOWS];\n\t#endif\n\t#include <packing>\n\t#include <shadow>\n#endif",shadowMap_pars_vert:"#ifdef USE_SHADOW\n\t#if NUM_DIR_SHADOWS > 0\n\t\tuniform mat4 directionalShadowMatrix[NUM_DIR_SHADOWS];\n\t\tvarying vec4 vDirectionalShadowCoord[NUM_DIR_SHADOWS];\n\t\tstruct DirectLightShadow {\n\t\t\tvec2 shadowBias;\n\t\t\tvec2 shadowMapSize;\n\t\t\tvec2 shadowParams;\n\t\t};\n\t\tuniform DirectLightShadow u_DirectionalShadow[NUM_DIR_SHADOWS];\n\t#endif\n\t#if NUM_POINT_SHADOWS > 0\n\t\tuniform mat4 pointShadowMatrix[NUM_POINT_SHADOWS];\n\t\tvarying vec4 vPointShadowCoord[NUM_POINT_SHADOWS];\n\t\tstruct PointLightShadow {\n\t\t\tvec2 shadowBias;\n\t\t\tvec2 shadowMapSize;\n\t\t\tvec2 shadowParams;\n\t\t\tvec2 shadowCameraRange;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow u_PointShadow[NUM_POINT_SHADOWS];\n\t#endif\n\t#if NUM_SPOT_SHADOWS > 0\n\t\tuniform mat4 spotShadowMatrix[NUM_SPOT_SHADOWS];\n\t\tvarying vec4 vSpotShadowCoord[NUM_SPOT_SHADOWS];\n\t\tstruct SpotLightShadow {\n\t\t\tvec2 shadowBias;\n\t\t\tvec2 shadowMapSize;\n\t\t\tvec2 shadowParams;\n\t\t};\n\t\tuniform SpotLightShadow u_SpotShadow[NUM_SPOT_SHADOWS];\n\t#endif\n#endif",shadowMap_vert:"\n#ifdef USE_SHADOW\n\t#if NUM_DIR_SHADOWS > 0 || NUM_POINT_SHADOWS > 0 || NUM_SPOT_SHADOWS > 0\n\t\tvec3 shadowWorldNormal = (transposeMat4(inverseMat4(u_Model)) * vec4(objectNormal, 0.0)).xyz;\n\t\tshadowWorldNormal = normalize(shadowWorldNormal);\n\t\tvec4 shadowWorldPosition;\n\t#endif\n\t#if NUM_DIR_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor (int i = 0; i < NUM_DIR_SHADOWS; i++) {\n\t\t\tshadowWorldPosition = worldPosition + vec4(shadowWorldNormal * u_DirectionalShadow[i].shadowBias[1], 0);\n\t\t\tvDirectionalShadowCoord[i] = directionalShadowMatrix[i] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor (int i = 0; i < NUM_POINT_SHADOWS; i++) {\n\t\t\tshadowWorldPosition = worldPosition + vec4(shadowWorldNormal * u_PointShadow[i].shadowBias[1], 0);\n\t\t\tvPointShadowCoord[i] = pointShadowMatrix[i] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor (int i = 0; i < NUM_SPOT_SHADOWS; i++) {\n\t\t\tshadowWorldPosition = worldPosition + vec4(shadowWorldNormal * u_SpotShadow[i].shadowBias[1], 0);\n\t\t\tvSpotShadowCoord[i] = spotShadowMatrix[i] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif",morphnormal_vert:"#ifdef USE_MORPHNORMALS\n\tobjectNormal += morphNormal0 * morphTargetInfluences[ 0 ];\n\tobjectNormal += morphNormal1 * morphTargetInfluences[ 1 ];\n\tobjectNormal += morphNormal2 * morphTargetInfluences[ 2 ];\n\tobjectNormal += morphNormal3 * morphTargetInfluences[ 3 ];\n#endif",morphtarget_pars_vert:"#ifdef USE_MORPHTARGETS\n\t#ifndef USE_MORPHNORMALS\n\tuniform float morphTargetInfluences[ 8 ];\n\t#else\n\tuniform float morphTargetInfluences[ 4 ];\n\t#endif\n#endif",morphtarget_vert:"#ifdef USE_MORPHTARGETS\n\ttransformed += morphTarget0 * morphTargetInfluences[ 0 ];\n\ttransformed += morphTarget1 * morphTargetInfluences[ 1 ];\n\ttransformed += morphTarget2 * morphTargetInfluences[ 2 ];\n\ttransformed += morphTarget3 * morphTargetInfluences[ 3 ];\n\t#ifndef USE_MORPHNORMALS\n\t\t\t\ttransformed += morphTarget4 * morphTargetInfluences[ 4 ];\n\t\t\t\ttransformed += morphTarget5 * morphTargetInfluences[ 5 ];\n\t\t\t\ttransformed += morphTarget6 * morphTargetInfluences[ 6 ];\n\t\t\t\ttransformed += morphTarget7 * morphTargetInfluences[ 7 ];\n\t#endif\n#endif",skinning_pars_vert:"#ifdef USE_SKINNING\n\t\tattribute vec4 skinIndex;\n\tattribute vec4 skinWeight;\n\t\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\t\t#ifdef BONE_TEXTURE\n\t\t\t\tuniform sampler2D boneTexture;\n\t\t\t\tuniform int boneTextureSize;\n\t\t\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\t\t\t\tfloat j = i * 4.0;\n\t\t\t\t\t\tfloat x = mod( j, float( boneTextureSize ) );\n\t\t\t\t\t\tfloat y = floor( j / float( boneTextureSize ) );\n\t\t\t\t\t\tfloat dx = 1.0 / float( boneTextureSize );\n\t\t\t\t\t\tfloat dy = 1.0 / float( boneTextureSize );\n\t\t\t\t\t\ty = dy * ( y + 0.5 );\n\t\t\t\t\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\t\t\t\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\t\t\t\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\t\t\t\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\t\t\t\t\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\t\t\t\t\t\treturn bone;\n\t\t\t\t}\n\t\t#else\n\t\t\t\tuniform mat4 boneMatrices[MAX_BONES];\n\t\t\t\tmat4 getBoneMatrix(const in float i) {\n\t\t\t\t\t\tmat4 bone = boneMatrices[int(i)];\n\t\t\t\t\t\treturn bone;\n\t\t\t\t}\n\t\t#endif\n#endif",skinning_vert:"#ifdef USE_SKINNING\n\t\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\t\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\t\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\t\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n\t\tvec4 skinVertex = bindMatrix * vec4(transformed, 1.0);\n\t\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\tskinned = bindMatrixInverse * skinned;\n\t\ttransformed = skinned.xyz / skinned.w;\n#endif",skinnormal_vert:"#ifdef USE_SKINNING\n\t\tmat4 skinMatrix = mat4( 0.0 );\n\t\tskinMatrix += skinWeight.x * boneMatX;\n\t\tskinMatrix += skinWeight.y * boneMatY;\n\t\tskinMatrix += skinWeight.z * boneMatZ;\n\t\tskinMatrix += skinWeight.w * boneMatW;\n\t\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\t\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularMap_frag:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, v_Uv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularMap_pars_frag:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",transpose:"mat4 transposeMat4(mat4 inMatrix) {\n\t\tvec4 i0 = inMatrix[0];\n\t\tvec4 i1 = inMatrix[1];\n\t\tvec4 i2 = inMatrix[2];\n\t\tvec4 i3 = inMatrix[3];\n\t\tmat4 outMatrix = mat4(\n\t\t\t\tvec4(i0.x, i1.x, i2.x, i3.x),\n\t\t\t\tvec4(i0.y, i1.y, i2.y, i3.y),\n\t\t\t\tvec4(i0.z, i1.z, i2.z, i3.z),\n\t\t\t\tvec4(i0.w, i1.w, i2.w, i3.w)\n\t\t);\n\t\treturn outMatrix;\n}",tsn:"mat3 tsn(vec3 N, vec3 V, vec2 uv) {\n\t\tvec3 q0 = vec3(dFdx(V.x), dFdx(V.y), dFdx(V.z));\n\t\tvec3 q1 = vec3(dFdy(V.x), dFdy(V.y), dFdy(V.z));\n\t\tvec2 st0 = dFdx( uv.st );\n\t\tvec2 st1 = dFdy( uv.st );\n\t\tfloat scale = sign( st1.t * st0.s - st0.t * st1.s );\n\t\tvec3 S = normalize( ( q0 * st1.t - q1 * st0.t ) * scale );\n\t\tvec3 T = normalize( ( -q0 * st1.s + q1 * st0.s ) * scale );\n\t\tmat3 tsn = mat3( S, T, N );\n\t\treturn tsn;\n}",uv_pars_frag:"#ifdef USE_UV1\n\t\tvarying vec2 v_Uv;\n#endif\n#ifdef USE_UV2\n\t\tvarying vec2 v_Uv2;\n#endif",uv_pars_vert:"#if defined(USE_UV1) || defined(USE_UV2)\n\t\tuniform mat3 uvTransform;\n#endif\n#ifdef USE_UV1\n\t\tattribute vec2 a_Uv;\n\t\tvarying vec2 v_Uv;\n#endif\n#ifdef USE_UV2\n\t\tattribute vec2 a_Uv2;\n\t\tvarying vec2 v_Uv2;\n#endif",uv_vert:"#ifdef USE_UV1\n\t\tv_Uv = (uvTransform * vec3(a_Uv, 1.)).xy;\n#endif\n#ifdef USE_UV2\n\t\tv_Uv2 = (uvTransform * vec3(a_Uv2, 1.)).xy;\n#endif",modelPos_pars_frag:"varying vec3 v_modelPos;",modelPos_pars_vert:"varying vec3 v_modelPos;",modelPos_vert:"\nv_modelPos = worldPosition.xyz;",logdepthbuf_frag:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tgl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_frag:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_pars_vert:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tuniform float logDepthCameraNear;\n\t\tvarying float vFragDepth;\n\t\tvarying float vIsPerspective;\n\t#else\n\t\tuniform float logDepthBufFC;\n\t\tuniform float logDepthCameraNear;\n\t#endif\n#endif",logdepthbuf_vert:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w - logDepthCameraNear;\n\t\tvIsPerspective = float( isPerspectiveMatrix( u_Projection ) );\n\t#else\n\t\tif ( isPerspectiveMatrix( u_Projection ) ) {\n\t\t\tgl_Position.z = log2( max( EPSILON, gl_Position.w - logDepthCameraNear + 1.0 ) ) * logDepthBufFC - 1.0;\n\t\t\tgl_Position.z *= gl_Position.w;\n\t\t}\n\t#endif\n#endif",clearcoat_pars_frag:"#ifdef USE_CLEARCOAT\n\tuniform float u_Clearcoat;\n\tuniform float u_ClearcoatRoughness;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform sampler2D clearcoatRoughnessMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n#endif"},si="#define USE_PBR\n#include <common_vert>\n#include <normal_pars_vert>\n#include <uv_pars_vert>\n#include <color_pars_vert>\n#include <modelPos_pars_vert>\n#include <envMap_pars_vert>\n#include <aoMap_pars_vert>\n#include <alphamap_pars_vert>\n#include <emissiveMap_pars_vert>\n#include <shadowMap_pars_vert>\n#include <morphtarget_pars_vert>\n#include <skinning_pars_vert>\n#include <logdepthbuf_pars_vert>\nvoid main() {\n\t\t#include <begin_vert>\n\t\t#include <morphtarget_vert>\n\t\t#include <morphnormal_vert>\n\t\t#include <skinning_vert>\n\t\t#include <skinnormal_vert>\n\t\t#include <pvm_vert>\n\t\t#include <normal_vert>\n\t\t#include <logdepthbuf_vert>\n\t\t#include <uv_vert>\n\t\t#include <color_vert>\n\t\t#include <modelPos_vert>\n\t\t#include <envMap_vert>\n\t\t#include <aoMap_vert>\n\t\t#include <alphamap_vert>\n\t\t#include <emissiveMap_vert>\n\t\t#include <shadowMap_vert>\n}",ui={basic_frag:"#include <common_frag>\n#include <uv_pars_frag>\n#include <color_pars_frag>\n#include <diffuseMap_pars_frag>\n#include <alphamap_pars_frag>\n#include <modelPos_pars_frag>\n#if defined(USE_ENV_MAP) && !defined(USE_VERTEX_ENVDIR)\n\t\t#include <normalMap_pars_frag>\n\t\t#include <normal_pars_frag>\t\t\n#endif\n#include <envMap_pars_frag>\n#include <aoMap_pars_frag>\n#include <fog_pars_frag>\n#include <logdepthbuf_pars_frag>\n#include <clippingPlanes_pars_frag>\nvoid main() {\n\t\t#include <clippingPlanes_frag>\n\t\t#include <logdepthbuf_frag>\n\t\t#include <begin_frag>\n\t\t#include <color_frag>\n\t\t#include <diffuseMap_frag>\n\t\t#include <alphamap_frag>\n\t\t#include <alphaTest_frag>\n\t\tReflectedLight reflectedLight = ReflectedLight(vec3(0.0), vec3(0.0), vec3(0.0), vec3(0.0));\n\t\treflectedLight.indirectDiffuse += vec3(1.0);\n\t\t#include <aoMap_frag>\n\t\treflectedLight.indirectDiffuse *= outColor.xyz;\n\t\toutColor.xyz = reflectedLight.indirectDiffuse;\n\t\t#if defined(USE_ENV_MAP) && !defined(USE_VERTEX_ENVDIR)\n\t\t\t\t#include <normal_frag>\n\t\t#endif\n\t\t#include <envMap_frag>\n\t\t#include <end_frag>\n\t\t#include <encodings_frag>\n\t\t#include <premultipliedAlpha_frag>\n\t\t#include <fog_frag>\n}",basic_vert:"#include <common_vert>\n#include <uv_pars_vert>\n#include <color_pars_vert>\n#include <modelPos_pars_vert>\n#if defined(USE_ENV_MAP) && !defined(USE_VERTEX_ENVDIR)\n\t\t#include <normal_pars_vert>\n#endif\n#include <envMap_pars_vert>\n#include <aoMap_pars_vert>\n#include <alphamap_pars_vert>\n#include <morphtarget_pars_vert>\n#include <skinning_pars_vert>\n#include <logdepthbuf_pars_vert>\nvoid main() {\n\t\t#include <begin_vert>\n\t\t#include <morphtarget_vert>\n\t\t#include <skinning_vert>\n\t\t#include <pvm_vert>\n\t\t#include <logdepthbuf_vert>\n\t\t#include <uv_vert>\n\t\t#include <color_vert>\n\t\t#include <modelPos_vert>\n\t\t#ifdef USE_ENV_MAP\n\t\t\t\t#include <morphnormal_vert>\n\t\t\t\t#include <skinnormal_vert>\n\t\t\t\t#ifndef USE_VERTEX_ENVDIR\n\t\t\t\t\t\t#include <normal_vert>\n\t\t\t\t#endif\t\n\t\t#endif\n\t\t#include <envMap_vert>\n\t\t#include <aoMap_vert>\n\t\t#include <alphamap_vert>\n}",depth_frag:"#include <common_frag>\n#include <diffuseMap_pars_frag>\n#include <modelPos_pars_frag>\n#include <uv_pars_frag>\n#include <packing>\n#include <logdepthbuf_pars_frag>\n#include <clippingPlanes_pars_frag>\nvoid main() {\n\t\t#include <clippingPlanes_frag>\n\t\t#if defined(USE_DIFFUSE_MAP) && defined(ALPHATEST)\n\t\t\t\tvec4 texelColor = texture2D( diffuseMap, v_Uv );\n\t\t\t\tfloat alpha = texelColor.a * u_Opacity;\n\t\t\t\tif(alpha < ALPHATEST) discard;\n\t\t#endif\n\t\t#include <logdepthbuf_frag>\n\t\t\n\t\t#ifdef DEPTH_PACKING_RGBA\n\t\t\t\tgl_FragColor = packDepthToRGBA(gl_FragCoord.z);\n\t\t#else\n\t\t\t\tgl_FragColor = vec4( vec3( 1.0 - gl_FragCoord.z ), u_Opacity );\n\t\t#endif\n}",depth_vert:"#include <common_vert>\n#include <morphtarget_pars_vert>\n#include <skinning_pars_vert>\n#include <uv_pars_vert>\n#include <modelPos_pars_vert>\n#include <logdepthbuf_pars_vert>\nvoid main() {\n\t\t#include <uv_vert>\n\t\t#include <begin_vert>\n\t\t#include <morphtarget_vert>\n\t\t#include <skinning_vert>\n\t\t#include <pvm_vert>\n\t\t#include <logdepthbuf_vert>\n\t\t#include <modelPos_vert>\n}",distance_frag:"#include <common_frag>\nuniform float nearDistance;\nuniform float farDistance;\n#include <modelPos_pars_frag>\n#include <packing>\n#include <clippingPlanes_pars_frag>\nvoid main() {\n\t\t#include <clippingPlanes_frag>\n\t\t\n\t\tfloat dist = length( v_modelPos - u_CameraPosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\t\tgl_FragColor = packDepthToRGBA(dist);\n}",distance_vert:"#include <common_vert>\n#include <modelPos_pars_vert>\n#include <morphtarget_pars_vert>\n#include <skinning_pars_vert>\nvoid main() {\n\t\t#include <begin_vert>\n\t\t#include <morphtarget_vert>\n\t\t#include <skinning_vert>\n\t\t#include <pvm_vert>\n\t\t#include <modelPos_vert>\n}",lambert_frag:"#define USE_LAMBERT\n#include <common_frag>\n#include <dithering_pars_frag>\nuniform vec3 emissive;\n#include <uv_pars_frag>\n#include <color_pars_frag>\n#include <diffuseMap_pars_frag>\n#include <normalMap_pars_frag>\n#include <alphamap_pars_frag>\n#include <bumpMap_pars_frag>\n#include <light_pars_frag>\n#include <normal_pars_frag>\n#include <modelPos_pars_frag>\n#include <bsdfs>\n#include <envMap_pars_frag>\n#include <aoMap_pars_frag>\n#include <shadowMap_pars_frag>\n#include <fog_pars_frag>\n#include <emissiveMap_pars_frag>\n#include <logdepthbuf_pars_frag>\n#include <clippingPlanes_pars_frag>\nvoid main() {\n\t\t#include <clippingPlanes_frag>\n\t\t#include <logdepthbuf_frag>\n\t\t#include <begin_frag>\n\t\t#include <color_frag>\n\t\t#include <diffuseMap_frag>\n\t\t#include <alphamap_frag>\n\t\t#include <alphaTest_frag>\n\t\t#include <normal_frag>\n\t\tReflectedLight reflectedLight = ReflectedLight(vec3(0.0), vec3(0.0), vec3(0.0), vec3(0.0));\n\t\t#include <light_frag>\n\t\t#include <aoMap_frag>\n\t\toutColor.xyz = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n\t\t#include <envMap_frag>\n\t\t#include <shadowMap_frag>\n\t\tvec3 totalEmissiveRadiance = emissive;\n\t\t#include <emissiveMap_frag>\n\t\toutColor.xyz += totalEmissiveRadiance;\n\t\t#include <end_frag>\n\t\t#include <encodings_frag>\n\t\t#include <premultipliedAlpha_frag>\n\t\t#include <fog_frag>\n\t\t#include <dithering_frag>\n}",lambert_vert:"#define USE_LAMBERT\n#include <common_vert>\n#include <normal_pars_vert>\n#include <uv_pars_vert>\n#include <color_pars_vert>\n#include <modelPos_pars_vert>\n#include <envMap_pars_vert>\n#include <aoMap_pars_vert>\n#include <alphamap_pars_vert>\n#include <emissiveMap_pars_vert>\n#include <shadowMap_pars_vert>\n#include <morphtarget_pars_vert>\n#include <skinning_pars_vert>\n#include <logdepthbuf_pars_vert>\nvoid main() {\n\t\t#include <begin_vert>\n\t\t#include <morphtarget_vert>\n\t\t#include <morphnormal_vert>\n\t\t#include <skinning_vert>\n\t\t#include <skinnormal_vert>\n\t\t#include <pvm_vert>\n\t\t#include <normal_vert>\n\t\t#include <logdepthbuf_vert>\n\t\t#include <uv_vert>\n\t\t#include <color_vert>\n\t\t#include <modelPos_vert>\n\t\t#include <envMap_vert>\n\t\t#include <aoMap_vert>\n\t\t#include <alphamap_vert>\n\t\t#include <emissiveMap_vert>\n\t\t#include <shadowMap_vert>\n}",normaldepth_frag:"#include <common_frag>\n#include <diffuseMap_pars_frag>\n#include <uv_pars_frag>\n#include <packing>\n#include <normal_pars_frag>\n#include <logdepthbuf_pars_frag>\nvoid main() {\n\t\t#if defined(USE_DIFFUSE_MAP) && defined(ALPHATEST)\n\t\t\t\tvec4 texelColor = texture2D( diffuseMap, v_Uv );\n\t\t\t\tfloat alpha = texelColor.a * u_Opacity;\n\t\t\t\tif(alpha < ALPHATEST) discard;\n\t\t#endif\n\t\t#include <logdepthbuf_frag>\n\t\tvec4 packedNormalDepth;\n\t\tpackedNormalDepth.xyz = normalize(v_Normal) * 0.5 + 0.5;\n\t\tpackedNormalDepth.w = gl_FragCoord.z;\n\t\tgl_FragColor = packedNormalDepth;\n}",normaldepth_vert:"#include <common_vert>\n#include <morphtarget_pars_vert>\n#include <skinning_pars_vert>\n#include <normal_pars_vert>\n#include <uv_pars_vert>\n#include <logdepthbuf_pars_vert>\nvoid main() {\n\t\t#include <uv_vert>\n\t\t#include <begin_vert>\n\t\t#include <morphtarget_vert>\n\t\t#include <morphnormal_vert>\n\t\t#include <skinning_vert>\n\t\t#include <skinnormal_vert>\n\t\t#include <normal_vert>\n\t\t#include <pvm_vert>\n\t\t#include <logdepthbuf_vert>\n}",pbr_frag:"#define USE_PBR\n#include <common_frag>\n#include <dithering_pars_frag>\nuniform float u_Metalness;\n#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif\nuniform float u_Roughness;\n#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif\nuniform vec3 emissive;\n#include <uv_pars_frag>\n#include <color_pars_frag>\n#include <diffuseMap_pars_frag>\n#include <alphamap_pars_frag>\n#include <normalMap_pars_frag>\n#include <bumpMap_pars_frag>\n#include <envMap_pars_frag>\n#include <aoMap_pars_frag>\n#include <light_pars_frag>\n#include <normal_pars_frag>\n#include <clearcoat_pars_frag>\n#include <modelPos_pars_frag>\n#include <bsdfs>\n#include <shadowMap_pars_frag>\n#include <fog_pars_frag>\n#include <emissiveMap_pars_frag>\n#include <logdepthbuf_pars_frag>\n#include <clippingPlanes_pars_frag>\nvoid main() {\n\t\t#include <clippingPlanes_frag>\n\t\t#include <logdepthbuf_frag>\n\t\t#include <begin_frag>\n\t\t#include <color_frag>\n\t\t#include <diffuseMap_frag>\n\t\t#include <alphamap_frag>\n\t\t#include <alphaTest_frag>\n\t\t#include <normal_frag>\n\t\tfloat roughnessFactor = u_Roughness;\n\t\t#ifdef USE_ROUGHNESSMAP\n\t\t\tvec4 texelRoughness = texture2D( roughnessMap, v_Uv );\n\t\t\troughnessFactor *= texelRoughness.g;\n\t\t#endif\n\t\tfloat metalnessFactor = u_Metalness;\n\t\t#ifdef USE_METALNESSMAP\n\t\t\tvec4 texelMetalness = texture2D( metalnessMap, v_Uv );\n\t\t\tmetalnessFactor *= texelMetalness.b;\n\t\t#endif\n\t\tReflectedLight reflectedLight = ReflectedLight(vec3(0.0), vec3(0.0), vec3(0.0), vec3(0.0));\n\t\t#include <light_frag>\n\t\t#include <aoMap_frag>\n\t\toutColor.xyz = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\t\t#include <shadowMap_frag>\n\t\tvec3 totalEmissiveRadiance = emissive;\n\t\t#include <emissiveMap_frag>\n\t\toutColor.xyz += totalEmissiveRadiance;\n\t\t#include <end_frag>\n\t\t#include <encodings_frag>\n\t\t#include <premultipliedAlpha_frag>\n\t\t#include <fog_frag>\n\t\t#include <dithering_frag>\n}",pbr_vert:si,pbr2_frag:"#define USE_PBR\n#define USE_PBR2\n#include <common_frag>\n#include <dithering_pars_frag>\nuniform vec3 u_SpecularColor;\n#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif\nuniform float glossiness;\n#ifdef USE_GLOSSINESSMAP\n\tuniform sampler2D glossinessMap;\n#endif\nuniform vec3 emissive;\n#include <uv_pars_frag>\n#include <color_pars_frag>\n#include <diffuseMap_pars_frag>\n#include <alphamap_pars_frag>\n#include <normalMap_pars_frag>\n#include <bumpMap_pars_frag>\n#include <envMap_pars_frag>\n#include <aoMap_pars_frag>\n#include <light_pars_frag>\n#include <normal_pars_frag>\n#include <modelPos_pars_frag>\n#include <bsdfs>\n#include <shadowMap_pars_frag>\n#include <fog_pars_frag>\n#include <emissiveMap_pars_frag>\n#include <logdepthbuf_pars_frag>\n#include <clippingPlanes_pars_frag>\nvoid main() {\n\t\t#include <clippingPlanes_frag>\n\t\t#include <logdepthbuf_frag>\n\t\t#include <begin_frag>\n\t\t#include <color_frag>\n\t\t#include <diffuseMap_frag>\n\t\t#include <alphamap_frag>\n\t\t#include <alphaTest_frag>\n\t\t#include <normal_frag>\n\t\tvec3 specularFactor = u_SpecularColor;\n\t\t#ifdef USE_SPECULARMAP\n\t\t\t\tvec4 texelSpecular = texture2D(specularMap, v_Uv);\n\t\t\t\ttexelSpecular = sRGBToLinear(texelSpecular);\n\t\t\t\tspecularFactor *= texelSpecular.rgb;\n\t\t#endif\n\t\tfloat glossinessFactor = glossiness;\n\t\t#ifdef USE_GLOSSINESSMAP\n\t\t\t\tvec4 texelGlossiness = texture2D(glossinessMap, v_Uv);\n\t\t\t\tglossinessFactor *= texelGlossiness.a;\n\t\t#endif\n\t\tReflectedLight reflectedLight = ReflectedLight(vec3(0.0), vec3(0.0), vec3(0.0), vec3(0.0));\n\t\t#include <light_frag>\n\t\t#include <aoMap_frag>\n\t\toutColor.xyz = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\t\t#include <shadowMap_frag>\n\t\tvec3 totalEmissiveRadiance = emissive;\n\t\t#include <emissiveMap_frag>\n\t\toutColor.xyz += totalEmissiveRadiance;\n\t\t#include <end_frag>\n\t\t#include <encodings_frag>\n\t\t#include <premultipliedAlpha_frag>\n\t\t#include <fog_frag>\n\t\t#include <dithering_frag>\n}",pbr2_vert:si,matcap_frag:"#define MATCAP\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#include <common_frag>\n#include <dithering_pars_frag>\n#include <uv_pars_frag>\n#include <color_pars_frag>\n#include <diffuseMap_pars_frag>\n#include <alphamap_pars_frag>\n#include <normalMap_pars_frag>\n#include <modelPos_pars_frag>\n#include <bumpMap_pars_frag>\n#include <normal_pars_frag>\n#include <fog_pars_frag>\n#include <logdepthbuf_pars_frag>\n#include <clippingPlanes_pars_frag>\nvoid main() {\n\t\t#include <clippingPlanes_frag>\n\t\t#include <logdepthbuf_frag>\n\t\t#include <begin_frag>\n\t\t#include <color_frag>\n\t\t#include <diffuseMap_frag>\n\t\t#include <alphamap_frag>\n\t\t#include <alphaTest_frag>\n\t\t#include <normal_frag>\n\t\tvec3 viewDir = normalize(vViewPosition);\n\tvec3 x = normalize(vec3(viewDir.z, 0.0, -viewDir.x));\n\tvec3 y = cross(viewDir, x);\n\t\tvec3 viewN = (u_View * vec4(N, 0.0)).xyz;\n\tvec2 uv = vec2(dot(x, viewN), dot(y, viewN)) * 0.495 + 0.5;\n\t\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D(matcap, uv);\n\t\tmatcapColor = matcapTexelToLinear(matcapColor);\n\t#else\n\t\tvec4 matcapColor = vec4(1.0);\n\t#endif\n\toutColor.rgb *= matcapColor.rgb;\n\t\t#include <end_frag>\n\t\t#include <encodings_frag>\n\t\t#include <premultipliedAlpha_frag>\n\t\t#include <fog_frag>\n\t\t#include <dithering_frag>\n}",matcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#include <common_vert>\n#include <normal_pars_vert>\n#include <uv_pars_vert>\n#include <color_pars_vert>\n#include <alphamap_pars_vert>\n#include <modelPos_pars_vert>\n#include <morphtarget_pars_vert>\n#include <skinning_pars_vert>\n#include <logdepthbuf_pars_vert>\nvoid main() {\n\t\t#include <begin_vert>\n\t\t#include <morphtarget_vert>\n\t\t#include <morphnormal_vert>\n\t\t#include <skinning_vert>\n\t\t#include <skinnormal_vert>\n\t\t#include <pvm_vert>\n\t\t#include <normal_vert>\n\t\t#include <logdepthbuf_vert>\n\t\t#include <uv_vert>\n\t\t#include <color_vert>\n\t\t#include <alphamap_vert>\n\t\t#include <modelPos_vert>\n\t\tvec4 mvPosition = u_View * worldPosition;\n\t\tvViewPosition = - mvPosition.xyz;\n}",phong_frag:"#define USE_PHONG\n#include <common_frag>\n#include <dithering_pars_frag>\nuniform float u_Specular;\nuniform vec3 u_SpecularColor;\n#include <specularMap_pars_frag>\nuniform vec3 emissive;\n#include <uv_pars_frag>\n#include <color_pars_frag>\n#include <diffuseMap_pars_frag>\n#include <alphamap_pars_frag>\n#include <normalMap_pars_frag>\n#include <bumpMap_pars_frag>\n#include <light_pars_frag>\n#include <normal_pars_frag>\n#include <modelPos_pars_frag>\n#include <bsdfs>\n#include <envMap_pars_frag>\n#include <aoMap_pars_frag>\n#include <shadowMap_pars_frag>\n#include <fog_pars_frag>\n#include <emissiveMap_pars_frag>\n#include <logdepthbuf_pars_frag>\n#include <clippingPlanes_pars_frag>\nvoid main() {\n\t\t#include <clippingPlanes_frag>\n\t\t#include <logdepthbuf_frag>\n\t\t#include <begin_frag>\n\t\t#include <color_frag>\n\t\t#include <diffuseMap_frag>\n\t\t#include <alphamap_frag>\n\t\t#include <alphaTest_frag>\n\t\t#include <normal_frag>\n\t\t#include <specularMap_frag>\n\t\tReflectedLight reflectedLight = ReflectedLight(vec3(0.0), vec3(0.0), vec3(0.0), vec3(0.0));\n\t\t#include <light_frag>\n\t\t#include <aoMap_frag>\n\t\toutColor.xyz = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\t\t#include <envMap_frag>\n\t\t#include <shadowMap_frag>\n\t\tvec3 totalEmissiveRadiance = emissive;\n\t\t#include <emissiveMap_frag>\n\t\toutColor.xyz += totalEmissiveRadiance;\n\t\t#include <end_frag>\n\t\t#include <encodings_frag>\n\t\t#include <premultipliedAlpha_frag>\n\t\t#include <fog_frag>\n\t\t#include <dithering_frag>\n}",phong_vert:"#define USE_PHONG\n#include <common_vert>\n#include <normal_pars_vert>\n#include <uv_pars_vert>\n#include <color_pars_vert>\n#include <modelPos_pars_vert>\n#include <envMap_pars_vert>\n#include <aoMap_pars_vert>\n#include <alphamap_pars_vert>\n#include <emissiveMap_pars_vert>\n#include <shadowMap_pars_vert>\n#include <morphtarget_pars_vert>\n#include <skinning_pars_vert>\n#include <logdepthbuf_pars_vert>\nvoid main() {\n\t\t#include <begin_vert>\n\t\t#include <morphtarget_vert>\n\t\t#include <morphnormal_vert>\n\t\t#include <skinning_vert>\n\t\t#include <skinnormal_vert>\n\t\t#include <pvm_vert>\n\t\t#include <normal_vert>\n\t\t#include <logdepthbuf_vert>\n\t\t#include <uv_vert>\n\t\t#include <color_vert>\n\t\t#include <modelPos_vert>\n\t\t#include <envMap_vert>\n\t\t#include <aoMap_vert>\n\t\t#include <alphamap_vert>\n\t\t#include <emissiveMap_vert>\n\t\t#include <shadowMap_vert>\n}",point_frag:"#include <common_frag>\n#include <color_pars_frag>\n#include <diffuseMap_pars_frag>\n#include <fog_pars_frag>\n#include <logdepthbuf_pars_frag>\nvoid main() {\n\t\t#include <begin_frag>\n\t\t#include <color_frag>\n\t\t#include <logdepthbuf_frag>\n\t\t#ifdef USE_DIFFUSE_MAP\n\t\t\t\toutColor *= texture2D(diffuseMap, vec2(gl_PointCoord.x, 1.0 - gl_PointCoord.y));\n\t\t#endif\n\t\t#include <end_frag>\n\t\t#include <encodings_frag>\n\t\t#include <premultipliedAlpha_frag>\n\t\t#include <fog_frag>\n}",point_vert:"#include <common_vert>\n#include <color_pars_vert>\n#include <logdepthbuf_pars_vert>\nuniform float u_PointSize;\nuniform float u_PointScale;\nvoid main() {\n\t\t#include <begin_vert>\n\t\t#include <pvm_vert>\n\t\t#include <color_vert>\n\t\tvec4 mvPosition = u_View * u_Model * vec4(transformed, 1.0);\n\t\t#ifdef USE_SIZEATTENUATION\n\t\t\t\tgl_PointSize = u_PointSize * ( u_PointScale / - mvPosition.z );\n\t\t#else\n\t\t\t\tgl_PointSize = u_PointSize;\n\t\t#endif\n\t\t#include <logdepthbuf_vert>\n}"},li=function(){function t(t,e,n){this._gl=t,this._state=e,this._capabilities=n,this._programs=[]}var e=t.prototype;return e.getProgram=function(t,e,n,i){for(var r,a=this._programs,o=function(t,e,n,i,r){var a=n.acceptLight?r.lights:null,o=n.fog?r.scene.fog:null,s=void 0!==n.envMap?n.envMap||r.scene.environment:null,u=r.scene.logarithmicDepthBuffer,l=r.scene.disableShadowSampler,c=n.clippingPlanes&&n.clippingPlanes.length>0?n.clippingPlanes.length:r.scene.numClippingPlanes,h={};h.shaderName=n.type===b.SHADER&&n.shaderName?n.shaderName:n.type,h.version=e.version,h.precision=n.precision||e.maxPrecision,h.useStandardDerivatives=e.version>=2||!!e.getExtension("OES_standard_derivatives")||!!e.getExtension("GL_OES_standard_derivatives"),h.useShaderTextureLOD=e.version>=2||!!e.getExtension("EXT_shader_texture_lod"),h.useDiffuseMap=n.diffuseMap?n.diffuseMapCoord+1:0,h.useAlphaMap=n.alphaMap?n.alphaMapCoord+1:0,h.useEmissiveMap=n.emissiveMap?n.emissiveMapCoord+1:0,h.useAOMap=n.aoMap?n.aoMapCoord+1:0,h.useNormalMap=!!n.normalMap,h.useBumpMap=!!n.bumpMap,h.useSpecularMap=!!n.specularMap,h.useRoughnessMap=!!n.roughnessMap,h.useMetalnessMap=!!n.metalnessMap,h.useGlossinessMap=!!n.glossinessMap,h.useMatcap=!!n.matcap,h.useEnvMap=!!s,h.envMapCombine=n.envMapCombine,h.useClearcoat=n.clearcoat>0,h.useClearcoatMap=h.useClearcoat&&!!n.clearcoatMap,h.useClearcoatRoughnessMap=h.useClearcoat&&!!n.clearcoatRoughnessMap,h.useClearcoatNormalMap=h.useClearcoat&&!!n.clearcoatNormalMap,h.useUv1=1===h.useDiffuseMap||1===h.useAlphaMap||1===h.useEmissiveMap||1===h.useAOMap||h.useNormalMap||h.useBumpMap||h.useSpecularMap||h.useRoughnessMap||h.useMetalnessMap||h.useGlossinessMap||h.useClearcoatMap||h.useClearcoatNormalMap||h.useClearcoatRoughnessMap,h.useUv2=2===h.useDiffuseMap||2===h.useAlphaMap||2===h.useEmissiveMap||2===h.useAOMap,h.useAmbientLight=!!a&&a.useAmbient,h.hemisphereLightNum=a?a.hemisNum:0,h.directLightNum=a?a.directsNum:0,h.pointLightNum=a?a.pointsNum:0,h.spotLightNum=a?a.spotsNum:0,h.directShadowNum=i.receiveShadow&&a?a.directShadowNum:0,h.pointShadowNum=i.receiveShadow&&a?a.pointShadowNum:0,h.spotShadowNum=i.receiveShadow&&a?a.spotShadowNum:0,h.useShadow=i.receiveShadow&&!!a&&a.shadowsNum>0,h.useShadowSampler=e.version>=2&&!l,h.shadowType=h.useShadowSampler?i.shadowType:z.POISSON_SOFT,h.dithering=n.dithering;var d=t.currentRenderTarget;h.gammaFactor=r.gammaFactor,h.outputEncoding=d.texture?ci(d.texture):r.outputEncoding,h.diffuseMapEncoding=ci(n.diffuseMap||n.cubeMap),h.envMapEncoding=ci(s),h.emissiveMapEncoding=ci(n.emissiveMap),h.matcapEncoding=ci(n.matcap),h.alphaTest=n.alphaTest,h.premultipliedAlpha=n.premultipliedAlpha,h.useVertexColors=n.vertexColors,h.useVertexTangents=!!n.normalMap&&n.vertexTangents,h.numClippingPlanes=c,h.flatShading=n.shading===D.FLAT_SHADING,h.fog=!!o,h.fogExp2=!!o&&o.isFogExp2,h.sizeAttenuation=n.sizeAttenuation,h.doubleSided=n.side===C.DOUBLE,h.flipSided=n.side===C.BACK,h.packDepthToRGBA=n.packToRGBA,h.logarithmicDepthBuffer=!!u,h.rendererExtensionFragDepth=e.version>=2||!!e.getExtension("EXT_frag_depth"),h.morphTargets=!!i.morphTargetInfluences,h.morphNormals=!!i.morphTargetInfluences&&i.geometry.morphAttributes.normal;var f=i.isSkinnedMesh&&i.skeleton,p=e.maxVertexUniformVectors,_=e.maxVertexTextures>0&&(!!e.getExtension("OES_texture_float")||e.version>=2),v=0;_?v=1024:16*(v=i.skeleton?i.skeleton.bones.length:0)>p&&(console.warn("Program: too many bones ("+v+"), current cpu only support "+Math.floor(p/16)+" bones!!"),v=Math.floor(p/16));return h.useSkinning=f,h.bonesNum=v,h.useVertexTexture=_,h}(this._state,this._capabilities,t,e,n),s=function(t,e){var n="";for(var i in t)n+=t[i]+"_";for(var r in e.defines)n+=r+"_"+e.defines[r]+"_";e.type!==b.SHADER||e.shaderName||(n+=e.vertexShader,n+=e.fragmentShader);return n}(o,t),u=0,l=a.length;u<l;u++){var c=a[u];if(c.code===s){++(r=c).usedTimes;break}}if(void 0===r){var h=function(t){var e=[];for(var n in t){var i=t[n];!1!==i&&e.push("#define "+n+" "+i)}return e.join("\n")}(t.defines),d=ui[t.type+"_vert"]||t.vertexShader||ui.basic_vert,f=ui[t.type+"_frag"]||t.fragmentShader||ui.basic_frag;r=function(t,e,n,i,r){var a=["precision "+n.precision+" float;","precision "+n.precision+" int;","precision "+n.precision+" sampler2D;","#define SHADER_NAME "+n.shaderName,e,n.version>=2?"#define WEBGL2":"",n.useRoughnessMap?"#define USE_ROUGHNESSMAP":"",n.useMetalnessMap?"#define USE_METALNESSMAP":"",n.useGlossinessMap?"#define USE_GLOSSINESSMAP":"",n.useAmbientLight?"#define USE_AMBIENT_LIGHT":"",n.pointLightNum>0||n.directLightNum>0||n.useAmbientLight||n.hemisphereLightNum>0||n.spotLightNum>0?"#define USE_LIGHT":"",n.useNormalMap?"#define USE_NORMAL_MAP":"",n.useBumpMap?"#define USE_BUMPMAP":"",n.useSpecularMap?"#define USE_SPECULARMAP":"",n.useEmissiveMap?"#define USE_EMISSIVEMAP "+n.useEmissiveMap:"",n.useShadow?"#define USE_SHADOW":"",n.flatShading?"#define FLAT_SHADED":"",n.flipSided?"#define FLIP_SIDED":"",n.useDiffuseMap?"#define USE_DIFFUSE_MAP "+n.useDiffuseMap:"",n.useAlphaMap?"#define USE_ALPHA_MAP "+n.useAlphaMap:"",n.useEnvMap?"#define USE_ENV_MAP":"",n.sizeAttenuation?"#define USE_SIZEATTENUATION":"",n.useAOMap?"#define USE_AOMAP "+n.useAOMap:"",n.useVertexColors==X.RGB?"#define USE_VCOLOR_RGB":"",n.useVertexColors==X.RGBA?"#define USE_VCOLOR_RGBA":"",n.useVertexTangents?"#define USE_TANGENT":"",n.useUv1?"#define USE_UV1":"",n.useUv2?"#define USE_UV2":"",n.fog?"#define USE_FOG":"",n.morphTargets?"#define USE_MORPHTARGETS":"",n.morphNormals&&!1===n.flatShading?"#define USE_MORPHNORMALS":"",n.useSkinning?"#define USE_SKINNING":"",n.bonesNum>0?"#define MAX_BONES "+n.bonesNum:"",n.useVertexTexture?"#define BONE_TEXTURE":"",n.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",n.logarithmicDepthBuffer&&n.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","\n"].filter(_i).join("\n"),o=[n.useStandardDerivatives&&n.version<2?"#extension GL_OES_standard_derivatives : enable":"",n.useShaderTextureLOD&&n.version<2?"#extension GL_EXT_shader_texture_lod : enable":"",n.logarithmicDepthBuffer&&n.rendererExtensionFragDepth&&n.version<2?"#extension GL_EXT_frag_depth : enable":"","precision "+n.precision+" float;","precision "+n.precision+" int;","precision "+n.precision+" sampler2D;",n.version>=2?"precision "+n.precision+" sampler2DShadow;":"",n.version>=2?"precision "+n.precision+" samplerCubeShadow;":"","#define SHADER_NAME "+n.shaderName,"#define PI 3.14159265359","#define EPSILON 1e-6","float pow2(const in float x) { return x * x; }","#define LOG2 1.442695","#define RECIPROCAL_PI 0.31830988618","#define saturate(a) clamp(a, 0.0, 1.0)","#define whiteCompliment(a) (1.0 - saturate(a))","highp float rand(const in vec2 uv) {","\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;","\thighp float dt = dot(uv.xy, vec2(a, b)), sn = mod(dt, PI);","\treturn fract(sin(sn) * c);","}",e,n.version>=2?"#define WEBGL2":"",n.useShadowSampler?"#define USE_SHADOW_SAMPLER":"#define sampler2DShadow sampler2D",n.useRoughnessMap?"#define USE_ROUGHNESSMAP":"",n.useMetalnessMap?"#define USE_METALNESSMAP":"",n.useGlossinessMap?"#define USE_GLOSSINESSMAP":"",n.useClearcoat?"#define USE_CLEARCOAT":"",n.useClearcoatMap?"#define USE_CLEARCOATMAP":"",n.useClearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",n.useClearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",n.useAmbientLight?"#define USE_AMBIENT_LIGHT":"",n.pointLightNum>0||n.directLightNum>0||n.useAmbientLight||n.hemisphereLightNum>0||n.spotLightNum>0?"#define USE_LIGHT":"",n.useNormalMap?"#define USE_NORMAL_MAP":"",n.useBumpMap?"#define USE_BUMPMAP":"",n.useSpecularMap?"#define USE_SPECULARMAP":"",n.useEmissiveMap?"#define USE_EMISSIVEMAP "+n.useEmissiveMap:"",n.useShadow?"#define USE_SHADOW":"",n.shadowType===z.HARD?"#define USE_HARD_SHADOW":"",n.shadowType===z.POISSON_SOFT?"#define USE_POISSON_SOFT_SHADOW":"",n.shadowType===z.PCF3_SOFT?"#define USE_PCF3_SOFT_SHADOW":"",n.shadowType===z.PCF5_SOFT?"#define USE_PCF5_SOFT_SHADOW":"",n.shadowType===z.PCSS16_SOFT?"#define USE_PCSS16_SOFT_SHADOW":"",n.shadowType===z.PCSS32_SOFT?"#define USE_PCSS32_SOFT_SHADOW":"",n.shadowType===z.PCSS64_SOFT?"#define USE_PCSS64_SOFT_SHADOW":"",n.shadowType===z.PCSS16_SOFT||n.shadowType===z.PCSS32_SOFT||n.shadowType===z.PCSS64_SOFT?"#define USE_PCSS_SOFT_SHADOW":"",n.flatShading?"#define FLAT_SHADED":"",n.doubleSided?"#define DOUBLE_SIDED":"",n.useShaderTextureLOD?"#define TEXTURE_LOD_EXT":"",n.useDiffuseMap?"#define USE_DIFFUSE_MAP "+n.useDiffuseMap:"",n.useAlphaMap?"#define USE_ALPHA_MAP "+n.useAlphaMap:"",n.useEnvMap?"#define USE_ENV_MAP":"",n.useAOMap?"#define USE_AOMAP "+n.useAOMap:"",n.useVertexColors==X.RGB?"#define USE_VCOLOR_RGB":"",n.useVertexColors==X.RGBA?"#define USE_VCOLOR_RGBA":"",n.useVertexTangents?"#define USE_TANGENT":"",n.premultipliedAlpha?"#define USE_PREMULTIPLIED_ALPHA":"",n.fog?"#define USE_FOG":"",n.fogExp2?"#define USE_EXP2_FOG":"",n.alphaTest?"#define ALPHATEST "+n.alphaTest:"",n.useEnvMap?"#define "+n.envMapCombine:"","#define GAMMA_FACTOR "+n.gammaFactor,n.useMatcap?"#define USE_MATCAP":"",n.useUv1?"#define USE_UV1":"",n.useUv2?"#define USE_UV2":"",n.dithering?"#define DITHERING":"",oi.encodings_pars_frag,di("mapTexelToLinear",n.diffuseMapEncoding),n.useEnvMap?di("envMapTexelToLinear",n.envMapEncoding):"",n.useEmissiveMap?di("emissiveMapTexelToLinear",n.emissiveMapEncoding):"",n.useMatcap?di("matcapTexelToLinear",n.matcapEncoding):"",fi("linearToOutputTexel",n.outputEncoding),n.packDepthToRGBA?"#define DEPTH_PACKING_RGBA":"",n.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",n.logarithmicDepthBuffer&&n.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","\n"].filter(_i).join("\n"),s=i,u=r;if(s=pi(s),u=pi(u),s=vi(s,n),u=vi(u,n),s=mi(s,n),u=mi(u,n),s=Si(s),u=Si(u),n.version>1){a=["#version 300 es\n","#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+a,u=u.replace("#extension GL_EXT_draw_buffers : require","");for(var l=0,c=[];u.indexOf("gl_FragData["+l+"]")>-1;)u=u.replace("gl_FragData["+l+"]","pc_fragData"+l),c.push("layout(location = "+l+") out highp vec4 pc_fragData"+l+";"),l++;o=["#version 300 es\n","#define varying in",u.indexOf("layout")>-1||c.length>0?"":"out highp vec4 pc_fragColor;","#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad",c.join("\n")].join("\n")+"\n"+o}return new ii(t,s=a+s,u=o+u)}(this._gl,h,o,d,f),r.compile(i),r.code=s,a.push(r)}return r},e.releaseProgram=function(t){if(0==--t.usedTimes){var e=this._programs,n=e.indexOf(t);e[n]=e[e.length-1],e.pop(),t.dispose(this._gl)}},t}();function ci(t){var e;return t?t.encoding&&(e=t.encoding):e=H.LINEAR,e}function hi(t){switch(t){case H.LINEAR:return["Linear","(value)"];case H.SRGB:return["sRGB","(value)"];case H.RGBE:return["RGBE","(value)"];case H.RGBM7:return["RGBM","(value, 7.0)"];case H.RGBM16:return["RGBM","(value, 16.0)"];case H.RGBD:return["RGBD","(value, 256.0)"];case H.GAMMA:return["Gamma","(value, float(GAMMA_FACTOR))"];default:console.error("unsupported encoding: "+t)}}function di(t,e){var n=hi(e);return"vec4 "+t+"(vec4 value) { return "+n[0]+"ToLinear"+n[1]+"; }"}function fi(t,e){var n=hi(e);return"vec4 "+t+"(vec4 value) { return LinearTo"+n[0]+n[1]+"; }"}var pi=function t(e){return e.replace(/#include +<([\w\d.]+)>/g,(function(e,n){var i=oi[n];if(void 0===i)throw new Error("Can not resolve #include <"+n+">");return t(i)}))};function _i(t){return""!==t}function vi(t,e){return t.replace(/NUM_HEMI_LIGHTS/g,e.hemisphereLightNum).replace(/NUM_DIR_LIGHTS/g,e.directLightNum).replace(/NUM_SPOT_LIGHTS/g,e.spotLightNum).replace(/NUM_POINT_LIGHTS/g,e.pointLightNum).replace(/NUM_DIR_SHADOWS/g,e.directShadowNum).replace(/NUM_SPOT_SHADOWS/g,e.spotShadowNum).replace(/NUM_POINT_SHADOWS/g,e.pointShadowNum)}function mi(t,e){return t.replace(/NUM_CLIPPING_PLANES/g,e.numClippingPlanes)}var gi=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function Ei(t,e,n,i){for(var r="",a=parseInt(e);a<parseInt(n);a++)r+=i.replace(/\[\s*i\s*\]/g,"["+a+"]").replace(/UNROLLED_LOOP_INDEX/g,a);return r}function Si(t){return t.replace(gi,Ei)}var Mi=function(){function t(t){this._gl=t,this._extensions={},this.version=parseFloat(/^WebGL\ (\d)/.exec(t.getParameter(t.VERSION))[1]);var e=this.getExtension("EXT_texture_filter_anisotropic");this.anisotropyExt=e,this.maxAnisotropy=null!==e?t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1;var n=null,i=!1;try{var r,a;if(this.version>1){if(n=this.getExtension("EXT_disjoint_timer_query_webgl2"))i=(null!=(r=t.getQuery(n.TIMESTAMP_EXT,n.QUERY_COUNTER_BITS_EXT))?r:0)>0}else if(n=this.getExtension("EXT_disjoint_timer_query"))i=(null!=(a=n.getQueryEXT(n.TIMESTAMP_EXT,n.QUERY_COUNTER_BITS_EXT))?a:0)>0}catch(t){console.warn(t)}this.timerQuery=n,this.canUseTimestamp=i,this.maxPrecision=function(t,e){if("highp"===e){if(t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT).precision>0&&t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT).precision>0)return"highp";e="mediump"}if("mediump"===e&&t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT).precision>0&&t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT).precision>0)return"mediump";return"lowp"}(t,"highp"),this.maxTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubemapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxVertexUniformVectors=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this.maxSamples=this.version>1?t.getParameter(t.MAX_SAMPLES):1,this.lineWidthRange=t.getParameter(t.ALIASED_LINE_WIDTH_RANGE)}return t.prototype.getExtension=function(t){var e=this._gl,n=this._extensions;if(void 0!==n[t])return n[t];var i=null;for(var r in Ti)if(i=e.getExtension(Ti[r]+t))break;return n[t]=i,i},t}(),Ti=["","WEBKIT_","MOZ_"];var yi=function(){function t(t,e){this._gl=t,this._capabilities=e}var e=t.prototype;return e.getGLType=function(t){var e,n=this._gl,i=this._capabilities,r=i.version>=2;if(t===F.UNSIGNED_BYTE)return n.UNSIGNED_BYTE;if(t===F.UNSIGNED_SHORT_5_6_5)return n.UNSIGNED_SHORT_5_6_5;if(t===F.UNSIGNED_SHORT_4_4_4_4)return n.UNSIGNED_SHORT_4_4_4_4;if(t===F.UNSIGNED_SHORT_5_5_5_1)return n.UNSIGNED_SHORT_5_5_5_1;if(r){if(t===F.UNSIGNED_SHORT)return n.UNSIGNED_SHORT;if(t===F.UNSIGNED_INT)return n.UNSIGNED_INT;if(t===F.UNSIGNED_INT_24_8)return n.UNSIGNED_INT_24_8;if(t===F.FLOAT)return n.FLOAT;if(t===F.HALF_FLOAT)return n.HALF_FLOAT;if(t===F.FLOAT_32_UNSIGNED_INT_24_8_REV)return n.FLOAT_32_UNSIGNED_INT_24_8_REV;if(t===F.BYTE)return n.BYTE;if(t===F.SHORT)return n.SHORT;if(t===F.INT)return n.INT}else{if(t===F.UNSIGNED_SHORT||t===F.UNSIGNED_INT||t===F.UNSIGNED_INT_24_8){if(!(e=i.getExtension("WEBGL_depth_texture")))return console.warn("extension WEBGL_depth_texture is not support."),null;if(t===F.UNSIGNED_SHORT)return n.UNSIGNED_SHORT;if(t===F.UNSIGNED_INT)return n.UNSIGNED_INT;if(t===F.UNSIGNED_INT_24_8)return e.UNSIGNED_INT_24_8_WEBGL}if(t===F.FLOAT)return(e=i.getExtension("OES_texture_float"))?n.FLOAT:(console.warn("extension OES_texture_float is not support."),null);if(t===F.HALF_FLOAT)return(e=i.getExtension("OES_texture_half_float"))?e.HALF_FLOAT_OES:(console.warn("extension OES_texture_half_float is not support."),null)}return void 0!==n[t]?n[t]:t},e.getGLFormat=function(t){var e,n=this._gl,i=this._capabilities;if(t===O.RGB)return n.RGB;if(t===O.RGBA)return n.RGBA;if(t===O.ALPHA)return n.ALPHA;if(t===O.LUMINANCE)return n.LUMINANCE;if(t===O.LUMINANCE_ALPHA)return n.LUMINANCE_ALPHA;if(t===O.DEPTH_COMPONENT)return n.DEPTH_COMPONENT;if(t===O.DEPTH_STENCIL)return n.DEPTH_STENCIL;if(t===O.RED)return n.RED;if(t===O.RED_INTEGER)return n.RED_INTEGER;if(t===O.RG)return n.RG;if(t===O.RG_INTEGER)return n.RG_INTEGER;if(t===O.RGB_INTEGER)return n.RGB_INTEGER;if(t===O.RGBA_INTEGER)return n.RGBA_INTEGER;if(t===O.RGB_S3TC_DXT1||t===O.RGBA_S3TC_DXT1||t===O.RGBA_S3TC_DXT3||t===O.RGBA_S3TC_DXT5){if(!(e=i.getExtension("WEBGL_compressed_texture_s3tc")))return console.warn("extension WEBGL_compressed_texture_s3tc is not support."),null;if(t===O.RGB_S3TC_DXT1)return e.COMPRESSED_RGB_S3TC_DXT1_EXT;if(t===O.RGBA_S3TC_DXT1)return e.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(t===O.RGBA_S3TC_DXT3)return e.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(t===O.RGBA_S3TC_DXT5)return e.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(t===O.RGB_PVRTC_4BPPV1||t===O.RGB_PVRTC_2BPPV1||t===O.RGBA_PVRTC_4BPPV1||t===O.RGBA_PVRTC_2BPPV1){if(!(e=i.getExtension("WEBGL_compressed_texture_pvrtc")))return console.warn("extension WEBGL_compressed_texture_pvrtc is not support."),null;if(t===O.RGB_PVRTC_4BPPV1)return e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(t===O.RGB_PVRTC_2BPPV1)return e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(t===O.RGBA_PVRTC_4BPPV1)return e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(t===O.RGBA_PVRTC_2BPPV1)return e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}return t===O.RGB_ETC1?(e=i.getExtension("WEBGL_compressed_texture_etc1"))?e.COMPRESSED_RGB_ETC1_WEBGL:(console.warn("extension WEBGL_compressed_texture_etc1 is not support."),null):t===O.RGBA_ASTC_4x4?(e=i.getExtension("WEBGL_compressed_texture_astc"))?e.COMPRESSED_RGBA_ASTC_4x4_KHR:(console.warn("extension WEBGL_compressed_texture_astc is not support."),null):t===O.RGBA_BPTC?(e=i.getExtension("EXT_texture_compression_bptc"))?e.COMPRESSED_RGBA_BPTC_UNORM_EXT:(console.warn("extension EXT_texture_compression_bptc is not support."),null):void 0!==n[t]?n[t]:t},e.getGLInternalFormat=function(t){var e,n=this._gl,i=this._capabilities,r=i.version>=2;if(t===O.RGBA4)return n.RGBA4;if(t===O.RGB5_A1)return n.RGB5_A1;if(t===O.DEPTH_COMPONENT16)return n.DEPTH_COMPONENT16;if(t===O.STENCIL_INDEX8)return n.STENCIL_INDEX8;if(t===O.DEPTH_STENCIL)return n.DEPTH_STENCIL;if(r){if(t===O.R8)return n.R8;if(t===O.RG8)return n.RG8;if(t===O.RGB8)return n.RGB8;if(t===O.RGBA8)return n.RGBA8;if(t===O.DEPTH_COMPONENT24)return n.DEPTH_COMPONENT24;if(t===O.DEPTH_COMPONENT32F)return n.DEPTH_COMPONENT32F;if(t===O.DEPTH24_STENCIL8)return n.DEPTH24_STENCIL8;if(t===O.DEPTH32F_STENCIL8)return n.DEPTH32F_STENCIL8;if(t===O.R16F||t===O.RG16F||t===O.RGB16F||t===O.RGBA16F||t===O.R32F||t===O.RG32F||t===O.RGB32F||t===O.RGBA32F){if(!(e=i.getExtension("EXT_color_buffer_float")))return console.warn("extension EXT_color_buffer_float is not support."),null;if(t===O.R16F)return n.R16F;if(t===O.RG16F)return n.RG16F;if(t===O.RGB16F)return n.RGB16F;if(t===O.RGBA16F)return n.RGBA16F;if(t===O.R32F)return n.R32F;if(t===O.RG32F)return n.RG32F;if(t===O.RGB32F)return n.RGB32F;if(t===O.RGBA32F)return n.RGBA32F}}else if(t===O.RGBA32F||t===O.RGB32F){if(!(e=i.getExtension("WEBGL_color_buffer_float")))return console.warn("extension WEBGL_color_buffer_float is not support."),null;if(t===O.RGBA32F)return e.RGBA32F_EXT;if(t===O.RGB32F)return e.RGB32F_EXT}return void 0!==n[t]?n[t]:t},t}();function xi(t,e,n,i){var r=new Uint8Array(4),a=t.createTexture();t.bindTexture(e,a),t.texParameteri(e,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(e,t.TEXTURE_MAG_FILTER,t.NEAREST);for(var o=0;o<i;o++)t.texImage2D(n+o,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,r);return a}function wi(t){var e=!1,n=new Yt,i=null,r=new Yt(0,0,0,0);return{setMask:function(n){i===n||e||(t.colorMask(n,n,n,n),i=n)},setLocked:function(t){e=t},setClear:function(e,i,a,o,s){!0===s&&(e*=o,i*=o,a*=o),n.set(e,i,a,o),!1===r.equals(n)&&(t.clearColor(e,i,a,o),r.copy(n))},getClear:function(){return r},reset:function(){e=!1,i=null,r.set(-1,0,0,0)}}}function Ai(t,e){var n=!1,i=null,r=null,a=null;return{setTest:function(n){n?e.enable(t.DEPTH_TEST):e.disable(t.DEPTH_TEST)},setMask:function(e){i===e||n||(t.depthMask(e),i=e)},setFunc:function(e){r!==e&&(t.depthFunc(e),r=e)},setLocked:function(t){n=t},setClear:function(e){a!==e&&(t.clearDepth(e),a=e)},reset:function(){n=!1,i=null,r=null,a=null}}}function bi(t,e){var n=!1,i=null,r=null,a=null,o=null,s=null,u=null,l=null,c=null,h=null,d=null,f=null,p=null,_=null,v=null;return{setTest:function(n){n?e.enable(t.STENCIL_TEST):e.disable(t.STENCIL_TEST)},setMask:function(e){i===e||n||(t.stencilMask(e),i=e)},setFunc:function(e,n,i,s,u,l){r===e&&a===n&&o===i&&c===s&&h===u&&d===l||(null===s||null===u||null===l?t.stencilFunc(e,n,i):(t.stencilFuncSeparate(t.FRONT,e,n,i),t.stencilFuncSeparate(t.BACK,s,u,l)),r=e,a=n,o=i,c=s,h=u,d=l)},setOp:function(e,n,i,r,a,o){s===e&&u===n&&l===i&&f===r&&p===a&&_===o||(null===r||null===a||null===o?t.stencilOp(e,n,i):(t.stencilOpSeparate(t.FRONT,e,n,i),t.stencilOpSeparate(t.BACK,r,a,o)),s=e,u=n,l=i,f=r,p=a,_=o)},setLocked:function(t){n=t},setClear:function(e){v!==e&&(t.clearStencil(e),v=e)},reset:function(){n=!1,i=null,r=null,a=null,o=null,s=null,u=null,l=null,c=null,h=null,d=null,f=null,p=null,_=null,v=null}}}var Ri=function(){function t(t,e){var n,i;this.gl=t,this.capabilities=e,this.colorBuffer=new wi(t),this.depthBuffer=new Ai(t,this),this.stencilBuffer=new bi(t,this),this.states={},this.currentBlending=null,this.currentBlendEquation=null,this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendEquationAlpha=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null,this.currentPremultipliedAlpha=null,this.currentFlipSided=!1,this.currentCullFace=null;var r=t.getParameter(t.VIEWPORT);this.currentViewport=(new Yt).fromArray(r),this.currentLineWidth=null,this.currentPolygonOffsetFactor=null,this.currentPolygonOffsetUnits=null,this.currentProgram=null,this.currentBoundBuffers={},this.currentRenderTarget=null,this.currentTextureSlot=null,this.currentBoundTextures={},this.emptyTextures={},this.emptyTextures[t.TEXTURE_2D]=xi(t,t.TEXTURE_2D,t.TEXTURE_2D,1),this.emptyTextures[t.TEXTURE_CUBE_MAP]=xi(t,t.TEXTURE_CUBE_MAP,t.TEXTURE_CUBE_MAP_POSITIVE_X,6),this.blendEquationToGL=((n={})[N.ADD]=t.FUNC_ADD,n[N.SUBTRACT]=t.FUNC_SUBTRACT,n[N.REVERSE_SUBTRACT]=t.FUNC_REVERSE_SUBTRACT,n),this.blendFactorToGL=((i={})[P.ZERO]=t.ZERO,i[P.ONE]=t.ONE,i[P.SRC_COLOR]=t.SRC_COLOR,i[P.SRC_ALPHA]=t.SRC_ALPHA,i[P.SRC_ALPHA_SATURATE]=t.SRC_ALPHA_SATURATE,i[P.DST_COLOR]=t.DST_COLOR,i[P.DST_ALPHA]=t.DST_ALPHA,i[P.ONE_MINUS_SRC_COLOR]=t.ONE_MINUS_SRC_COLOR,i[P.ONE_MINUS_SRC_ALPHA]=t.ONE_MINUS_SRC_ALPHA,i[P.ONE_MINUS_DST_COLOR]=t.ONE_MINUS_DST_COLOR,i[P.ONE_MINUS_DST_ALPHA]=t.ONE_MINUS_DST_ALPHA,i),this.colorBuffer.setClear(0,0,0,1),this.depthBuffer.setClear(1),this.stencilBuffer.setClear(0),this.depthBuffer.setTest(!0),this.depthBuffer.setFunc(B.LEQUAL),this.setFlipSided(!1),this.setCullFace(L.BACK)}var e=t.prototype;return e.enable=function(t){!0!==this.states[t]&&(this.gl.enable(t),this.states[t]=!0)},e.disable=function(t){!1!==this.states[t]&&(this.gl.disable(t),this.states[t]=!1)},e.setBlending=function(t,e,n,i,r,a,o,s){var u=this.gl;if(t!==R.NONE){if(this.enable(u.BLEND),t!==R.CUSTOM)t===this.currentBlending&&s===this.currentPremultipliedAlpha||(this.currentBlendEquation===N.ADD&&this.currentBlendEquationAlpha===N.ADD||(u.blendEquation(u.FUNC_ADD),this.currentBlendEquation=N.ADD,this.currentBlendEquationAlpha=N.ADD),t===R.NORMAL?s?u.blendFuncSeparate(u.ONE,u.ONE_MINUS_SRC_ALPHA,u.ONE,u.ONE_MINUS_SRC_ALPHA):u.blendFuncSeparate(u.SRC_ALPHA,u.ONE_MINUS_SRC_ALPHA,u.ONE,u.ONE_MINUS_SRC_ALPHA):t===R.ADD?s?u.blendFunc(u.ONE,u.ONE):u.blendFunc(u.SRC_ALPHA,u.ONE):t===R.SUB?u.blendFuncSeparate(u.ZERO,u.ONE_MINUS_SRC_COLOR,u.ZERO,u.ONE):t===R.MUL?s?u.blendFuncSeparate(u.ZERO,u.SRC_COLOR,u.ZERO,u.SRC_ALPHA):u.blendFunc(u.ZERO,u.SRC_COLOR):console.error("WebGLState: Invalid blending: ",t)),this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null;else{r=r||e,a=a||n,o=o||i;var l=this.blendEquationToGL,c=this.blendFactorToGL;e===this.currentBlendEquation&&r===this.currentBlendEquationAlpha||(u.blendEquationSeparate(l[e],l[r]),this.currentBlendEquation=e,this.currentBlendEquationAlpha=r),n===this.currentBlendSrc&&i===this.currentBlendDst&&a===this.currentBlendSrcAlpha&&o===this.currentBlendDstAlpha||(u.blendFuncSeparate(c[n],c[i],c[a],c[o]),this.currentBlendSrc=n,this.currentBlendDst=i,this.currentBlendSrcAlpha=a,this.currentBlendDstAlpha=o)}this.currentBlending=t,this.currentPremultipliedAlpha=s}else this.disable(u.BLEND)},e.setFlipSided=function(t){var e=this.gl;this.currentFlipSided!==t&&(t?e.frontFace(e.CW):e.frontFace(e.CCW),this.currentFlipSided=t)},e.setCullFace=function(t){var e=this.gl;t!==L.NONE?(this.enable(e.CULL_FACE),t!==this.currentCullFace&&(t===L.BACK?e.cullFace(e.BACK):t===L.FRONT?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):this.disable(e.CULL_FACE),this.currentCullFace=t},e.viewport=function(t,e,n,i){var r=this.currentViewport;r.x===t&&r.y===e&&r.z===n&&r.w===i||(this.gl.viewport(t,e,n,i),r.set(t,e,n,i))},e.setLineWidth=function(t){if(t!==this.currentLineWidth){var e=this.capabilities.lineWidthRange;e[0]<=t&&t<=e[1]?this.gl.lineWidth(t):console.warn("GL_ALIASED_LINE_WIDTH_RANGE is ["+e[0]+","+e[1]+"], but set to "+t+"."),this.currentLineWidth=t}},e.setPolygonOffset=function(t,e,n){var i=this.gl;t?(this.enable(i.POLYGON_OFFSET_FILL),this.currentPolygonOffsetFactor===e&&this.currentPolygonOffsetUnits===n||(i.polygonOffset(e,n),this.currentPolygonOffsetFactor=e,this.currentPolygonOffsetUnits=n)):this.disable(i.POLYGON_OFFSET_FILL)},e.setProgram=function(t){this.currentProgram!==t&&(this.gl.useProgram(t.program),this.currentProgram=t)},e.bindBuffer=function(t,e){var n=this.gl;this.currentBoundBuffers[t]!==e&&(n.bindBuffer(t,e),this.currentBoundBuffers[t]=e)},e.activeTexture=function(t){var e=this.gl;void 0===t&&(t=e.TEXTURE0+this.capabilities.maxTextures-1),this.currentTextureSlot!==t&&(e.activeTexture(t),this.currentTextureSlot=t)},e.bindTexture=function(t,e){var n=this.gl;null===this.currentTextureSlot&&this.activeTexture();var i=this.currentBoundTextures[this.currentTextureSlot];void 0===i&&(i={type:void 0,texture:void 0},this.currentBoundTextures[this.currentTextureSlot]=i),i.type===t&&i.texture===e||(n.bindTexture(t,e||this.emptyTextures[t]),i.type=t,i.texture=e)},e.reset=function(){var t=this.gl;t.colorMask(!0,!0,!0,!0),t.clearColor(0,0,0,0),t.depthMask(!0),t.depthFunc(t.LESS),t.clearDepth(1),t.stencilMask(4294967295),t.stencilFunc(t.ALWAYS,0,4294967295),t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.clearStencil(0),t.disable(t.BLEND),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.disable(t.POLYGON_OFFSET_FILL),t.disable(t.SCISSOR_TEST),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ZERO),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.cullFace(t.BACK),t.frontFace(t.CCW),t.viewport(0,0,t.canvas.width,t.canvas.height),t.lineWidth(1),t.polygonOffset(0,0),t.useProgram(null),t.bindFramebuffer(t.FRAMEBUFFER,null),t.activeTexture(t.TEXTURE0),this.colorBuffer.reset(),this.depthBuffer.reset(),this.stencilBuffer.reset(),this.states={},this.currentBlending=null,this.currentBlendEquation=null,this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendEquationAlpha=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null,this.currentPremultipliedAlpha=null,this.currentFlipSided=!1,this.currentCullFace=null,this.currentViewport.set(0,0,t.canvas.width,t.canvas.height),this.currentLineWidth=null,this.currentPolygonOffsetFactor=null,this.currentPolygonOffsetUnits=null,this.currentProgram=null,this.currentBoundBuffers={},this.currentRenderTarget=null,this.currentTextureSlot=null,this.currentBoundTextures={}},e.setMaterial=function(t,e){this.setCullFace(t.side===C.DOUBLE?L.NONE:L.BACK);var n=t.side===C.BACK;e&&(n=!n),this.setFlipSided(n),t.blending===R.NORMAL&&!1===t.transparent?this.setBlending(R.NONE):this.setBlending(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.premultipliedAlpha),this.depthBuffer.setFunc(t.depthFunc),this.depthBuffer.setTest(t.depthTest),this.depthBuffer.setMask(t.depthWrite),this.colorBuffer.setMask(t.colorWrite);var i=t.stencilTest;this.stencilBuffer.setTest(i),i&&(this.stencilBuffer.setMask(t.stencilWriteMask),this.stencilBuffer.setFunc(t.stencilFunc,t.stencilRef,t.stencilFuncMask,t.stencilFuncBack,t.stencilRefBack,t.stencilFuncMaskBack),this.stencilBuffer.setOp(t.stencilFail,t.stencilZFail,t.stencilZPass,t.stencilFailBack,t.stencilZFailBack,t.stencilZPassBack)),this.setPolygonOffset(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits),void 0!==t.lineWidth&&this.setLineWidth(t.lineWidth),!0===t.alphaToCoverage?this.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE)},t}(),Ni=function(){function t(t){this._key="__webgl$"+t,this._count=0}var e=t.prototype;return e.get=function(t){var e=this._key,n=t[e];return void 0===n&&(n={},t[e]=n,this._count++),n},e.delete=function(t){var e=this._key;t[e]&&(this._count--,delete t[e])},e.size=function(){return this._count},t}(),Pi=function(t){function e(e,n,i,r,a){var o,s,l;(l=t.call(this,e)||this)._gl=n,l._state=i,l._capabilities=r,l._constants=a,l._usedTextureUnits=0;var c=u(l);return l._onTextureDispose=function t(e){var i=e.target,r=c.get(i);i.removeEventListener("dispose",t),r.__webglTexture&&!r.__external&&n.deleteTexture(r.__webglTexture),c.delete(i)},l._wrappingToGL=((o={})[U.REPEAT]=n.REPEAT,o[U.CLAMP_TO_EDGE]=n.CLAMP_TO_EDGE,o[U.MIRRORED_REPEAT]=n.MIRRORED_REPEAT,o),l._filterToGL=((s={})[I.NEAREST]=n.NEAREST,s[I.LINEAR]=n.LINEAR,s[I.NEAREST_MIPMAP_NEAREST]=n.NEAREST_MIPMAP_NEAREST,s[I.LINEAR_MIPMAP_NEAREST]=n.LINEAR_MIPMAP_NEAREST,s[I.NEAREST_MIPMAP_LINEAR]=n.NEAREST_MIPMAP_LINEAR,s[I.LINEAR_MIPMAP_LINEAR]=n.LINEAR_MIPMAP_LINEAR,s),l}i(e,t);var n=e.prototype;return n.allocTexUnit=function(){var t=this._usedTextureUnits++;return t>=this._capabilities.maxTextures&&console.warn("trying to use "+t+" texture units while this GPU supports only "+this._capabilities.maxTextures),t},n.resetTextureUnits=function(){this._usedTextureUnits=0},n.setTexture2D=function(t,e){var n=this._gl,i=this._state,r=this._capabilities,a=this._constants;void 0!==e&&(e=n.TEXTURE0+e);var o=this.get(t);if(t.image&&o.__version!==t.version&&(!t.image.rtt||void 0===e)&&!o.__external){void 0===o.__webglTexture&&(t.addEventListener("dispose",this._onTextureDispose),o.__webglTexture=n.createTexture()),i.activeTexture(e),i.bindTexture(n.TEXTURE_2D,o.__webglTexture);var s=t.image,u=Ui(s);u&&(s=Fi(s,r.maxTextureSize),Li(t)&&!1===Di(s)&&r.version<2&&(s=Oi(s)));var l=!Di(s)&&r.version<2;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t.flipY),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),n.pixelStorei(n.UNPACK_ALIGNMENT,t.unpackAlignment),n.pixelStorei(n.UNPACK_COLORSPACE_CONVERSION_WEBGL,n.NONE),this._setTextureParameters(t,l);var c,h=a.getGLFormat(t.format),d=a.getGLType(t.type),f=null!==t.internalformat?a.getGLInternalFormat(t.internalformat):Ii(n,r,h,d),p=t.mipmaps;if(u)if(p.length>0&&!l){for(var _=0,v=p.length;_<v;_++)c=p[_],n.texImage2D(n.TEXTURE_2D,_,f,h,d,c);t.generateMipmaps=!1,o.__maxMipLevel=p.length-1}else n.texImage2D(n.TEXTURE_2D,0,f,h,d,s),o.__maxMipLevel=0;else if(p.length>0&&!l){for(var m=s.isCompressed,g=0,E=p.length;g<E;g++)c=p[g],m?n.compressedTexImage2D(n.TEXTURE_2D,g,f,c.width,c.height,0,c.data):n.texImage2D(n.TEXTURE_2D,g,f,c.width,c.height,t.border,h,d,c.data);t.generateMipmaps=!1,o.__maxMipLevel=p.length-1}else n.texImage2D(n.TEXTURE_2D,0,f,s.width,s.height,t.border,h,d,s.data),o.__maxMipLevel=0;return t.generateMipmaps&&!l&&this._generateMipmap(n.TEXTURE_2D,t,s.width,s.height),o.__version=t.version,o}return i.activeTexture(e),i.bindTexture(n.TEXTURE_2D,o.__webglTexture),o},n.setTextureCube=function(t,e){var n=this._gl,i=this._state,r=this._capabilities,a=this._constants;void 0!==e&&(e=n.TEXTURE0+e);var o=this.get(t);if(!(6!==t.images.length||o.__version===t.version||t.images[0].rtt&&void 0!==e||o.__external)){void 0===o.__webglTexture&&(t.addEventListener("dispose",this._onTextureDispose),o.__webglTexture=n.createTexture()),i.activeTexture(e),i.bindTexture(n.TEXTURE_CUBE_MAP,o.__webglTexture);for(var s=[],u=!1,l=0;l<6;l++){var c=t.images[l],h=Ui(c);h&&(c=Fi(c,r.maxTextureSize),Li(t)&&!1===Di(c)&&r.version<2&&(c=Oi(c))),!Di(c)&&r.version<2&&(u=!0),s[l]=c,c.__isDom=h}n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t.flipY),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),n.pixelStorei(n.UNPACK_ALIGNMENT,t.unpackAlignment),n.pixelStorei(n.UNPACK_COLORSPACE_CONVERSION_WEBGL,n.NONE),this._setTextureParameters(t,u);for(var d,f=a.getGLFormat(t.format),p=a.getGLType(t.type),_=null!==t.internalformat?a.getGLInternalFormat(t.internalformat):Ii(n,r,f,p),v=t.mipmaps,m=0;m<6;m++){var g=s[m];if(g.__isDom)if(v.length>0&&!u){for(var E=0,S=v.length;E<S;E++)d=v[E][m],n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+m,0,_,f,p,d);o.__maxMipLevel=v.length-1,t.generateMipmaps=!1}else n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+m,0,_,f,p,g),o.__maxMipLevel=0;else if(v.length>0&&!u){for(var M=g.isCompressed,T=0,y=v.length;T<y;T++)d=v[T][m],M?n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+m,T,_,d.width,d.height,0,d.data):n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+m,T,_,d.width,d.height,t.border,f,p,d.data);o.__maxMipLevel=v.length-1,t.generateMipmaps=!1}else n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+m,0,_,g.width,g.height,t.border,f,p,g.data),o.__maxMipLevel=0}return t.generateMipmaps&&!u&&this._generateMipmap(n.TEXTURE_CUBE_MAP,t,s[0].width,s[0].height),o.__version=t.version,o}return i.activeTexture(e),i.bindTexture(n.TEXTURE_CUBE_MAP,o.__webglTexture),o},n.setTexture3D=function(t,e){var n=this._gl,i=this._state,r=this._capabilities,a=this._constants;if(!(r.version<2)){void 0!==e&&(e=n.TEXTURE0+e);var o=this.get(t);if(t.image&&o.__version!==t.version&&!o.__external){void 0===o.__webglTexture&&(t.addEventListener("dispose",this._onTextureDispose),o.__webglTexture=n.createTexture()),i.activeTexture(e),i.bindTexture(n.TEXTURE_3D,o.__webglTexture);var s=t.image;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t.flipY),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),n.pixelStorei(n.UNPACK_ALIGNMENT,t.unpackAlignment),n.pixelStorei(n.UNPACK_COLORSPACE_CONVERSION_WEBGL,n.NONE),this._setTextureParameters(t,!1);var u=a.getGLFormat(t.format),l=a.getGLType(t.type),c=null!==t.internalformat?a.getGLInternalFormat(t.internalformat):Ii(n,r,u,l);return n.texImage3D(n.TEXTURE_3D,0,c,s.width,s.height,s.depth,t.border,u,l,s.data),t.generateMipmaps&&this._generateMipmap(n.TEXTURE_3D,t,s.width,s.height),o.__version=t.version,o}return i.activeTexture(e),i.bindTexture(n.TEXTURE_3D,o.__webglTexture),o}console.warn("Try to use Texture3D but browser not support WebGL2.0")},n.setTextureExternal=function(t,e){var n=this._gl,i=this.get(t);i.__external||(i.__webglTexture?n.deleteTexture(i.__webglTexture):t.addEventListener("dispose",this._onTextureDispose)),i.__webglTexture=e,i.__external=!0},n._setTextureParameters=function(t,e){var n=this._gl,i=this._capabilities,r=this._wrappingToGL,a=this._filterToGL,o=n.TEXTURE_2D;t.isTextureCube&&(o=n.TEXTURE_CUBE_MAP),t.isTexture3D&&(o=n.TEXTURE_3D);var s=function(t,e){var n=t.wrapS,i=t.wrapT,r=t.wrapR,a=t.magFilter,o=t.minFilter,s=t.anisotropy,u=t.compare;e&&(n=U.CLAMP_TO_EDGE,i=U.CLAMP_TO_EDGE,t.isTexture3D&&(r=U.CLAMP_TO_EDGE),t.wrapS===U.CLAMP_TO_EDGE&&t.wrapT===U.CLAMP_TO_EDGE||console.warn("Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to t3d.TEXTURE_WRAP.CLAMP_TO_EDGE.",t),a=Ci(t.magFilter),o=Ci(t.minFilter),(t.minFilter!==I.NEAREST&&t.minFilter!==I.LINEAR||t.magFilter!==I.NEAREST&&t.magFilter!==I.LINEAR)&&console.warn("Texture is not power of two. Texture.minFilter and Texture.magFilter should be set to t3d.TEXTURE_FILTER.NEAREST or t3d.TEXTURE_FILTER.LINEAR.",t));return[n,i,r,a,o,s,u]}(t,e);n.texParameteri(o,n.TEXTURE_WRAP_S,r[s[0]]),n.texParameteri(o,n.TEXTURE_WRAP_T,r[s[1]]),t.isTexture3D&&n.texParameteri(o,n.TEXTURE_WRAP_R,r[s[2]]),n.texParameteri(o,n.TEXTURE_MAG_FILTER,a[s[3]]),n.texParameteri(o,n.TEXTURE_MIN_FILTER,a[s[4]]);var u=i.anisotropyExt;u&&n.texParameterf(o,u.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(s[5],i.maxAnisotropy)),i.version>=2&&(void 0!==s[6]?(n.texParameteri(o,n.TEXTURE_COMPARE_MODE,n.COMPARE_REF_TO_TEXTURE),n.texParameteri(o,n.TEXTURE_COMPARE_FUNC,s[6])):n.texParameteri(o,n.TEXTURE_COMPARE_MODE,n.NONE))},n._generateMipmap=function(t,e,n,i){this._gl.generateMipmap(t),this.get(e).__maxMipLevel=Math.log(Math.max(n,i))*Math.LOG2E},e}(Ni);function Li(t){return t.wrapS!==U.CLAMP_TO_EDGE||t.wrapT!==U.CLAMP_TO_EDGE||t.minFilter!==I.NEAREST&&t.minFilter!==I.LINEAR}function Ci(t){return t===I.NEAREST||t===I.NEAREST_MIPMAP_LINEAR||t===I.NEAREST_MIPMAP_NEAREST?I.NEAREST:I.LINEAR}function Di(t){return Kt(t.width)&&Kt(t.height)}function Oi(t){if(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement){var e=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return e.width=Jt(t.width),e.height=Jt(t.height),e.getContext("2d").drawImage(t,0,0,e.width,e.height),console.warn("image is not power of two ("+t.width+"x"+t.height+"). Resized to "+e.width+"x"+e.height,t),e}return t}function Fi(t,e){if(t.width>e||t.height>e){var n=e/Math.max(t.width,t.height),i=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return i.width=Math.floor(t.width*n),i.height=Math.floor(t.height*n),i.getContext("2d").drawImage(t,0,0,t.width,t.height,0,0,i.width,i.height),console.warn("image is too big ("+t.width+"x"+t.height+"). Resized to "+i.width+"x"+i.height,t),i}return t}function Ii(t,e,n,i){if(!1===e.version>=2)return n;var r=n;return n===t.RED&&(i===t.FLOAT&&(r=t.R32F),i===t.HALF_FLOAT&&(r=t.R16F),i===t.UNSIGNED_BYTE&&(r=t.R8)),n===t.RG&&(i===t.FLOAT&&(r=t.RG32F),i===t.HALF_FLOAT&&(r=t.RG16F),i===t.UNSIGNED_BYTE&&(r=t.RG8)),n===t.RGB&&(i===t.FLOAT&&(r=t.RGB32F),i===t.HALF_FLOAT&&(r=t.RGB16F),i===t.UNSIGNED_BYTE&&(r=t.RGB8)),n===t.RGBA&&(i===t.FLOAT&&(r=t.RGBA32F),i===t.HALF_FLOAT&&(r=t.RGBA16F),i===t.UNSIGNED_BYTE&&(r=t.RGBA8),i===t.UNSIGNED_SHORT_4_4_4_4&&(r=t.RGBA4),i===t.UNSIGNED_SHORT_5_5_5_1&&(r=t.RGB5_A1)),n!==t.DEPTH_COMPONENT&&n!==t.DEPTH_STENCIL||(r=t.DEPTH_COMPONENT16,i===t.FLOAT&&(r=t.DEPTH_COMPONENT32F),i===t.UNSIGNED_INT&&(r=t.DEPTH_COMPONENT24),i===t.UNSIGNED_INT_24_8&&(r=t.DEPTH24_STENCIL8),i===t.FLOAT_32_UNSIGNED_INT_24_8_REV&&(r=t.DEPTH32F_STENCIL8)),r!==t.R16F&&r!==t.R32F&&r!==t.RG16F&&r!==t.RG32F&&r!==t.RGB16F&&r!==t.RGB32F&&r!==t.RGBA16F&&r!==t.RGBA32F||e.getExtension("EXT_color_buffer_float"),r}function Ui(t){return"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap}var Bi,Gi=function(t){function e(e,n,i,r){var a;(a=t.call(this,e)||this)._gl=n,a._capabilities=i,a._constants=r;var o=u(a);return a._onRenderBufferDispose=function t(e){var i=e.target;i.removeEventListener("dispose",t);var r=o.get(i);r.__webglRenderbuffer&&!r.__external&&n.deleteRenderbuffer(r.__webglRenderbuffer),o.delete(i)},a}i(e,t);var n=e.prototype;return n.setRenderBuffer=function(t){var e=this._gl,n=this._capabilities,i=this._constants,r=this.get(t);if(void 0===r.__webglRenderbuffer){t.addEventListener("dispose",this._onRenderBufferDispose),r.__webglRenderbuffer=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,r.__webglRenderbuffer);var a=i.getGLInternalFormat(t.format);t.multipleSampling>0?(n.version<2&&console.error("render buffer multipleSampling is not support in webgl 1.0."),e.renderbufferStorageMultisample(e.RENDERBUFFER,Math.min(t.multipleSampling,n.maxSamples),a,t.width,t.height)):e.renderbufferStorage(e.RENDERBUFFER,a,t.width,t.height)}else e.bindRenderbuffer(e.RENDERBUFFER,r.__webglRenderbuffer);return r},n.setRenderBufferExternal=function(t,e){var n=this._gl,i=this.get(t);i.__external||(i.__webglRenderbuffer?n.deleteRenderbuffer(i.__webglRenderbuffer):t.addEventListener("dispose",this._onRenderBufferDispose)),i.__webglRenderbuffer=e,i.__external=!0},e}(Ni),zi=function(t){function e(e,n,i,r,a,o,s){var l;(l=t.call(this,e)||this)._gl=n,l._state=i,l._capabilities=r,l._textures=a,l._renderBuffers=o,l._constants=s;var c=u(l);return l._onRenderTargetDispose=function t(e){var r=e.target;r.removeEventListener("dispose",t);var a=c.get(r);a.__webglFramebuffer&&n.deleteFramebuffer(a.__webglFramebuffer),c.delete(r),i.currentRenderTarget===r&&(i.currentRenderTarget=null)},l}i(e,t);var n=e.prototype;return n._setupRenderTarget=function(t){var e=this._gl,n=this._state,i=this._textures,r=this._renderBuffers,a=this._capabilities,o=this.get(t);t.addEventListener("dispose",this._onRenderTargetDispose);var s=e.createFramebuffer(),u=[];for(var l in o.__webglFramebuffer=s,o.__drawBuffers=u,t.isRenderTargetCube&&(o.__currentActiveCubeFace=t.activeCubeFace),e.bindFramebuffer(e.FRAMEBUFFER,s),t._attachments){var c=Hi[l];c===e.DEPTH_ATTACHMENT||c===e.DEPTH_STENCIL_ATTACHMENT?a.version<2&&!a.getExtension("WEBGL_depth_texture")&&console.warn("WebGLRenderTargets: extension WEBGL_depth_texture is not support."):c!==e.STENCIL_ATTACHMENT&&u.push(c);var h=t._attachments[l];if(h.isTexture2D){var d=i.setTexture2D(h);e.framebufferTexture2D(e.FRAMEBUFFER,c,e.TEXTURE_2D,d.__webglTexture,0),n.bindTexture(e.TEXTURE_2D,null)}else if(h.isTextureCube){var f=i.setTextureCube(h);e.framebufferTexture2D(e.FRAMEBUFFER,c,e.TEXTURE_CUBE_MAP_POSITIVE_X+t.activeCubeFace,f.__webglTexture,0),n.bindTexture(e.TEXTURE_CUBE_MAP,null)}else{var p=r.setRenderBuffer(h);e.framebufferRenderbuffer(e.FRAMEBUFFER,c,e.RENDERBUFFER,p.__webglRenderbuffer)}}u.sort(Vi),a.version>=2?e.drawBuffers(u):a.getExtension("WEBGL_draw_buffers")&&a.getExtension("WEBGL_draw_buffers").drawBuffersWEBGL(u)},n.setRenderTarget=function(t){var e,n=this._gl,i=this._state,r=this._textures;if(i.currentRenderTarget!==t&&(t.isRenderTargetBack?n.bindFramebuffer(n.FRAMEBUFFER,null):void 0===(e=this.get(t)).__webglFramebuffer?this._setupRenderTarget(t):n.bindFramebuffer(n.FRAMEBUFFER,e.__webglFramebuffer),i.currentRenderTarget=t),t.isRenderTargetCube){e=this.get(t);var a=t.activeCubeFace;if(e.__currentActiveCubeFace!==a){for(var o in t._attachments){var s=t._attachments[o];if(s.isTextureCube){var u=r.get(s);n.framebufferTexture2D(n.FRAMEBUFFER,Hi[o],n.TEXTURE_CUBE_MAP_POSITIVE_X+a,u.__webglTexture,0)}}e.__currentActiveCubeFace=a}}},n.blitRenderTarget=function(t,e,n,i,r){void 0===n&&(n=!0),void 0===i&&(i=!0),void 0===r&&(r=!0);var a=this._gl,o=this._capabilities;if(o.version<2)console.warn("WebGLRenderTargets: blitFramebuffer not support by WebGL"+o.version);else{var s=this.get(t).__webglFramebuffer,u=this.get(e).__webglFramebuffer;a.bindFramebuffer(a.READ_FRAMEBUFFER,s),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,u);var l=0;n&&(l|=a.COLOR_BUFFER_BIT),i&&(l|=a.DEPTH_BUFFER_BIT),r&&(l|=a.STENCIL_BUFFER_BIT),a.blitFramebuffer(0,0,t.width,t.height,0,0,e.width,e.height,l,a.NEAREST)}},n.readRenderTargetPixels=function(t,e,n,i,r){var a=this._gl,o=this._state,s=this._constants,u=o.currentRenderTarget;if(u&&u.texture){if(t>=0&&t<=u.width-n&&e>=0&&e<=u.height-i){var l=s.getGLType(u.texture.type),c=s.getGLFormat(u.texture.format);a.readPixels(t,e,n,i,c,l,r)}}else console.warn("WebGLRenderTargets.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not bound or texture not attached.")},n.updateRenderTargetMipmap=function(t){var e=this._gl,n=this._state,i=this._capabilities,r=t.texture;if(r.generateMipmaps&&r.minFilter!==I.NEAREST&&r.minFilter!==I.LINEAR&&(function(t){return Kt(t.width)&&Kt(t.height)}(t)||i.version>=2)){var a=e.TEXTURE_2D;r.isTextureCube&&(a=e.TEXTURE_CUBE_MAP),r.isTexture3D&&(a=e.TEXTURE_3D);var o=this._textures.get(r).__webglTexture;n.bindTexture(a,o),e.generateMipmap(a),n.bindTexture(a,null)}},e}(Ni),Hi=((Bi={})[W.COLOR_ATTACHMENT0]=36064,Bi[W.COLOR_ATTACHMENT1]=36065,Bi[W.COLOR_ATTACHMENT2]=36066,Bi[W.COLOR_ATTACHMENT3]=36067,Bi[W.COLOR_ATTACHMENT4]=36068,Bi[W.COLOR_ATTACHMENT5]=36069,Bi[W.COLOR_ATTACHMENT6]=36070,Bi[W.COLOR_ATTACHMENT7]=36071,Bi[W.COLOR_ATTACHMENT8]=36072,Bi[W.COLOR_ATTACHMENT9]=36073,Bi[W.COLOR_ATTACHMENT10]=36074,Bi[W.COLOR_ATTACHMENT11]=36075,Bi[W.COLOR_ATTACHMENT12]=36076,Bi[W.COLOR_ATTACHMENT13]=36077,Bi[W.COLOR_ATTACHMENT14]=36078,Bi[W.COLOR_ATTACHMENT15]=36079,Bi[W.DEPTH_ATTACHMENT]=36096,Bi[W.STENCIL_ATTACHMENT]=36128,Bi[W.DEPTH_STENCIL_ATTACHMENT]=33306,Bi);function Vi(t,e){return t-e}var ki=function(t){function e(e,n,i){var r;return(r=t.call(this,e)||this)._gl=n,r._capabilities=i,r}i(e,t);var n=e.prototype;return n.setBuffer=function(t,e,n){var i=this.get(t),r=void 0===i.glBuffer;(r||i.version!==t.version)&&(n&&n.reset(),r||i.__external?this._createGLBuffer(i,t,e):(this._updateGLBuffer(i.glBuffer,t,e),i.version=t.version))},n.removeBuffer=function(t){var e=this._gl,n=this.get(t);n.glBuffer&&!n.__external&&e.deleteBuffer(n.glBuffer),this.delete(t)},n.setBufferExternal=function(t,e){var n=this._gl,i=this.get(t);i.__external||i.glBuffer&&n.deleteBuffer(i.glBuffer);var r=Xi(n,t.array);i.glBuffer=e,i.type=r,i.bytesPerElement=t.array.BYTES_PER_ELEMENT,i.version=t.version,i.__external=!0},n._createGLBuffer=function(t,e,n){var i=this._gl,r=e.array,a=e.usage,o=i.createBuffer();i.bindBuffer(n,o),i.bufferData(n,r,a),e.onUploadCallback();var s=Xi(i,r);t.glBuffer=o,t.type=s,t.bytesPerElement=r.BYTES_PER_ELEMENT,t.version=e.version,t.__external=!1},n._updateGLBuffer=function(t,e,n){var i=this._gl,r=this._capabilities,a=e.array,o=e.updateRange;i.bindBuffer(n,t),-1===o.count?i.bufferSubData(n,0,a):(r.version>=2?i.bufferSubData(n,o.offset*a.BYTES_PER_ELEMENT,a,o.offset,o.count):i.bufferSubData(n,o.offset*a.BYTES_PER_ELEMENT,a.subarray(o.offset,o.offset+o.count)),o.count=-1)},e}(Ni);function Xi(t,e){var n;return e instanceof Float32Array?n=t.FLOAT:e instanceof Float64Array?console.warn("Unsupported data buffer format: Float64Array."):n=e instanceof Uint16Array?t.UNSIGNED_SHORT:e instanceof Int16Array?t.SHORT:e instanceof Uint32Array?t.UNSIGNED_INT:e instanceof Int32Array?t.INT:e instanceof Int8Array?t.BYTE:e instanceof Uint8Array?t.UNSIGNED_BYTE:t.FLOAT,n}var Wi=function(t){function e(e,n,i,r){var a;(a=t.call(this,e)||this)._gl=n,a._buffers=i,a._vertexArrayBindings=r;var o=u(a);return a._onGeometryDispose=function t(e){var n=e.target,a=o.get(n);for(var s in n.removeEventListener("dispose",t),null!==n.index&&i.removeBuffer(n.index.buffer),n.attributes)i.removeBuffer(n.attributes[s].buffer);for(var u in n.morphAttributes)for(var l=n.morphAttributes[u],c=0,h=l.length;c<h;c++)i.removeBuffer(l[c].buffer);r.releaseByGeometry(n),a.created=!1,o.delete(n)},a}return i(e,t),e.prototype.setGeometry=function(t){var e=this._gl,n=this._buffers,i=this.get(t);for(var r in i.created||(t.addEventListener("dispose",this._onGeometryDispose),i.created=!0),null!==t.index&&n.setBuffer(t.index.buffer,e.ELEMENT_ARRAY_BUFFER,this._vertexArrayBindings),t.attributes)n.setBuffer(t.attributes[r].buffer,e.ARRAY_BUFFER);for(var a in t.morphAttributes)for(var o=t.morphAttributes[a],s=0,u=o.length;s<u;s++)n.setBuffer(o[s].buffer,e.ARRAY_BUFFER);return i},e}(Ni),ji=function(t){function e(e,n){var i,r=u(i=t.call(this,e)||this);return i._onMaterialDispose=function t(e){var i=e.target,a=r.get(i);i.removeEventListener("dispose",t);var o=a.program;void 0!==o&&n.releaseProgram(o),r.delete(i)},i}return i(e,t),e.prototype.setMaterial=function(t){var e=this.get(t);return void 0===e.program&&t.addEventListener("dispose",this._onMaterialDispose),e},e}(Ni),Yi=function(t){function e(e,n,i,r){var a;return(a=t.call(this,e)||this)._gl=n,a._capabilities=i,a._buffers=r,a._isWebGL2=i.version>=2,a._vaoExt=i.getExtension("OES_vertex_array_object"),a._currentGeometryProgram="",a._currentVAO=null,a}i(e,t);var n=e.prototype;return n.setup=function(t,e,n){if(t.morphTargetInfluences)this.reset(),this._setupVertexAttributes(n,e),this._currentGeometryProgram="";else if(this._isWebGL2||this._vaoExt){var i=this.get(e);void 0===i._vaos&&(i._vaos={});var r=i._vaos[n.id];r||(r=i._vaos[n.id]={version:-1,object:this._createVAO()}),this._bindVAO(r.object),r.version!==e.version&&(this._setupVertexAttributes(n,e),r.version=e.version)}else{var a=n.id+"_"+e.id+"_"+e.version;a!==this._currentGeometryProgram&&(this._setupVertexAttributes(n,e),this._currentGeometryProgram=a)}},n.releaseByGeometry=function(t){var e=this.get(t);if(e._vaos){for(var n in e._vaos){var i=e[n];i&&this._disposeVAO(i.object)}e._vaos={}}},n.reset=function(t){(null!==this._currentVAO||t)&&(this._isWebGL2?this._gl.bindVertexArray(null):this._vaoExt&&this._vaoExt.bindVertexArrayOES(null),this._currentVAO=null),""!==this._currentGeometryProgram&&(this._currentGeometryProgram="")},n._createVAO=function(){return this._isWebGL2?this._gl.createVertexArray():this._vaoExt?this._vaoExt.createVertexArrayOES():null},n._bindVAO=function(t){this._currentVAO!==t&&(this._isWebGL2?this._gl.bindVertexArray(t):this._vaoExt&&this._vaoExt.bindVertexArrayOES(t),this._currentVAO=t)},n._disposeVAO=function(t){this._isWebGL2?this._gl.deleteVertexArray(t):this._vaoExt&&this._vaoExt.deleteVertexArrayOES(t)},n._setupVertexAttributes=function(t,e){var n=this._gl,i=this._isWebGL2,r=t.getAttributes(),a=this._capabilities,o=this._buffers;for(var s in r){var u=r[s],l=e.getAttribute(s);if(l){var c=l.size;u.count!==c&&console.warn("WebGLVertexArrayBindings: attribute "+s+" size not match! "+u.count+" : "+c);var h=l.buffer,d=o.get(h),f=d.type;u.format;for(var p=0,_=u.locationSize;p<_;p++)n.enableVertexAttribArray(u.location+p);if(l.divisor>0)for(var v=0,m=u.locationSize;v<m;v++)i?n.vertexAttribDivisor(u.location+v,l.divisor):a.getExtension("ANGLE_instanced_arrays")?a.getExtension("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(u.location+v,l.divisor):console.warn("vertexAttribDivisor not supported");var g=d.bytesPerElement,E=d.glBuffer,S=h.stride,M=l.offset,T=l.normalized;if(n.bindBuffer(n.ARRAY_BUFFER,E),u.count===S&&1===u.locationSize)n.vertexAttribPointer(u.location,u.count,f,T,0,0);else for(var y=0;y<u.locationSize;y++)n.vertexAttribPointer(u.location+y,u.count/u.locationSize,f,T,g*S,g*(M+u.count/u.locationSize*y))}}if(e.index){var x=o.get(e.index.buffer);n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,x.glBuffer)}},e}(Ni),qi=function(t){function e(e,n,i){var r,a;(a=t.call(this,e)||this)._gl=n,a._capabilities=i;var o=i.timerQuery,s=u(a);return a._onQueryDispose=function t(e){var r=e.target,a=s.get(r);r.removeEventListener("dispose",t),a._webglQuery&&(i.version>1?n.deleteQuery(a._webglQuery):o.deleteQueryEXT(a._webglQuery)),s.delete(r)},a._typeToGL=((r={})[Y.ANY_SAMPLES_PASSED]=35887,r[Y.ANY_SAMPLES_PASSED_CONSERVATIVE]=36202,r[Y.TIME_ELAPSED]=35007,r),a}i(e,t);var n=e.prototype;return n._get=function(t){var e=this._capabilities,n=this.get(t);return void 0===n._webglQuery&&(t.addEventListener("dispose",this._onQueryDispose),n._webglQuery=e.version>1?this._gl.createQuery():e.timerQuery.createQueryEXT(),n._target=null,n._result=null),n},n.begin=function(t,e){var n=this._capabilities,i=this._typeToGL,r=this._get(t);n.version>1?this._gl.beginQuery(i[e],r._webglQuery):n.timerQuery.beginQueryEXT(i[e],r._webglQuery),r._target=e,r._result=null},n.end=function(t){var e=this._capabilities,n=this._typeToGL,i=this._get(t);e.version>1?this._gl.endQuery(n[i._target]):e.timerQuery.endQueryEXT(n[i._target])},n.counter=function(t){var e=this._capabilities.timerQuery,n=this._get(t);e.queryCounterEXT(n._webglQuery,e.TIMESTAMP_EXT),n._target=e.TIMESTAMP_EXT,n._result=null},n.isResultAvailable=function(t){var e=this._gl,n=this._capabilities,i=n.timerQuery,r=this._get(t);return n.version>1?e.getQueryParameter(r._webglQuery,e.QUERY_RESULT_AVAILABLE):i.getQueryObjectEXT(r._webglQuery,i.QUERY_RESULT_AVAILABLE)},n.isTimerDisjoint=function(){return this._gl.getParameter(this._capabilities.timerQuery.GPU_DISJOINT_EXT)},n.getResult=function(t){var e=this._gl,n=this._capabilities,i=n.timerQuery,r=this._get(t);return null===r._result&&(n.version>1?r._result=e.getQueryParameter(r._webglQuery,e.QUERY_RESULT):r._result=i.getQueryObjectEXT(r._webglQuery,i.QUERY_RESULT_EXT)),r._result},e}(Ni),Qi=new Yt,Zi=new m,Ki=new WeakMap,Ji=new Float32Array(8),$i=new Float32Array([]);function tr(t){return t.geometry}function er(t){return t.material}function nr(t){return!0}function ir(){}var rr=0,ar=function(){function t(t){var e=rr++,n=new Mi(t),i=new yi(t,n),r=new Ri(t,n),a=new Pi(e,t,r,n,i),o=new Gi(e,t,n,i),s=new zi(e,t,r,n,a,o,i),u=new ki(e,t,n),l=new Yi(e,t,n,u),c=new Wi(e,t,u,l),h=new li(t,r,n),d=new ji(e,h),f=new qi(e,t,n);this.id=e,this.gl=t,this.capabilities=n,this._textures=a,this._renderBuffers=o,this._renderTargets=s,this._buffers=u,this._geometries=c,this._programs=h,this._materials=d,this._state=r,this._vertexArrayBindings=l,this._queries=f}var e=t.prototype;return e.clear=function(t,e,n){var i=this.gl,r=0;(void 0===t||t)&&(r|=i.COLOR_BUFFER_BIT),(void 0===e||e)&&(r|=i.DEPTH_BUFFER_BIT),(void 0===n||n)&&(r|=i.STENCIL_BUFFER_BIT),r>0&&i.clear(r)},e.setClearColor=function(t,e,n,i,r){this._state.colorBuffer.setClear(t,e,n,i,r)},e.getClearColor=function(){return this._state.colorBuffer.getClear()},e.setRenderTarget=function(t){this._renderTargets.setRenderTarget(t)},e.getRenderTarget=function(){return this._state.currentRenderTarget},e.blitRenderTarget=function(t,e,n,i,r){void 0===n&&(n=!0),void 0===i&&(i=!0),void 0===r&&(r=!0),this._renderTargets.blitRenderTarget(t,e,n,i,r)},e.readRenderTargetPixels=function(t,e,n,i,r){this._renderTargets.readRenderTargetPixels(t,e,n,i,r)},e.updateRenderTargetMipmap=function(t){this._renderTargets.updateRenderTargetMipmap(t)},e.setTextureExternal=function(t,e){this._textures.setTextureExternal(t,e)},e.setRenderBufferExternal=function(t,e){this._renderBuffers.setRenderBufferExternal(t,e)},e.setBufferExternal=function(t,e){this._buffers.setBufferExternal(t,e)},e.resetVertexArrayBindings=function(t){this._vertexArrayBindings.reset(t)},e.resetState=function(){this._state.reset()},e.beginQuery=function(t,e){this._queries.begin(t,e)},e.endQuery=function(t){this._queries.end(t)},e.queryCounter=function(t){this._queries.counter(t)},e.isTimerQueryDisjoint=function(t){return this._queries.isTimerDisjoint(t)},e.isQueryResultAvailable=function(t){return this._queries.isResultAvailable(t)},e.getQueryResult=function(t){return this._queries.getResult(t)},e.render=function(t,e,n){var i=this._state,r=this.capabilities,a=this._vertexArrayBindings,o=this._textures,s=n.getGeometry||tr,u=n.getMaterial||er,l=n.beforeRender||ir,c=n.afterRender||ir,h=n.ifRender||nr,d=n.renderInfo,f=e.scene,p=e.lights,_=e.camera,v=i.currentRenderTarget;if(h(t)){var m=t.object,g=u.call(this,t),E=s.call(this,t),S=t.group,M=g.fog?f.fog:null,T=void 0!==g.envMap?g.envMap||f.environment:null,y=f.clippingPlanesData,x=f.numClippingPlanes;g.clippingPlanes&&g.clippingPlanes.length>0&&($i.length<4*g.clippingPlanes.length&&($i=new Float32Array(4*g.clippingPlanes.length)),y=f.setClippingPlanesData(g.clippingPlanes,$i),x=g.clippingPlanes.length),m.onBeforeRender(t,g),l.call(this,t,g);var w=this._materials.setMaterial(g);if(!1===g.needsUpdate)if(void 0===w.program)g.needsUpdate=!0;else if(w.fog!==M)g.needsUpdate=!0;else if(w.envMap!==T)g.needsUpdate=!0;else if(w.numClippingPlanes!==x)g.needsUpdate=!0;else if(w.logarithmicDepthBuffer!==f.logarithmicDepthBuffer)g.needsUpdate=!0;else if(e.outputEncoding!==w.outputEncoding||e.gammaFactor!==w.gammaFactor)g.needsUpdate=!0;else if(r.version>1&&f.disableShadowSampler!==w.disableShadowSampler)g.needsUpdate=!0;else{var A=g.acceptLight&&p.totalNum>0;A!==w.acceptLight?g.needsUpdate=!0:A&&(p.hash.compare(w.lightsHash)&&m.receiveShadow===w.receiveShadow&&m.shadowType===w.shadowType||(g.needsUpdate=!0))}if(g.needsUpdate){var b=w.program;w.program=this._programs.getProgram(g,m,e,!0),b&&this._programs.releaseProgram(b),w.fog=M,w.envMap=T,w.logarithmicDepthBuffer=f.logarithmicDepthBuffer,w.acceptLight=g.acceptLight,w.lightsHash=p.hash.copyTo(w.lightsHash),w.receiveShadow=m.receiveShadow,w.shadowType=m.shadowType,w.numClippingPlanes=x,w.outputEncoding=e.outputEncoding,w.gammaFactor=e.gammaFactor,w.disableShadowSampler=f.disableShadowSampler,g.needsUpdate=!1}var R=w.program;if(void 0!==R.program){i.setProgram(R),this._geometries.setGeometry(E),m.morphTargetInfluences&&this._updateMorphtargets(m,E,R),a.setup(m,E,R);var N=!1;R.lightId===p.id&&R.lightVersion===p.version||(N=!0,R.lightId=p.id,R.lightVersion=p.version);var P=!1;R.cameraId===_.id&&R.cameraVersion===_.version||(P=!0,R.cameraId=_.id,R.cameraVersion=_.version);var L=!1;R.sceneId===f.id&&R.sceneVersion===f.version||(L=!0,R.sceneId=f.id,R.sceneVersion=f.version);var C=R.getUniforms();g.acceptLight&&this._uploadLights(C,p,f.disableShadowSampler,N),m.isSkinnedMesh&&this._uploadSkeleton(C,m,f);for(var D=0,O=C.seq.length;D<O;D++){var F=C.seq[D],I=F.id,U=F.internalGroup;if(g.uniforms&&void 0!==g.uniforms[I])F.set(g.uniforms[I],o);else if(1!==U)if(2===U&&P)F.internalFun(_);else if(3===U&&L)F.internalFun(f);else if(4!==U)if(5!==U)"clippingPlanes"===I&&F.set(y);else if("u_PointScale"===I){var B=.5*v.height;F.set(B)}else F.internalFun(T,o);else F.internalFun(g,o);else{var G=m.worldMatrix;f.useAnchorMatrix&&(G=Zi.copy(G).premultiply(f.anchorMatrixInverse)),F.set(G.elements)}}var z=m.worldMatrix.determinant()<0;i.setMaterial(g,z);var H=Qi.set(v.width,v.height,v.width,v.height).multiply(_.rect);H.z-=H.x,H.w-=H.y,H.x=Math.floor(H.x),H.y=Math.floor(H.y),H.z=Math.floor(H.z),H.w=Math.floor(H.w),i.viewport(H.x,H.y,H.z,H.w),this._draw(E,g,S,d),o.resetTextureUnits(),i.depthBuffer.setTest(!0),i.depthBuffer.setMask(!0),i.colorBuffer.setMask(!0),c(t),m.onAfterRender(t)}}},e._uploadLights=function(t,e,n,i){var r=this._textures;e.useAmbient&&i&&t.set("u_AmbientLightColor",e.ambient),e.hemisNum>0&&i&&t.set("u_Hemi",e.hemisphere),e.directsNum>0&&(i&&t.set("u_Directional",e.directional),e.directShadowNum>0&&(i&&t.set("u_DirectionalShadow",e.directionalShadow),t.has("directionalShadowMap")&&(this.capabilities.version>=2&&!n?t.set("directionalShadowMap",e.directionalShadowDepthMap,r):t.set("directionalShadowMap",e.directionalShadowMap,r),t.set("directionalShadowMatrix",e.directionalShadowMatrix)),t.has("directionalDepthMap")&&t.set("directionalDepthMap",e.directionalShadowMap,r))),e.pointsNum>0&&(i&&t.set("u_Point",e.point),e.pointShadowNum>0&&(i&&t.set("u_PointShadow",e.pointShadow),t.has("pointShadowMap")&&(t.set("pointShadowMap",e.pointShadowMap,r),t.set("pointShadowMatrix",e.pointShadowMatrix)))),e.spotsNum>0&&(i&&t.set("u_Spot",e.spot),e.spotShadowNum>0&&(i&&t.set("u_SpotShadow",e.spotShadow),t.has("spotShadowMap")&&(this.capabilities.version>=2&&!n?t.set("spotShadowMap",e.spotShadowDepthMap,r):t.set("spotShadowMap",e.spotShadowMap,r),t.set("spotShadowMatrix",e.spotShadowMatrix)),t.has("spotDepthMap")&&t.set("spotDepthMap",e.spotShadowMap,r)))},e._uploadSkeleton=function(t,e,n){if(e.skeleton&&e.skeleton.bones.length>0){var i=e.skeleton,r=this.capabilities;r.maxVertexTextures>0&&(r.getExtension("OES_texture_float")||r.version>=2)?(void 0===i.boneTexture&&i.generateBoneTexture(r.version>=2),t.set("boneTexture",i.boneTexture,this._textures),t.set("boneTextureSize",i.boneTexture.image.width)):t.set("boneMatrices",i.boneMatrices),t.set("bindMatrix",e.bindMatrix.elements),Zi.copy(e.bindMatrixInverse),n.useAnchorMatrix&&Zi.multiply(n.anchorMatrix),t.set("bindMatrixInverse",Zi.elements)}},e._updateMorphtargets=function(t,e,n){var i=t.morphTargetInfluences;Ki.has(e)||Ki.set(e,i.slice(0));for(var r=e.morphAttributes.position,a=e.morphAttributes.normal,o=Ki.get(e),s=0;s<o.length;s++){0!==o[s]&&(r&&e.removeAttribute("morphTarget"+s),a&&e.removeAttribute("morphNormal"+s))}for(var u=0;u<i.length;u++)o[u]=i[u];o.length=i.length;for(var l=0,c=0;c<o.length;c++){var h=o[c];h>0&&(r&&e.addAttribute("morphTarget"+l,r[c]),a&&e.addAttribute("morphNormal"+l,a[c]),Ji[l]=h,l++)}for(;l<8;l++)Ji[l]=0;n.getUniforms().set("morphTargetInfluences",Ji)},e._draw=function(t,e,n,i){var r=this.gl,a=this.capabilities,o=this._buffers,s=null!==t.index,u=0,l=s?t.index.buffer.count:t.getAttribute("a_Position").buffer.count,c=n?n.start:0,h=n?n.count:1/0;u=Math.max(u,c),l=Math.min(l,h);var d=t.instanceCount,f=d>=0;if(s){var p=o.get(t.index.buffer),_=p.bytesPerElement,v=p.type;if(v===r.UNSIGNED_INT&&a.version<2&&!a.getExtension("OES_element_index_uint")&&console.warn("draw elements type not support UNSIGNED_INT!"),f){if(d>0)if(a.version>=2)r.drawElementsInstanced(e.drawMode,l,v,u*_,d);else{if(!a.getExtension("ANGLE_instanced_arrays"))return void console.warn("no support instanced draw.");a.getExtension("ANGLE_instanced_arrays").drawElementsInstancedANGLE(e.drawMode,l,v,u*_,d)}}else r.drawElements(e.drawMode,l,v,u*_)}else if(f){if(d>0)if(a.version>=2)r.drawArraysInstanced(e.drawMode,u,l,d);else{if(!a.getExtension("ANGLE_instanced_arrays"))return void console.warn("no support instanced draw.");a.getExtension("ANGLE_instanced_arrays").drawArraysInstancedANGLE(e.drawMode,u,l,d)}}else r.drawArrays(e.drawMode,u,l);i&&i.update(l,e.drawMode,d<0?1:d)},t}(),or=function(){function t(t){this.renderPass=new ar(t)}var e=t.prototype;return e.renderScene=function(t,e){for(var n,i=t.getRenderStates(e),r=t.getRenderQueue(e),a=0,o=r.layerList.length;a<o;a++)n=r.layerList[a],this.renderRenderableList(n.opaque,i),this.renderRenderableList(n.transparent,i)},e.renderRenderableList=function(t,e,n){void 0===n&&(n={});for(var i=this.renderPass,r=0,a=t.length;r<a;r++)i.render(t[r],e,n)},t}(),sr=function(t,e,n){void 0===t&&(t=0),void 0===e&&(e=1),void 0===n&&(n=1e3),this.color=new gt(t),this.near=e,this.far=n};sr.prototype.isFog=!0;var ur=function(t,e){void 0===t&&(t=0),void 0===e&&(e=25e-5),this.color=new gt(t),this.density=e};ur.prototype.isFogExp2=!0;var lr=function(t){function e(e,n,i,r,a,o){var s;void 0===e&&(e=1),void 0===n&&(n=1),void 0===i&&(i=1),void 0===r&&(r=1),void 0===a&&(a=1),void 0===o&&(o=1);var l=u(s=t.call(this)||this);r=Math.floor(r),a=Math.floor(a),o=Math.floor(o);var c=[],h=[],d=[],f=[],p=0,v=0;function m(t,e,n,i,r,a,o,s,u,m,g){for(var E=a/u,S=o/m,M=a/2,T=o/2,y=s/2,x=u+1,w=m+1,A=0,b=0,R=new _,N=0;N<w;N++)for(var P=N*S-T,L=0;L<x;L++){var C=L*E-M;R[t]=C*i,R[e]=P*r,R[n]=y,h.push(R.x,R.y,R.z),R[t]=0,R[e]=0,R[n]=s>0?1:-1,d.push(R.x,R.y,R.z),f.push(L/u),f.push(1-N/m),A+=1}for(var D=0;D<m;D++)for(var O=0;O<u;O++){var F=p+O+x*D,I=p+O+x*(D+1),U=p+(O+1)+x*(D+1),B=p+(O+1)+x*D;c.push(F,I,B),c.push(I,U,B),b+=6}l.addGroup(v,b,g),v+=b,p+=A}return m("z","y","x",-1,-1,i,n,e,o,a,0),m("z","y","x",1,-1,i,n,-e,o,a,1),m("x","z","y",1,1,e,i,n,r,o,2),m("x","z","y",1,-1,e,i,-n,r,o,3),m("x","y","z",1,-1,e,n,i,r,a,4),m("x","y","z",-1,-1,e,n,-i,r,a,5),s.setIndex(new ln(new cn(h.length/3>65536?new Uint32Array(c):new Uint16Array(c),1))),s.addAttribute("a_Position",new ln(new cn(new Float32Array(h),3))),s.addAttribute("a_Normal",new ln(new cn(new Float32Array(d),3))),s.addAttribute("a_Uv",new ln(new cn(new Float32Array(f),2))),s.computeBoundingBox(),s.computeBoundingSphere(),s}return i(e,t),e}(mn),cr=function(t){function e(e,n,i,r,a,o,s,l){var c;void 0===e&&(e=1),void 0===n&&(n=1),void 0===i&&(i=1),void 0===r&&(r=8),void 0===a&&(a=1),void 0===o&&(o=!1),void 0===s&&(s=0),void 0===l&&(l=2*Math.PI);var h=u(c=t.call(this)||this);r=Math.floor(r),a=Math.floor(a);var d=[],f=[],p=[],v=[],m=0,g=[],E=i/2,S=0;function M(t){var i,a=m,o=new pt,u=new _,c=0,g=!0===t?e:n,M=!0===t?1:-1;for(i=1;i<=r;i++)f.push(0,E*M,0),p.push(0,M,0),v.push(.5,.5),m++;var T=m;for(i=0;i<=r;i++){var y=i/r*l+s,x=Math.cos(y),w=Math.sin(y);u.x=g*w,u.y=E*M,u.z=g*x,f.push(u.x,u.y,u.z),p.push(0,M,0),o.x=.5*x+.5,o.y=.5*w*M+.5,v.push(o.x,o.y),m++}for(i=0;i<r;i++){var A=a+i,b=T+i;!0===t?d.push(b,b+1,A):d.push(b+1,b,A),c+=3}h.addGroup(S,c,!0===t?1:2),S+=c}return function(){var t,o,u=new _,c=new _,M=0,T=(n-e)/i;for(o=0;o<=a;o++){var y=[],x=o/a,w=x*(n-e)+e;for(t=0;t<=r;t++){var A=t/r,b=A*l+s,R=Math.sin(b),N=Math.cos(b);c.x=w*R,c.y=-x*i+E,c.z=w*N,f.push(c.x,c.y,c.z),u.set(R,T,N).normalize(),p.push(u.x,u.y,u.z),v.push(A,1-x),y.push(m++)}g.push(y)}for(t=0;t<r;t++)for(o=0;o<a;o++){var P=g[o][t],L=g[o+1][t],C=g[o+1][t+1],D=g[o][t+1];d.push(P,L,D),d.push(L,C,D),M+=6}h.addGroup(S,M,0),S+=M}(),!1===o&&(e>0&&M(!0),n>0&&M(!1)),c.setIndex(new ln(new cn(f.length/3>65536?new Uint32Array(d):new Uint16Array(d),1))),c.addAttribute("a_Position",new ln(new cn(new Float32Array(f),3))),c.addAttribute("a_Normal",new ln(new cn(new Float32Array(p),3))),c.addAttribute("a_Uv",new ln(new cn(new Float32Array(v),2))),c.computeBoundingBox(),c.computeBoundingSphere(),c}return i(e,t),e}(mn),hr=function(t){function e(e,n,i,r,a,o,s){var u;void 0===e&&(e=1),void 0===n&&(n=8),void 0===i&&(i=6),void 0===r&&(r=0),void 0===a&&(a=2*Math.PI),void 0===o&&(o=0),void 0===s&&(s=Math.PI),u=t.call(this)||this,n=Math.max(3,Math.floor(n)),i=Math.max(2,Math.floor(i));var l,c,h=o+s,d=0,f=[],p=new _,v=new _,m=[],g=[],E=[],S=[];for(c=0;c<=i;c++){var M=[],T=c/i,y=0;for(0==c&&0==o?y=.5/n:c==i&&h==Math.PI&&(y=-.5/n),l=0;l<=n;l++){var x=l/n;p.x=-e*Math.cos(r+x*a)*Math.sin(o+T*s),p.y=e*Math.cos(o+T*s),p.z=e*Math.sin(r+x*a)*Math.sin(o+T*s),g.push(p.x,p.y,p.z),v.copy(p).normalize(),E.push(v.x,v.y,v.z),S.push(x+y,1-T),M.push(d++)}f.push(M)}for(c=0;c<i;c++)for(l=0;l<n;l++){var w=f[c][l+1],A=f[c][l],b=f[c+1][l],R=f[c+1][l+1];(0!==c||o>0)&&m.push(w,A,R),(c!==i-1||h<Math.PI)&&m.push(A,b,R)}return u.setIndex(new ln(new cn(g.length/3>65536?new Uint32Array(m):new Uint16Array(m),1))),u.addAttribute("a_Position",new ln(new cn(new Float32Array(g),3))),u.addAttribute("a_Normal",new ln(new cn(new Float32Array(E),3))),u.addAttribute("a_Uv",new ln(new cn(new Float32Array(S),2))),u.computeBoundingBox(),u.computeBoundingSphere(),u}return i(e,t),e}(mn),dr=function(t){function e(e,n,i,r,a,o){var s;void 0===e&&(e=1),void 0===n&&(n=.4),void 0===i&&(i=64),void 0===r&&(r=8),void 0===a&&(a=2),void 0===o&&(o=3),s=t.call(this)||this,i=Math.floor(i),r=Math.floor(r);var u,l,c=[],h=[],d=[],f=[],p=new _,v=new _,m=new _,g=new _,E=new _,S=new _,M=new _;for(u=0;u<=i;++u){var T=u/i*a*Math.PI*2;for(P(T,a,o,e,m),P(T+.01,a,o,e,g),S.subVectors(g,m),M.addVectors(g,m),E.crossVectors(S,M),M.crossVectors(E,S),E.normalize(),M.normalize(),l=0;l<=r;++l){var y=l/r*Math.PI*2,x=-n*Math.cos(y),w=n*Math.sin(y);p.x=m.x+(x*M.x+w*E.x),p.y=m.y+(x*M.y+w*E.y),p.z=m.z+(x*M.z+w*E.z),h.push(p.x,p.y,p.z),v.subVectors(p,m).normalize(),d.push(v.x,v.y,v.z),f.push(u/i),f.push(l/r)}}for(l=1;l<=i;l++)for(u=1;u<=r;u++){var A=(r+1)*(l-1)+(u-1),b=(r+1)*l+(u-1),R=(r+1)*l+u,N=(r+1)*(l-1)+u;c.push(A,b,N),c.push(b,R,N)}function P(t,e,n,i,r){var a=Math.cos(t),o=Math.sin(t),s=n/e*t,u=Math.cos(s);r.x=i*(2+u)*.5*a,r.y=i*(2+u)*o*.5,r.z=i*Math.sin(s)*.5}return s.setIndex(new ln(new cn(h.length/3>65536?new Uint32Array(c):new Uint16Array(c),1))),s.addAttribute("a_Position",new ln(new cn(new Float32Array(h),3))),s.addAttribute("a_Normal",new ln(new cn(new Float32Array(d),3))),s.addAttribute("a_Uv",new ln(new cn(new Float32Array(f),2))),s.computeBoundingBox(),s.computeBoundingSphere(),s}return i(e,t),e}(mn),fr=function(t){function e(){var e;return(e=t.call(this)||this).type=b.BASIC,e}return i(e,t),e}(Sn),pr=function(t){function e(){var e;return(e=t.call(this)||this).type=b.LAMBERT,e.acceptLight=!0,e}return i(e,t),e}(Sn),_r=function(t){function e(){var e;return(e=t.call(this)||this).type=b.LINE,e.lineWidth=1,e.drawMode=k.LINES,e}return i(e,t),e.prototype.copy=function(e){return t.prototype.copy.call(this,e),this.lineWidth=e.lineWidth,this},e}(Sn),vr=function(t){function e(){var e;return(e=t.call(this)||this).type=b.MATCAP,e.matcap=null,e}return i(e,t),e.prototype.copy=function(e){return t.prototype.copy.call(this,e),this.matcap=e.matcap,this},e}(Sn),mr=function(t){function e(){var e;return(e=t.call(this)||this).type=b.PBR2,e.specular=new gt(1118481),e.glossiness=.5,e.specularMap=null,e.glossinessMap=null,e.acceptLight=!0,e}return i(e,t),e.prototype.copy=function(e){return t.prototype.copy.call(this,e),this.specular=e.specular,this.glossiness=e.glossiness,this.specularMap=e.specularMap,this.glossinessMap=e.glossinessMap,this},e}(Sn),gr=function(t){function e(){var e;return(e=t.call(this)||this).type=b.PBR,e.roughness=.5,e.metalness=.5,e.roughnessMap=null,e.metalnessMap=null,e.clearcoat=0,e.clearcoatMap=null,e.clearcoatRoughness=0,e.clearcoatRoughnessMap=null,e.clearcoatNormalScale=new pt(1,1),e.clearcoatNormalMap=null,e.acceptLight=!0,e}return i(e,t),e.prototype.copy=function(e){return t.prototype.copy.call(this,e),this.roughness=e.roughness,this.metalness=e.metalness,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.clearcoat=e.clearcoat,this.clearcoatMap=e.clearcoatMap,this.clearcoatRoughness=e.clearcoatRoughness,this.clearcoatRoughnessMap=e.clearcoatRoughnessMap,this.clearcoatNormalScale.copy(e.clearcoatNormalScale),this},e}(Sn),Er=function(t){function e(){var e;return(e=t.call(this)||this).type=b.PHONG,e.shininess=30,e.specular=new gt(1118481),e.specularMap=null,e.acceptLight=!0,e}return i(e,t),e.prototype.copy=function(e){return t.prototype.copy.call(this,e),this.shininess=e.shininess,this.specular.copy(e.specular),this.specularMap=e.specularMap,this},e}(Sn),Sr=function(t){function e(){var e;return(e=t.call(this)||this).type=b.POINT,e.size=1,e.sizeAttenuation=!0,e.drawMode=k.POINTS,e}return i(e,t),e.prototype.copy=function(e){return t.prototype.copy.call(this,e),this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this},e}(Sn),Mr=function(t){function e(e,n){var i;return(i=t.call(this)||this).width=e,i.height=n,i}i(e,t);var n=e.prototype;return n.resize=function(t,e){return(this.width!==t||this.height!==e)&&(this.width=t,this.height=e,!0)},n.dispose=function(){this.dispatchEvent({type:"dispose"})},e}(q);Mr.prototype.isRenderTarget=!0;var Tr=function(t){function e(e,n,i,r){var a;return void 0===i&&(i=O.RGBA8),void 0===r&&(r=0),(a=t.call(this)||this).width=e,a.height=n,a.format=i,a.multipleSampling=r,a}i(e,t);var n=e.prototype;return n.resize=function(t,e){return(this.width!==t||this.height!==e)&&(this.dispose(),this.width=t,this.height=e,!0)},n.clone=function(){return(new this.constructor).copy(this)},n.copy=function(t){return this.format=t.format,this.multipleSampling=t.multipleSampling,this},n.dispose=function(){this.dispatchEvent({type:"dispose"})},e}(q);Tr.prototype.isRenderBuffer=!0;var yr=function(t){function e(e,n){var i;return(i=t.call(this,e,n)||this)._attachments={},i.attach(new On,W.COLOR_ATTACHMENT0),i.attach(new Tr(e,n,O.DEPTH_STENCIL),W.DEPTH_STENCIL_ATTACHMENT),i}i(e,t);var n=e.prototype;return n.attach=function(t,e){void 0===e&&(e=W.COLOR_ATTACHMENT0),t.isTexture?t.image&&t.image.rtt?t.image.width===this.width&&t.image.height===this.height||(t.version++,t.image.width=this.width,t.image.height=this.height):(t.version++,t.image={rtt:!0,data:null,width:this.width,height:this.height}):t.resize(this.width,this.height),this._attachments[e]=t},n.detach=function(t){void 0===t&&(t=W.COLOR_ATTACHMENT0),delete this._attachments[t]},n.resize=function(e,n){var i=t.prototype.resize.call(this,e,n);if(i)for(var r in this.dispose(!1),this._attachments){var a=this._attachments[r];a.isTexture?(a.image={rtt:!0,data:null,width:this.width,height:this.height},a.version++):a.resize(e,n)}return i},n.dispose=function(e){if(void 0===e&&(e=!0),t.prototype.dispose.call(this),e)for(var n in this._attachments)this._attachments[n].dispose()},e}(Mr);yr.prototype.isRenderTarget2D=!0,Object.defineProperties(yr.prototype,{texture:{set:function(t){t?t.isTexture&&this.attach(t,W.COLOR_ATTACHMENT0):this.detach(W.COLOR_ATTACHMENT0)},get:function(){var t=this._attachments[W.COLOR_ATTACHMENT0];return t.isTexture?t:null}}});var xr=function(t){function e(e){var n;return(n=t.call(this,e.width,e.height)||this).view=e,n}i(e,t);var n=e.prototype;return n.resize=function(t,e){this.view.width=t,this.view.height=e,this.width=t,this.height=e},n.dispose=function(){},e}(Mr);xr.prototype.isRenderTargetBack=!0;var wr=function(t){function e(e,n){var i;return(i=t.call(this,e,n)||this)._attachments={},i.attach(new Fn,W.COLOR_ATTACHMENT0),i.attach(new Tr(e,n,O.DEPTH_STENCIL),W.DEPTH_STENCIL_ATTACHMENT),i.activeCubeFace=0,i}i(e,t);var n=e.prototype;return n.attach=function(t,e){if(void 0===e&&(e=W.COLOR_ATTACHMENT0),t.isTexture){for(var n=!1,i=0;i<6;i++)t.images[i]&&t.images[i].rtt?t.images[i].width===this.width&&t.images[i].height===this.height||(t.images[i].width=this.width,t.images[i].height=this.height,n=!0):(t.images[i]={rtt:!0,data:null,width:this.width,height:this.height},n=!0);n&&t.version++}else t.resize(this.width,this.height);this._attachments[e]=t},n.detach=function(t){void 0===t&&(t=W.COLOR_ATTACHMENT0),delete this._attachments[t]},n.resize=function(e,n){if(t.prototype.resize.call(this,e,n))for(var i in this.dispose(!1),this._attachments){var r=this._attachments[i];if(r.isTexture){for(var a=0;a<6;a++)r.images[a]={rtt:!0,data:null,width:this.width,height:this.height};r.version++}else r.resize(e,n)}},n.dispose=function(e){if(void 0===e&&(e=!0),t.prototype.dispose.call(this),e)for(var n in this._attachments)this._attachments[n].dispose()},e}(Mr);wr.prototype.isRenderTargetCube=!0,Object.defineProperties(wr.prototype,{texture:{set:function(t){t?t.isTexture&&this.attach(t,W.COLOR_ATTACHMENT0):this.detach(W.COLOR_ATTACHMENT0)},get:function(){var t=this._attachments[W.COLOR_ATTACHMENT0];return t.isTexture?t:null}}});var Ar=0,br=function(t){function e(){var e;return(e=t.call(this)||this).id=Ar++,e}return i(e,t),e.prototype.dispose=function(){this.dispatchEvent({type:"dispose"})},e}(q),Rr=new m,Nr=function(){function t(t,e){this.bones=t.slice(0),this.boneInverses=e,this.boneMatrices=new Float32Array(16*this.bones.length),this.boneTexture=void 0}var e=t.prototype;return e.pose=function(){for(var t=this.boneInverses,e=0;e<this.bones.length;e++){this.bones[e].worldMatrix.getInverse(t[e])}for(var n=0;n<this.bones.length;n++){var i=this.bones[n];i.parent&&"bone"==i.parent.type?(i.matrix.getInverse(i.parent.worldMatrix),i.matrix.multiply(i.worldMatrix)):i.matrix.copy(i.worldMatrix),i.matrix.decompose(i.position,i.quaternion,i.scale)}},e.clone=function(){return new t(this.bones,this.boneInverses)},e.updateBones=function(t){for(var e=t.useAnchorMatrix,n=t.anchorMatrixInverse,i=this.boneInverses,r=0;r<this.bones.length;r++){var a=this.bones[r];Rr.multiplyMatrices(a.worldMatrix,i[r]),e&&Rr.premultiply(n),Rr.toArray(this.boneMatrices,16*r)}void 0!==this.boneTexture&&this.boneTexture.version++},e.generateBoneTexture=function(){var t=Math.sqrt(4*this.bones.length);t=$t(Math.ceil(t)),t=Math.max(4,t);var e=new Float32Array(t*t*4);e.set(this.boneMatrices);var n=new On;n.image={data:e,width:t,height:t},n.format=O.RGBA,n.type=F.FLOAT,n.magFilter=I.NEAREST,n.minFilter=I.NEAREST,n.generateMipmaps=!1,n.flipY=!1,this.boneMatrices=e,this.boneTexture=n},t}(),Pr=function(t){function e(e,n){var i;return void 0===e&&(e=16777215),void 0===n&&(n=1),(i=t.call(this)||this).color=new gt(e),i.intensity=n,i}i(e,t);var n=e.prototype;return n.lookAt=function(t,e){Lr.lookAtRH(this.position,t,e),this.quaternion.setFromRotationMatrix(Lr)},n.copy=function(e){return t.prototype.copy.call(this,e),this.color.copy(e.color),this.intensity=e.intensity,this},e}(re);Pr.prototype.isLight=!0;var Lr=new m,Cr=function(t){function e(e,n){return t.call(this,e,n)||this}return i(e,t),e}(Pr);Cr.prototype.isAmbientLight=!0;var Dr=function(){function t(){this.camera=new De,this.matrix=new m,this.bias=0,this.normalBias=0,this.radius=1,this.cameraNear=1,this.cameraFar=500,this.mapSize=new pt(512,512),this.autoUpdate=!0,this.needsUpdate=!1,this.renderTarget=null,this.map=null,this.depthMap=null}var e=t.prototype;return e.update=function(t,e){},e.updateMatrix=function(){var t=this.matrix,e=this.camera;t.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),t.multiply(e.projectionMatrix),t.multiply(e.viewMatrix)},e.copy=function(t){return this.camera.copy(t.camera),this.matrix.copy(t.matrix),this.bias=t.bias,this.normalBias=t.normalBias,this.radius=t.radius,this.cameraNear=t.cameraNear,this.cameraFar=t.cameraFar,this.mapSize.copy(t.mapSize),this},e.clone=function(){return(new this.constructor).copy(this)},e.prepareDepthMap=function(t,e){},t}(),Or=function(t){function e(){var e;(e=t.call(this)||this).windowSize=500,e.frustumEdgeFalloff=0,e.camera.frustumCulled=!1,e.renderTarget=new yr(e.mapSize.x,e.mapSize.y);var n=e.renderTarget.texture;n.generateMipmaps=!1,n.minFilter=I.LINEAR;var i=new On;i.type=F.UNSIGNED_INT,i.format=O.DEPTH_COMPONENT,i.magFilter=I.LINEAR,i.minFilter=I.LINEAR,i.compare=B.LESS,i.generateMipmaps=!1;var r=new Tr(e.mapSize.x,e.mapSize.y,O.DEPTH_COMPONENT16);return e.renderTarget.detach(W.DEPTH_STENCIL_ATTACHMENT),e.renderTarget.attach(r,W.DEPTH_ATTACHMENT),e.map=n,e.depthMap=i,e._depthBuffer=r,e._lookTarget=new _,e._up=new _(0,1,0),e}i(e,t);var n=e.prototype;return n.update=function(t){this._updateCamera(t),this.mapSize.x===this.renderTarget.width&&this.mapSize.y===this.renderTarget.height||this.renderTarget.resize(this.mapSize.x,this.mapSize.y)},n._updateCamera=function(t){var e=this.camera,n=this._lookTarget;t.getWorldDirection(n),e.position.setFromMatrixPosition(t.worldMatrix),n.multiplyScalar(-1).add(e.position),e.lookAt(n,this._up),e.updateMatrix();var i=this.windowSize/2;e.setOrtho(-i,i,-i,i,this.cameraNear,this.cameraFar)},n.copy=function(e){return t.prototype.copy.call(this,e),this.windowSize=e.windowSize,this.frustumEdgeFalloff=e.frustumEdgeFalloff,this},n.prepareDepthMap=function(t,e){var n=t&&e.version>=2,i=this.renderTarget;n!==(i._attachments[W.DEPTH_ATTACHMENT]===this.depthMap)&&(n?(e.getExtension("OES_texture_float_linear")&&(this.depthMap.type=F.FLOAT),i.dispose(),i.attach(this.depthMap,W.DEPTH_ATTACHMENT)):(i.dispose(),i.attach(this._depthBuffer,W.DEPTH_ATTACHMENT)))},e}(Dr),Fr=function(t){function e(e,n){var i;return(i=t.call(this,e,n)||this).shadow=new Or,i}return i(e,t),e.prototype.copy=function(e){return t.prototype.copy.call(this,e),this.shadow.copy(e.shadow),this},e}(Pr);Fr.prototype.isDirectionalLight=!0;var Ir=function(t){function e(e,n,i){var r;return(r=t.call(this,e,i)||this).groundColor=new gt(void 0!==n?n:16777215),r}return i(e,t),e.prototype.copy=function(e){t.prototype.copy.call(this,e),this.groundColor.copy(e.groundColor)},e}(Pr);Ir.prototype.isHemisphereLight=!0;var Ur=function(t){function e(){var e;(e=t.call(this)||this).renderTarget=new wr(e.mapSize.x,e.mapSize.y);var n=e.renderTarget.texture;return n.generateMipmaps=!1,n.minFilter=I.LINEAR,e.map=n,e._targets=[new _(1,0,0),new _(-1,0,0),new _(0,1,0),new _(0,-1,0),new _(0,0,1),new _(0,0,-1)],e._ups=[new _(0,-1,0),new _(0,-1,0),new _(0,0,1),new _(0,0,-1),new _(0,-1,0),new _(0,-1,0)],e._lookTarget=new _,e}i(e,t);var n=e.prototype;return n.update=function(t,e){this._updateCamera(t,e),this.mapSize.x===this.renderTarget.width&&this.mapSize.y===this.renderTarget.height||this.renderTarget.resize(this.mapSize.x,this.mapSize.y)},n._updateCamera=function(t,e){var n=this.camera,i=this._lookTarget,r=this._targets,a=this._ups;n.position.setFromMatrixPosition(t.worldMatrix),i.set(r[e].x+n.position.x,r[e].y+n.position.y,r[e].z+n.position.z),n.lookAt(i,a[e]),n.updateMatrix(),n.setPerspective(.5*Math.PI,1,this.cameraNear,this.cameraFar)},e}(Dr),Br=function(t){function e(e,n,i,r){var a;return(a=t.call(this,e,n)||this).decay=void 0!==r?r:1,a.distance=void 0!==i?i:200,a.shadow=new Ur,a}return i(e,t),e.prototype.copy=function(e){return t.prototype.copy.call(this,e),this.shadow.copy(e.shadow),this},e}(Pr);Br.prototype.isPointLight=!0;var Gr=function(t){function e(){var e;(e=t.call(this)||this).frustumEdgeFalloff=0,e.renderTarget=new yr(e.mapSize.x,e.mapSize.y);var n=e.renderTarget.texture;n.generateMipmaps=!1,n.minFilter=I.LINEAR;var i=new On;i.type=F.UNSIGNED_INT,i.format=O.DEPTH_COMPONENT,i.magFilter=I.LINEAR,i.minFilter=I.LINEAR,i.compare=B.LESS,i.generateMipmaps=!1;var r=new Tr(e.mapSize.x,e.mapSize.y,O.DEPTH_COMPONENT16);return e.renderTarget.detach(W.DEPTH_STENCIL_ATTACHMENT),e.renderTarget.attach(r,W.DEPTH_ATTACHMENT),e.map=n,e.depthMap=i,e._depthBuffer=r,e._lookTarget=new _,e._up=new _(0,1,0),e}i(e,t);var n=e.prototype;return n.update=function(t){this._updateCamera(t),this.mapSize.x===this.renderTarget.width&&this.mapSize.y===this.renderTarget.height||this.renderTarget.resize(this.mapSize.x,this.mapSize.y)},n._updateCamera=function(t){var e=this.camera,n=this._lookTarget;t.getWorldDirection(n),e.position.setFromMatrixPosition(t.worldMatrix),n.multiplyScalar(-1).add(e.position),e.lookAt(n,this._up),e.updateMatrix(),e.setPerspective(2*t.angle,1,this.cameraNear,this.cameraFar)},n.copy=function(e){return t.prototype.copy.call(this,e),this.frustumEdgeFalloff=e.frustumEdgeFalloff,this},n.prepareDepthMap=function(t,e){var n=t&&e.version>=2,i=this.renderTarget;n!==(i._attachments[W.DEPTH_ATTACHMENT]===this.depthMap)&&(n?(e.getExtension("OES_texture_float_linear")&&(this.depthMap.type=F.FLOAT),i.dispose(),i.attach(this.depthMap,W.DEPTH_ATTACHMENT)):(i.dispose(),i.attach(this._depthBuffer,W.DEPTH_ATTACHMENT)))},e}(Dr),zr=function(t){function e(e,n,i,r,a,o){var s;return(s=t.call(this,e,n)||this).decay=void 0!==o?o:1,s.distance=void 0!==i?i:200,s.penumbra=void 0!==a?a:0,s.angle=void 0!==r?r:Math.PI/6,s.shadow=new Gr,s}return i(e,t),e.prototype.copy=function(e){return t.prototype.copy.call(this,e),this.shadow.copy(e.shadow),this},e}(Pr);zr.prototype.isSpotLight=!0;var Hr=function(t){function e(){return t.call(this)||this}return i(e,t),e}(re);Hr.prototype.isBone=!0;var Vr=function(t){function e(e,n){var i;return(i=t.call(this,e,n)||this).skeleton=void 0,i.bindMode="attached",i.bindMatrix=new m,i.bindMatrixInverse=new m,i}i(e,t);var n=e.prototype;return n.bind=function(t,e){this.skeleton=t,void 0===e&&(this.updateMatrix(),e=this.worldMatrix),this.bindMatrix.copy(e),this.bindMatrixInverse.getInverse(e)},n.updateMatrix=function(e){t.prototype.updateMatrix.call(this,e),"attached"===this.bindMode?this.bindMatrixInverse.getInverse(this.worldMatrix):"detached"===this.bindMode?this.bindMatrixInverse.getInverse(this.bindMatrix):console.warn("t3d.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)},n.copy=function(e){return t.prototype.copy.call(this,e),this.bindMode=e.bindMode,this.bindMatrix.copy(e.bindMatrix),this.bindMatrixInverse.copy(e.bindMatrixInverse),this.skeleton=e.skeleton,this},e}(an);Vr.prototype.isSkinnedMesh=!0;var kr=function(t){function e(){return t.call(this)||this}return i(e,t),e}(re);kr.prototype.isGroup=!0;_.prototype.applyProjection=function(t){console.error("t3d.Vector3: .applyProjection has been removed. Use .applyMatrix4 instead.")},Object.defineProperties(De.prototype,{gammaInput:{get:function(){return console.warn("t3d.Camera: .gammaInput has been removed. Use texture.encoding instead."),!1},set:function(t){console.warn("t3d.Camera: .gammaInput has been removed. Use texture.encoding instead.")}},gammaOutput:{get:function(){return console.warn("t3d.Camera: .gammaOutput has been removed. Use .outputEncoding or renderTarget.texture.encoding instead."),this.outputEncoding==H.GAMMA},set:function(t){console.warn("t3d.Camera: .gammaOutput has been removed. Use .outputEncoding or renderTarget.texture.encoding instead."),this.outputEncoding=t?H.GAMMA:H.LINEAR}}}),Object.defineProperties(Sn.prototype,{emissiveIntensity:{get:function(){return console.warn("t3d.Material: .emissiveIntensity has been removed. Use material.emissive instead."),!1},set:function(t){console.warn("t3d.Material: .emissiveIntensity has been removed. Use material.emissive instead.")}}}),Object.defineProperties(ar.prototype,{textures:{get:function(){return console.warn("WebGLRenderPass: .textures has been deprecated. All methods are moved to WebGLRenderPass."),this._textures}},renderBuffers:{get:function(){return console.warn("WebGLRenderPass: .renderBuffers has been deprecated. All methods are moved to WebGLRenderPass."),this._renderBuffers}},renderTarget:{get:function(){return this._renderTargets}},state:{get:function(){return this._state}},vertexArrayBindings:{get:function(){return console.warn("WebGLRenderPass: .vertexArrayBindings has been deprecated. All methods are moved to WebGLRenderPass."),this._vertexArrayBindings}}}),Yi.prototype.resetBinding=function(){console.error("WebGLVertexArrayBindings: .resetBinding() has been removed. Use WebGLRenderPass.resetVertexArrayBindings() instead.")},Wi.prototype.setBufferExternal=function(t,e){console.warn("WebGLGeometries: .setBufferExternal has been removed. Use WebGLRenderPass.setBufferExternal instead."),this._buffers.setBufferExternal(t,e)};var Xr={TEXTURE_2D:3553,TEXTURE_CUBE_MAP:34067,TEXTURE_3D:32879};Object.defineProperties(Dn.prototype,{textureType:{get:function(){return console.warn("TextureBase: .textureType has been removed."),""},set:function(t){console.warn("TextureBase: .textureType has been removed.")}}}),Object.defineProperties(On,{textureType:{get:function(){return console.warn("Texture2D: .textureType has been removed."),Xr.TEXTURE_2D},set:function(t){console.warn("Texture2D: .textureType has been removed.")}}}),Object.defineProperties(In,{textureType:{get:function(){return console.warn("Texture3D: .textureType has been removed."),Xr.TEXTURE_3D},set:function(t){console.warn("Texture3D: .textureType has been removed.")}}}),Object.defineProperties(Fn,{textureType:{get:function(){return console.warn("TextureCube: .textureType has been removed."),Xr.TEXTURE_CUBE_MAP},set:function(t){console.warn("TextureCube: .textureType has been removed.")}}});var Wr={AMBIENT:"ambient",HEMISPHERE:"hemisphere",DIRECT:"direct",POINT:"point",SPOT:"spot"};Object.defineProperties(Pr.prototype,{lightType:{get:function(){return console.warn("Light: .lightType has been removed."),""},set:function(t){console.warn("Light: .lightType has been removed.")}}}),Object.defineProperties(Cr.prototype,{lightType:{get:function(){return console.warn("AmbientLight: .lightType has been removed."),Wr.AMBIENT},set:function(t){console.warn("AmbientLight: .lightType has been removed.")}}}),Object.defineProperties(Fr.prototype,{lightType:{get:function(){return console.warn("DirectionalLight: .lightType has been removed."),Wr.DIRECT},set:function(t){console.warn("DirectionalLight: .lightType has been removed.")}}}),Object.defineProperties(Ir.prototype,{lightType:{get:function(){return console.warn("HemisphereLight: .lightType has been removed."),Wr.HEMISPHERE},set:function(t){console.warn("HemisphereLight: .lightType has been removed.")}}}),Object.defineProperties(Br.prototype,{lightType:{get:function(){return console.warn("PointLight: .lightType has been removed."),Wr.POINT},set:function(t){console.warn("PointLight: .lightType has been removed.")}}}),Object.defineProperties(zr.prototype,{lightType:{get:function(){return console.warn("SpotLight: .lightType has been removed."),Wr.SPOT},set:function(t){console.warn("SpotLight: .lightType has been removed.")}}});var jr={MESH:"mesh",SKINNED_MESH:"skinned_mesh",LIGHT:"light",CAMERA:"camera",SCENE:"scene",GROUP:"group"};Object.defineProperties(an.prototype,{type:{get:function(){return console.warn("Mesh: .type has been removed, use .isMesh instead."),jr.MESH},set:function(t){console.warn("Mesh: .type has been removed.")}}}),Object.defineProperties(Vr.prototype,{type:{get:function(){return console.warn("SkinnedMesh: .type has been removed, use .isSkinnedMesh instead."),jr.SKINNED_MESH},set:function(t){console.warn("SkinnedMesh: .type has been removed.")}}}),Object.defineProperties(Pr.prototype,{type:{get:function(){return console.warn("Light: .type has been removed, use .isLight instead."),jr.LIGHT},set:function(t){console.warn("Light: .type has been removed.")}}}),Object.defineProperties(De.prototype,{type:{get:function(){return console.warn("Camera: .type has been removed, use .isCamera instead."),jr.CAMERA},set:function(t){console.warn("Camera: .type has been removed.")}}}),Object.defineProperties(Ce.prototype,{type:{get:function(){return console.warn("Scene: .type has been removed, use .isScene instead."),jr.SCENE},set:function(t){console.warn("Scene: .type has been removed.")}}}),Object.defineProperties(kr.prototype,{type:{get:function(){return console.warn("Group: .type has been removed, use .isGroup instead."),jr.GROUP},set:function(t){console.warn("Group: .type has been removed.")}}});var Yr={NORMAL:"normal",EXP2:"exp2"};Object.defineProperties(sr.prototype,{fogType:{get:function(){return console.warn("Fog: .fogType has been removed, use .isFog instead."),Yr.NORMAL},set:function(t){console.warn("Fog: .fogType has been removed.")}}}),Object.defineProperties(ur.prototype,{fogType:{get:function(){return console.warn("FogExp2: .fogType has been removed, use .isFogExp2 instead."),Yr.EXP2},set:function(t){console.warn("FogExp2: .fogType has been removed.")}}}),On.fromImage=function(t){console.warn("Texture2D.fromImage has been removed.");var e=new On;return e.image=t,e.version++,e},On.fromSrc=function(t){console.warn("Texture2D.fromSrc has been removed, use Texture2DLoader(jsm) instead.");var e=new On;return(new ft).load(t,(function(t){e.image=t,e.version++,e.dispatchEvent({type:"onload"})})),e},Fn.fromImage=function(t){console.warn("TextureCube.fromImage has been removed.");for(var e=new Fn,n=e.images,i=0;i<6;i++)n[i]=t[i];return e.version++,e},Fn.fromSrc=function(t){console.warn("TextureCube.fromSrc has been removed, use TextureCubeLoader(jsm) instead.");var e=new Fn,n=e.images,i=new ft,r=0;return function a(o){if(o&&(n.push(o),r++),r>=6)return e.version++,void e.dispatchEvent({type:"onload"});i.load(t[r],a)}(),e},t.ATTACHMENT=W,t.AmbientLight=Cr,t.AnimationAction=Q,t.AnimationMixer=ot,t.Attribute=ln,t.BLEND_EQUATION=N,t.BLEND_FACTOR=P,t.BLEND_TYPE=R,t.BUFFER_USAGE=j,t.BasicMaterial=fr,t.Bone=Hr,t.BooleanKeyframeTrack=d,t.Box2=_t,t.Box3=mt,t.BoxGeometry=lr,t.Buffer=cn,t.COMPARE_FUNC=B,t.CULL_FACE_TYPE=L,t.Camera=De,t.Color3=gt,t.ColorKeyframeTrack=f,t.CubeGeometry=lr,t.CylinderGeometry=cr,t.DRAW_MODE=k,t.DRAW_SIDE=C,t.DefaultLoadingManager=lt,t.DepthMaterial=yn,t.DirectionalLight=Fr,t.DirectionalLightShadow=Or,t.DistanceMaterial=xn,t.ENVMAP_COMBINE_TYPE=V,t.EnvironmentMapPass=function(){console.error("EnvironmentMapPass has been removed, use ReflectionProbe(jsm) instead.")},t.Euler=xt,t.EventDispatcher=q,t.FOG_TYPE=Yr,t.FileLoader=ht,t.Fog=sr,t.FogExp2=ur,t.Frustum=Lt,t.Geometry=mn,t.Group=kr,t.HemisphereLight=Ir,t.ImageLoader=ft,t.KeyframeClip=st,t.KeyframeTrack=h,t.LIGHT_TYPE=Wr,t.LambertMaterial=pr,t.Light=Pr,t.LightData=ce,t.LightShadow=Dr,t.LineMaterial=_r,t.Loader=ct,t.LoadingManager=ut,t.MATERIAL_TYPE=b,t.MatcapMaterial=vr,t.Material=Sn,t.Matrix3=At,t.Matrix4=m,t.Mesh=an,t.NumberKeyframeTrack=p,t.OBJECT_TYPE=jr,t.OPERATION=G,t.Object3D=re,t.PBR2Material=mr,t.PBRMaterial=gr,t.PIXEL_FORMAT=O,t.PIXEL_TYPE=F,t.PhongMaterial=Er,t.Plane=Nt,t.PlaneGeometry=gn,t.PointLight=Br,t.PointLightShadow=Ur,t.PointsMaterial=Sr,t.PropertyBindingMixer=Z,t.QUERY_TYPE=Y,t.Quaternion=y,t.QuaternionKeyframeTrack=x,t.Query=br,t.Ray=Ut,t.RenderBuffer=Tr,t.RenderInfo=function(){var t={calls:0,triangles:0,lines:0,points:0},e=[function(e,n){t.points+=e*n},function(e,n){t.lines+=e*(n/2)},function(e,n){t.lines+=e*n},function(e,n){t.lines+=e*(n-1)},function(e,n){t.triangles+=e*(n/3)},function(e,n){t.triangles+=e*(n-2)},function(e,n){t.triangles+=e*(n-2)}];this.update=function(n,i,r){t.calls++,e[i](r,n)},this.reset=function(){t.calls=0,t.triangles=0,t.lines=0,t.points=0},this.render=t},t.RenderQueue=ye,t.RenderQueueLayer=ge,t.RenderStates=Le,t.RenderTarget2D=yr,t.RenderTargetBack=xr,t.RenderTargetBase=Mr,t.RenderTargetCube=wr,t.Renderer=or,t.SHADING_TYPE=D,t.SHADOW_TYPE=z,t.Scene=Ce,t.SceneData=Ne,t.ShaderChunk=oi,t.ShaderLib=ui,t.ShaderMaterial=Mn,t.ShaderPostPass=Tn,t.ShadowMapPass=wn,t.Skeleton=Nr,t.SkinnedMesh=Vr,t.Sphere=zt,t.SphereGeometry=hr,t.Spherical=Ht,t.SpotLight=zr,t.SpotLightShadow=Gr,t.StringKeyframeTrack=w,t.TEXEL_ENCODING_TYPE=H,t.TEXTURE_FILTER=I,t.TEXTURE_WRAP=U,t.Texture2D=On,t.Texture3D=In,t.TextureBase=Dn,t.TextureCube=Fn,t.TorusKnotGeometry=dr,t.Triangle=jt,t.VERTEX_COLOR=X,t.Vector2=pt,t.Vector3=_,t.Vector4=Yt,t.VectorKeyframeTrack=A,t.WEBGL_COMPARE_FUNC=B,t.WEBGL_OP=G,t.WEBGL_PIXEL_FORMAT=O,t.WEBGL_PIXEL_TYPE=F,t.WEBGL_TEXTURE_FILTER=I,t.WEBGL_TEXTURE_TYPE=Xr,t.WEBGL_TEXTURE_WRAP=U,t.WebGLAttribute=ei,t.WebGLCapabilities=Mi,t.WebGLGeometries=Wi,t.WebGLProgram=ii,t.WebGLPrograms=li,t.WebGLProperties=Ni,t.WebGLQueries=qi,t.WebGLRenderBuffers=Gi,t.WebGLRenderPass=ar,t.WebGLState=Ri,t.WebGLTextures=Pi,t.WebGLUniforms=ti,t.cloneJson=ee,t.cloneUniforms=te,t.generateUUID=Zt,t.isPowerOfTwo=Kt,t.nearestPowerOfTwo=Jt,t.nextPowerOfTwo=$t}));
