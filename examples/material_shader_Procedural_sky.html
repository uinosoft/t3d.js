<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>t3d - ProceduralSkybox</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link type="text/css" rel="stylesheet" href="main.css">
</head>

<body>
    <div id="info">
        <a href="" target="_blank">t3d</a> - skybox
    </div>

    <!-- Import maps polyfill -->
    <!-- Remove this when import maps will be widely supported -->
    <script async src="./libs/es-module-shims.js"></script>

    <script type="importmap">
        {
            "imports": {
                "t3d": "../build/t3d.module.js",
                "t3d/addons/": "./jsm/"
            }
        }
    </script>

    <script type="module">
        import * as t3d from 't3d';
        import { GUI } from './libs/lil-gui.esm.min.js';
        import { OrbitControls } from 't3d/addons/controls/OrbitControls.js';
        import { PMREMGenerator } from 't3d/addons/textures/PMREMGenerator.js';
        import { Texture2DLoader } from 't3d/addons/loaders/Texture2DLoader.js';
        import { ForwardRenderer } from 't3d/addons/render/ForwardRenderer.js';
        import { ProceduralSky } from 't3d/addons/objects/ProceduralSky.js';

        let width = window.innerWidth || 2;
        let height = window.innerHeight || 2;

        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        document.body.appendChild(canvas);

        const forwardRenderer = new ForwardRenderer(canvas);

        const scene = new t3d.Scene();

        const camera = new t3d.Camera();
        camera.setPerspective(40 / 180 * Math.PI, width / height, 1, 1000);
        camera.position.set(-10, 0, 0);
        scene.add(camera);

        const sky = new ProceduralSky();
        scene.add(sky);

        const controller = new OrbitControls(camera, canvas);
        const loader = new Texture2DLoader();
        loader.load('./resources/sky/MoonColorMap.jpg', texture => {
        	const diff_tex = (new PMREMGenerator()).prefilter(forwardRenderer, texture);
        	sky.material.uniforms.MoonTex = diff_tex;
        });

        const sunViewGradTex = loader.load('./resources/sky/SunView_Gradient.png');
        sky.material.uniforms.SunViewGradTex = sunViewGradTex;
        const sunZenithGradTex = loader.load('./resources/sky/SunZenith_Gradient.png');
        sky.material.uniforms.SunZenithGradTex = sunZenithGradTex;
        const viewZenithGradTex = loader.load('./resources/sky/ViewZenith_Gradient.png');
        sky.material.uniforms.ViewZenithGradTex = viewZenithGradTex;

        const spherical = new t3d.Spherical(50, Math.PI / 2, Math.PI / 4);
        const vector3 = new t3d.Vector3();

        function setSunAndMoonDir() {
        	vector3.setFromSpherical(spherical);
        	vector3.normalize();
        
        	vector3.toArray(sky.material.uniforms['MoonDirSize']);
        	console.log(sky.material.uniforms['MoonDirSize']);

        	vector3.multiplyScalar(-1);
        	vector3.toArray(sky.material.uniforms['SunDirSize']);
        }
        const gui = new GUI();
        gui.add(spherical, 'phi', 0, Math.PI).onChange(setSunAndMoonDir);
        gui.add(spherical, 'theta', 0, Math.PI * 2).onChange(setSunAndMoonDir);
        setSunAndMoonDir();
        function loop(count) {
        	requestAnimationFrame(loop);

        	controller.update();

        	forwardRenderer.setClearColor(0, 0, 0, 0);
        	forwardRenderer.clear(true, true, true);
        
        	forwardRenderer.render(scene, camera);
        }

        requestAnimationFrame(loop);

        function onWindowResize() {
        	width = window.innerWidth || 2;
        	height = window.innerHeight || 2;

        	camera.setPerspective(60 / 180 * Math.PI, width / height, 1, 1000);

        	forwardRenderer.backRenderTarget.resize(width, height);
        }
        window.addEventListener('resize', onWindowResize, false);
    </script>
</body>

</html>